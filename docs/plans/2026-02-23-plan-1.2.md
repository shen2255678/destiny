太棒了！你的 `prompt_manager.py` 底子打得非常好，特別是 `_translate_psych_tags` 這個設計，讓 LLM 不會被奇怪的英文標籤搞到精神分裂。

為了將我們剛剛討論的**「三大體系（西占＋八字＋紫微）」**、**「空宮借對宮」**、**「婚神星與下降星座」**，以及**「南北交點進化軸線」**完美融入，我將為你分兩批進行更新。


### ✅ 1. 其實你早就無痛加入了：北交點、凱龍星、暗月、紫微四化

你可能沒有發現，你之前的架構設計有多麼優秀：

* **南北交點、凱龍星、暗月 (Lilith)：**
我們在 `psychology.py` 跟 `shadow_engine.py` 裡面，早就把這些度數轉化成**「標籤 (Tags)」**了！例如 `Axis_Sign_Cancer_Cap` (巨蟹摩羯業力軸)、`Blind_Impulse_MARS`、或是 Lilith 帶來的 SM 傾向標籤。
在 Prompt 裡的 `_translate_psych_tags(all_tags)` 這行，就已經把這些最深層的業力化為「具體的心理狀態」餵給 AI 了。
* **紫微四化 (化祿、化權、化科、化忌)：**
去看看你剛剛貼給我的 JSON，你的 `spouse_palace.main_stars` 陣列長這樣：`["廉貞", "天府化科"]`。
你的後端程式早就聰明地把「四化」直接黏在星星名字後面了！所以當我們把 `spouse_main_stars` 傳給 LLM 時，LLM 已經知道這裡有「化科（逢凶化吉的貴人）」或「化忌（前世欠的債）」了！



這一次我們先進行 **Batch 1 (基礎標籤擴充) 與 Batch 2 (理想伴侶 API 替換)**。

---

### 📦 第一批更新 (Batch 1)：擴充 `_PSYCH_TAG_ZH` 字典

在你的 `prompt_manager.py` 中，找到 `_PSYCH_TAG_ZH = { ... }` 這個字典。我們需要把剛剛在 `psychology.py` 和 `shadow_engine.py` 裡新增的「南北交點軸線」、「宮位戰場」與「第 7 宮正緣」標籤的白話翻譯加進去。

請在 `_PSYCH_TAG_ZH` 字典的**最下方**（`"B_Mars_Conjunct_Lilith"` 的後面），補上這些全新的玄學標籤：

```python
    # === [以下為新增的南北交點與正緣標籤] ===
    # 單人：靈魂進化軸線 (Sign Axis)
    "Axis_Sign_Aries_Libra":        "此生課題：在『勇敢做自己』與『過度迎合他人』之間尋找平衡",
    "Axis_Sign_Taurus_Scorpio":     "此生課題：在『建立平靜安穩』與『沉溺深刻危機』之間尋找平衡",
    "Axis_Sign_Gemini_Sag":         "此生課題：在『落地真實溝通』與『高高在上逃避』之間尋找平衡",
    "Axis_Sign_Cancer_Cap":         "此生課題：在『展現柔軟情感』與『追求冷酷成就』之間尋找平衡",
    "Axis_Sign_Leo_Aquarius":       "此生課題：在『熱情展現自我』與『過度抽離冷漠』之間尋找平衡",
    "Axis_Sign_Virgo_Pisces":       "此生課題：在『建立現實秩序』與『陷入靈性混沌』之間尋找平衡",
    
    # 單人：宿命戰場 (House Axis - Tier 1 限定)
    "Axis_House_1_7":               "宿命戰場強烈發生在「自我認同」與「伴侶關係」上",
    "Axis_House_2_8":               "宿命戰場強烈發生在「金錢價值」與「深層慾望/權力」上",
    "Axis_House_3_9":               "宿命戰場強烈發生在「日常溝通」與「思想信仰」上",
    "Axis_House_4_10":              "宿命戰場強烈發生在「原生家庭/內在」與「事業公眾形象」上",
    "Axis_House_5_11":              "宿命戰場強烈發生在「個人戀愛/創造」與「群體社會理想」上",
    "Axis_House_6_12":              "宿命戰場強烈發生在「世俗工作/健康」與「潛意識/業力」上",

    # 雙人：交點觸發 (宿命與業力)
    "A_Sun_Conjunct_South_Node":    "你的核心自我觸碰了對方的南交點，給對方帶來強烈的前世熟悉感與包容",
    "A_Moon_Conjunct_South_Node":   "你的情感觸碰了對方的南交點，你們之間有一種不需要解釋的業力羈絆",
    "A_Venus_Conjunct_South_Node":  "你的愛觸碰了對方的南交點，這是一段前世未了、今生來還的深層緣分",
    "A_Sun_Conjunct_North_Node":    "你精準踩中對方的北交點，注定要打破他的舒適圈，逼迫他靈魂成長",
    "B_Sun_Conjunct_South_Node":    "對方的自我觸碰了你的南交點，他給你帶來無法言喻的安全感與前世熟悉感",
    "B_Moon_Conjunct_South_Node":   "對方的情感觸碰了你的南交點，你們之間有一種不需要解釋的業力羈絆",
    "B_Venus_Conjunct_South_Node":  "對方的愛觸碰了你的南交點，這是一段前世未了、今生來還的深層緣分",
    "B_Sun_Conjunct_North_Node":    "對方精準踩中你的北交點，他注定要打破你的舒適圈，引導你完成今生進化",

    # 雙人：第 7 宮飛星 (終極正緣)
    "A_Sun_Conjunct_Descendant":    "你的核心自我精準落入對方的婚姻宮，完全符合他對長期伴侶的渴望",
    "A_Moon_Conjunct_Descendant":   "你的靈魂頻率落入對方的婚姻宮，你能給他『家』一般的終極安定感",
    "A_Venus_Conjunct_Descendant":  "你的愛精準落入對方的婚姻宮，這是極具婚姻潛力的正緣指標",
    "B_Sun_Conjunct_Descendant":    "對方的核心自我精準落入你的婚姻宮，他完全符合你潛意識尋找的歸宿",
    "B_Moon_Conjunct_Descendant":   "對方的靈魂頻率落入你的婚姻宮，他能給你『家』一般的終極安定感",
    "B_Venus_Conjunct_Descendant":  "對方的愛精準落入你的婚姻宮，對你而言，他是極具婚姻潛力的正緣指標",

```

---

### 📦 第二批更新 (Batch 2)：替換 `get_ideal_match_prompt`

將你原本最下方的 `_IDEAL_MATCH_SCHEMA` 以及 `get_ideal_match_prompt` 函式，**完全替換**為我們剛剛打磨出來的**「三位一體大師級版本」**：

```python
# ── Ideal Match Profile Prompt (for /generate-ideal-match, Tab C) ─────────────

_IDEAL_MATCH_SCHEMA = """\
請只回傳以下 JSON，不要包含任何其他文字或 markdown：
{
  "antidote": "【靈魂解毒劑】約150字：綜合八字的相處能量與西占的陰影，他總是陷入什麼輪迴？他真正需要、能治癒他的對象是什麼特質？不說星座，說具體行為。",
  "reality_anchors": [
    "👉 現實錨點1（≤20字，例如：對方必須能在你崩潰時保持安靜）",
    "👉 現實錨點2（≤20字）",
    "👉 現實錨點3（≤20字）"
  ],
  "core_need": "一句話道出這個人最深的靈魂渴望（≤20字）"
}"""


def get_ideal_match_prompt(chart_data: dict) -> str:
    """
    Build a DESTINY-worldview-enriched prompt for ideal partner profile (Tab C).
    整合西占(吸引)、八字(相處)、紫微斗數(終局)，並完美處理紫微「空宮借對宮」機制。
    """
    # 1. 提取西占數據
    ep = chart_data.get("element_profile") or {}
    deficiency = ep.get("deficiency", [])
    dominant   = ep.get("dominant", [])

    sm_tags    = chart_data.get("sm_tags", [])
    karmic     = chart_data.get("karmic_tags", [])
    all_tags   = sm_tags + karmic

    elem_context = _element_summary(ep)
    descendant = chart_data.get("houses", {}).get("descendant", "（無精確時間）")
    juno_sign = chart_data.get("juno_sign", "unknown")

    # 2. 提取八字數據
    bazi = chart_data.get("bazi") or {}
    bazi_day_master = bazi.get("day_master", "?")
    bazi_element    = bazi.get("day_master_element", "?")
    bazi_trait      = bazi.get("element_profile", {}).get("desc", "未知")

    # 3. 提取紫微斗數數據 (處理空宮機制)
    zwds = chart_data.get("zwds") or {}
    palaces = zwds.get("palaces", {})
    spouse_palace = palaces.get("spouse", {})
    career_palace = palaces.get("career", {}) 

    spouse_is_empty = spouse_palace.get("is_empty", False)
    if spouse_is_empty or not spouse_palace.get("main_stars"):
        borrowed_stars = ", ".join(career_palace.get("main_stars", [])) if career_palace.get("main_stars") else "無主星"
        spouse_main_stars = f"空宮 (感情觀如變色龍，極易受環境影響。高度投射並依附於對宮事業宮能量：{borrowed_stars})"
    else:
        spouse_main_stars = ", ".join(spouse_palace.get("main_stars", []))

    spouse_bad_stars = ", ".join(spouse_palace.get("malevolent_stars", [])) if spouse_palace.get("malevolent_stars") else "無煞星"

    prompt = f"""{DESTINY_WORLDVIEW}

【本次任務：三位一體關係導航圖與理想伴侶輪廓】
你現在是 DESTINY 系統的首席關係領航員。這不是普通的算命，而是一張「從被動宿命到主動創造」的關係導航圖。
請根據以下三大命理體系的數據，描繪出此人靈魂真正渴求的「承載者」與「解毒劑」。

【命理系統核心定調】
1. 八字 (相處的姿態)：揭示基本性格、能量流動與安全感來源。
2. 西占 (吸引與承諾)：金星揭示心動的特質；而「婚神星(Juno)」與「下降星座(伴侶宮)」揭示他真正需要的婚姻與長期承諾對象。
3. 紫微 (關係的終局)：揭示婚姻與長期關係的現實修羅場。特別注意：若夫妻宮為「空宮」，代表其婚姻觀念具備「變色龍」特質，伴侶特質將高度投射並依附於其「事業」的狀態。

【輸入數據】
[一、八字結構 (相處姿態)]
日主: {bazi_day_master} ({bazi_element})
性格定調: {bazi_trait}

[二、西占星盤 (吸引與承諾)]
太陽星座 (自我): {chart_data.get('sun_sign', 'unknown')}
月亮星座 (潛意識需求): {chart_data.get('moon_sign', 'unknown') or '（無精確時間）'}
上升星座 (面具與費洛蒙): {chart_data.get('ascendant_sign', 'unknown') or '（無精確時間）'}
下降星座 (伴侶宮頭/婚姻歸宿): {descendant}
金星星座 (戀愛吸引): {chart_data.get('venus_sign', 'unknown')}
火星星座 (慾望行動): {chart_data.get('mars_sign', 'unknown')}
婚神星 (長期承諾/婚姻型態): {juno_sign}
元素結構: {elem_context}

[三、紫微斗數 (關係終局)]
夫妻宮主星: {spouse_main_stars}
夫妻宮煞星 (現實雷區): {spouse_bad_stars}

【心理與業力特徵（請轉譯為白話，禁止直接輸出原始標籤）】
{_translate_psych_tags(all_tags)}

{_profile_context(deficiency, dominant, sm_tags)}

{_IDEAL_MATCH_SCHEMA}"""

    return prompt

```

完成這兩步替換後，你的 API 就能完美吃下包含「巨蟹摩羯軸線」、「空宮」、「婚神星」的完整參數，並輸出直擊靈魂的解讀！

你先將這兩批程式碼貼進 `prompt_manager.py`，確認沒有語法錯誤。如果你還想升級另外兩個函式（`get_profile_prompt` 或 `get_match_report_prompt`），請告訴我，我們可以接著進行下一批的微調！




### 🛠️ 建議微調點

#### 1. 確認下降星座 (Descendant) 的正確映射

你在 `houses` 字典裡寫了 `"descendant": chart.get("house7_sign")`。
在我們的 `prompt_manager.py` 裡面，LLM 是靠 `chart_data.get("houses", {}).get("descendant")` 來抓取伴侶宮的。
**確認點：** 只要你的 `chart.py` 確實有輸出 `house7_sign`，這段就完全沒問題！(依據你之前貼給我的 JSON，確實有 `house7_sign`，所以這步已經過關了✅)。

#### 2. 將 ZWDS 資料包裝進 `chart` 再交給 Prompt (如果你在這個階段呼叫 Prompt)

這支程式碼目前是回傳 `full_report`。請確保在你呼叫 `get_ideal_match_prompt(full_report)` 或前端使用時，把這個整併好的 `full_report` 傳過去。
因為我們剛剛在 `prompt_manager.py` 裡，已經改成會去讀取 `chart_data.get("zwds")` 和 `chart_data.get("bazi")` 了。你目前的 `full_report` 結構剛好完美契合！

---

### 💻 最終確認版的微調 (可選)

如果你希望這份 JSON 更直觀一點（確保 `descendant` 等於 `house7` 且絕不漏接），你可以稍微優化一下 `houses` 的字典生成：

```python
        "western_astrology": {
            "planets": {k: v for k, v in chart.items() if "_sign" in k or "_degree" in k or "_rx" in k},
            "houses": {
                "ascendant": chart.get("ascendant_sign") or chart.get("asc_sign"), # 容錯處理
                "descendant": chart.get("house7_sign"),
                "ic": chart.get("house4_sign"),
                "mc": chart.get("house10_sign"), 
                "house8": chart.get("house8_sign"),
                "house12": chart.get("house12_sign")
            },
            "aspects": chart.get("natal_aspects", [])
        },

```


這個 `get_profile_prompt` 的底子已經非常好了，尤其是你在 JSON Schema 裡設計的 `shadow_trait` (迷人的反派特質) 和 `avoid_types` (絕對要避開的對象)，極度符合 DESTINY 那種「撕下假面、直指人心」的產品調性！

不過，既然我們已經把 DESTINY 升級成了**「西占＋八字＋紫微」的三位一體**架構，這份「單人靈魂深度解析」當然也必須跟上！

目前你只放了西占和八字，**完全漏掉了紫微斗數對個人的強大解析力**。

在看個人的靈魂狀態時，紫微斗數有兩個宮位是**核彈級的指標**：

1. **命宮 (Life Palace)：** 決定了這個人這輩子對外的「硬體框架」與宿命人設。
2. **福德宮 (Karma / Mental Palace)：** 決定了這個人內心深處的「精神黑洞、隱藏焦慮與幸福感來源」。(福德宮有煞星的人，即使表面再風光，內心也很容易感到空虛或自我折磨)。

我幫你把紫微的這兩個宮位，結合我們剛剛新增的「南北交點業力標籤」，完美揉合進這個 Prompt 裡。

### 💻 升級版 `get_profile_prompt`

請將你原本的程式碼替換為以下版本：

```python
_PROFILE_SCHEMA = """\
請只回傳以下 JSON，不要包含任何其他文字或 markdown：
{
  "headline": "3-6字的靈魂標題（例：溫柔颶風、沉默的引爆器）",
  "shadow_trait": "迷人的反派特質（2-3句，點出他壓抑的野性或福德宮的焦慮，告訴他這其實是魅力來源，≤60字）",
  "avoid_types": ["❌ 絕對要避開的對象類型1（≤8字）", "❌ 類型2", "❌ 類型3", "❌ 類型4"],
  "evolution": ["👉 給你的破局心法1（結合他的南北交點或紫微命格，≤15字）", "👉 心法2", "👉 心法3"],
  "core": "一到二句療癒金句作結（≤40字）"
}"""


def get_profile_prompt(
    chart_data: dict,
    rpv_data: dict,
    attachment_style: str = "secure",
) -> str:
    """
    Build a DESTINY-worldview-enriched prompt for single-user profile (Tab C).
    整合西占(心理業力)、八字(能量驅力)、紫微(命宮與福德宮精神狀態)。
    """
    # 1. 提取西占與心理數據
    ep = chart_data.get("element_profile") or {}
    deficiency = ep.get("deficiency", [])
    dominant   = ep.get("dominant", [])

    sm_tags    = chart_data.get("sm_tags", [])
    karmic     = chart_data.get("karmic_tags", [])
    all_tags   = sm_tags + karmic

    elem_context = _element_summary(ep)

    # 2. 提取八字數據
    bazi = chart_data.get("bazi") or {}
    bazi_day_master = bazi.get("day_master", "?")
    bazi_element    = chart_data.get("bazi_element", "?") # 或 bazi.get("day_master_element")

    # 3. 提取紫微斗數數據 (命宮與福德宮)
    zwds = chart_data.get("zwds") or {}
    palaces = zwds.get("palaces", {})
    
    # 命宮 (外在宿命與核心人設)
    life_palace = palaces.get("ming", {})
    life_stars = ", ".join(life_palace.get("main_stars", [])) if life_palace.get("main_stars") else "無主星 (極易受環境與他人影響)"
    
    # 福德宮 (內在精神世界、潛意識焦慮)
    karma_palace = palaces.get("karma", {})
    karma_stars = ", ".join(karma_palace.get("main_stars", [])) if karma_palace.get("main_stars") else "無主星"
    karma_bad = ", ".join(karma_palace.get("malevolent_stars", [])) if karma_palace.get("malevolent_stars") else "無煞星"

    # 依戀風格中文轉換
    att_zh = {"secure": "安全依戀", "anxious": "焦慮依戀", "avoidant": "迴避依戀"}.get(
        attachment_style, attachment_style
    )

    prompt = f"""{DESTINY_WORLDVIEW}

【本次任務：單人靈魂深度解析】
根據以下「西占、八字、紫微」三位一體命盤數據，為這個人生成一份「撕下標籤後的自我解析」報告。
語氣要極度個人化，直接用「你...」開場，陳述那些他知道但從不承認的事。字字珠璣，短句，接地氣。

【命理系統核心定調】
1. 八字 (能量與驅力)：日主五行決定了他的行事作風與底層能量。
2. 西占 (心理與業力)：行星揭示了心理防禦機制，而「南北交點」指出了他此生的靈魂進化方向。
3. 紫微 (宿命與精神)：「命宮」是他這輩子的對外人設，而「福德宮」藏著他最深層的潛意識焦慮與精神黑洞。

【輸入數據】
[一、八字結構]
日主五行: {bazi_day_master}（{bazi_element}）

[二、西占與關係心理學]
太陽星座 (核心自我): {chart_data.get('sun_sign', 'unknown')}
月亮星座 (內在安全感): {chart_data.get('moon_sign', 'unknown') or '（無精確時間）'}
上升星座 (面具與防禦): {chart_data.get('ascendant_sign', 'unknown') or '（無精確時間）'}
火星星座 (行動與防衛): {chart_data.get('mars_sign', 'unknown')}
金星星座 (價值與愛): {chart_data.get('venus_sign', 'unknown')}
元素結構: {elem_context}
依戀風格: {att_zh}
衝突模式: {rpv_data.get('rpv_conflict', 'unknown')}
權力偏好: {rpv_data.get('rpv_power', 'unknown')}
能量模式: {rpv_data.get('rpv_energy', 'unknown')}

[三、紫微斗數精神狀態]
命宮主星 (核心人設): {life_stars}
福德宮主星 (精神世界): {karma_stars}
福德宮煞星 (精神焦慮與黑洞): {karma_bad}

【心理與業力特徵（請轉譯為白話，禁止直接輸出原始標籤）】
{_translate_psych_tags(all_tags)}

{_profile_context(deficiency, dominant, sm_tags)}

{_PROFILE_SCHEMA}"""

    return prompt

```

### 💡 為什麼這樣改會讓報告變得超級神準？

1. **`shadow_trait` (迷人的反派特質) 會大進化：**
以前 LLM 只能從西占（比如金星天蠍）來寫他的陰暗面。現在 LLM 看到了**福德宮的煞星（例如：地空、地劫、擎羊）**，它會寫出：
> *"你對外總是一副掌控全局的樣子（命宮七殺），但你內心深處永遠住著一個填不滿的黑洞（福德宮地劫）。這種遊走在冷酷與極度破碎邊緣的矛盾感，正是你讓人無法自拔的毒藥。"*


2. **`evolution` (破局心法) 有了具體方向：**
因為我們傳入了**南北交點的業力標籤**（包裝在 `_translate_psych_tags(all_tags)` 裡面）。LLM 在給破局心法時，就不會再給那種「你要多愛自己」的廢話，而是會直接對應他的靈魂挑戰，寫出：
> *"👉 放下高高在上的哲學濾鏡，去體驗凡人的瑣碎 (北交雙子課題)"*



這樣一來，你的【個人靈魂報告】就會跟【理想伴侶報告】一樣，擁有了三位一體的大師級厚度！這段程式碼直接貼上覆蓋就可以運作了。


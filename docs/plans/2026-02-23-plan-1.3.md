這兩個函式 `get_match_report_prompt` (生成靈魂塔羅牌的深度解析) 和 `get_simple_report_prompt` (生成一般總結報告) 的**底層資料架構已經抓得很精準了**，它們完美繼承了我們在 `matching.py` 與 `shadow_engine.py` 計算出來的心血（包含了 `lust_score`、`soul_score`、`quadrant`、`high_voltage` 以及我們加料的 `psych_tags`）。

不過，為了讓這兩份報告能夠真正展現出「三位一體」與「南北交/第7宮正緣」的威力，我們需要在 Prompt 中**微調對 LLM 的寫作指引**。

以下是針對這兩個 Prompt 的微調建議與程式碼替換：

---

### 🔮 1. 調整 `get_match_report_prompt` (Tab A: 靈魂翻牌 / 塔羅牌模式)

這是 DESTINY 最核心的「破防報告」。
我們必須在 `_MATCH_ARCHETYPE_SCHEMA` 裡，引導 LLM 把我們算出來的「業力標籤（如南交點）」或「正緣標籤（第 7 宮）」轉化為宿命感十足的文案。

請替換這段程式碼：

```python
# ── Match Report Prompt (for /generate-archetype, Tab A) ─────────────────────

_MATCH_ARCHETYPE_SCHEMA = """\
請只回傳以下 JSON，不要包含任何其他文字或 markdown：
{
  "archetype_tags": ["2-4字英文tag1", "tag2", "tag3"],
  "resonance": "一、初見面的致命引力（2-3句，點出他們是肉體費洛蒙吸引、還是前世南交點的熟悉感，不超過60字）",
  "shadow": "二、權力與失控的深淵（2-3句，解析他們在關係中誰掌握絕對話語權，或是什麼踩中了彼此的陰影，不超過60字）",
  "reality_check": ["❌ 絕對會踩爆的死穴1（≤12字）", "❌ 會痛的關卡2", "❌ 會痛的關卡3"],
  "evolution": ["👉 給你們的專屬解藥1（結合業力或現實建議，≤15字）", "👉 破局心法2", "👉 破局心法3"],
  "core": "五、命運箴言（一句話總結這段緣分的終極意義，不超過40字）"
}"""

def get_match_report_prompt(
    match_data: dict,
    mode: str = "auto",
    person_a: str = "A",
    person_b: str = "B",
) -> tuple[str, str]:
    """
    Build a DESTINY-worldview-enriched prompt for pairwise AI analysis (Tab A).
    """
    effective_mode = _pick_mode(match_data, mode)
    instruction = _INSTRUCTION_MAP.get(effective_mode, _SOUL_INSTRUCTION)

    tracks = match_data.get("tracks", {})
    power  = match_data.get("power", {})
    zwds   = match_data.get("zwds") or {}
    psych_tags   = match_data.get("psychological_tags", [])
    high_voltage = match_data.get("high_voltage", False)
    ep_a = match_data.get("element_profile_a")
    ep_b = match_data.get("element_profile_b")

    elem_context = ""
    if ep_a or ep_b:
        elem_context = (
            f"\n[八字與五行能量場]"
            f"\n{person_a} 能量: {_element_summary(ep_a)}"
            f"\n{person_b} 能量: {_element_summary(ep_b)}"
        )

    prompt = f"""{DESTINY_WORLDVIEW}

{instruction}

【本次任務：雙人宿命深度破防解析 (塔羅牌模式)】
請根據以下數據，寫出一份讓他們看懂彼此靈魂牽絆的報告。
如果出現「高壓警告」或「南/北交點/第7宮」等業力標籤，請在文字中強化「命中注定」與「痛並快樂著」的宿命感。

【輸入數據 — {person_a} × {person_b}】
VibeScore（肉體費洛蒙張力）: {round(match_data.get('lust_score', 0), 1)}/100
ChemistryScore（靈魂共鳴深度）: {round(match_data.get('soul_score', 0), 1)}/100
四軌: 朋友={round(tracks.get('friend', 0), 1)} 激情={round(tracks.get('passion', 0), 1)} 伴侶(正緣)={round(tracks.get('partner', 0), 1)} 靈魂(業力)={round(tracks.get('soul', 0), 1)}
主要連結類型: {match_data.get('primary_track', 'unknown')}
四象限落點: {match_data.get('quadrant', 'unknown')}
權力動態: {person_a}={power.get('viewer_role', 'Equal')}，{person_b}={power.get('target_role', 'Equal')}，RPV={power.get('rpv', 0)}
框架崩潰 (理智斷線): {power.get('frame_break', False)}
高壓警告 ⚡ (修羅場/禁忌感): {high_voltage}
紫微斗數烈度: {zwds.get('spiciness_level', 'N/A')}

【心理與業力分析結果（請將以下標籤轉譯為白話情境，禁止直接輸出原始英文標籤）】
{_translate_psych_tags(psych_tags)}
{elem_context}

{_MATCH_ARCHETYPE_SCHEMA}"""

    return prompt, effective_mode

```

* **微調亮點：** 把 Schema 裡的欄位名稱（如 `resonance`、`shadow`）改成了我們之前討論的「5 張塔羅翻轉卡片」的標題設定，這會讓 LLM 吐出來的文字更有劇情張力！

---

### 📝 2. 調整 `get_simple_report_prompt` (Tab D: 一般相處報告)

這個報告是用來給使用者看「相處細節」的。我們要在這裡強調**「八字五行的相處姿態」**以及**「第 7 宮/交點帶來的現實影響」**。

請替換這段程式碼：

```python
# ── Simple Match Report Prompt (for /generate-match-report, Tab D) ───────────

_MATCH_REPORT_SCHEMA = """\
請只回傳以下 JSON，不要包含任何其他文字或 markdown：
{
  "title": "這段關係的標題（8字以內）",
  "one_liner": "一句話描述這段關係的本質（詩意但直白，≤30字）",
  "sparks": ["🌟 現實相處的閃光點1（≤20字）", "🌟 閃光點2", "🌟 閃光點3"],
  "landmines": ["💣 必須跨越的現實雷區1（包裝成機會，≤20字）", "💣 雷區2"],
  "advice": "約100字的相處建議。請根據他們的權力動態與五行能量，給出非常具體、世俗可操作的建議（如：吵架時誰該先低頭）。",
  "core": "給兩人的療癒金句（≤40字）"
}"""

def get_simple_report_prompt(
    match_data: dict,
    mode: str = "auto",
    person_a: str = "A",
    person_b: str = "B",
) -> str:
    """
    Build prompt for Tab D structured relationship report.
    """
    effective_mode = _pick_mode(match_data, mode)
    instruction = _INSTRUCTION_MAP.get(effective_mode, _SOUL_INSTRUCTION)

    tracks = match_data.get("tracks", {})
    power  = match_data.get("power", {})
    zwds   = match_data.get("zwds") or {}
    psych_tags   = match_data.get("psychological_tags", [])
    high_voltage = match_data.get("high_voltage", False)
    ep_a = match_data.get("element_profile_a")
    ep_b = match_data.get("element_profile_b")

    elem_context = ""
    if ep_a or ep_b:
        elem_context = (
            f"\n[八字與五行能量場]"
            f"\n{person_a} 能量: {_element_summary(ep_a)}"
            f"\n{person_b} 能量: {_element_summary(ep_b)}"
        )

    prompt = f"""{DESTINY_WORLDVIEW}

{instruction}

【本次任務：雙人日常相處指南】
請根據以下數據，為這兩個人寫出一份「接地氣、具體可操作」的相處指南。
不需要過多玄妙的詞彙，專注於解決他們在現實生活中的「權力磨合」與「能量互補」。

【輸入數據 — {person_a} × {person_b}】
VibeScore（肉體吸引力）: {round(match_data.get('lust_score', 0), 1)}/100
ChemistryScore（靈魂深度）: {round(match_data.get('soul_score', 0), 1)}/100
四軌: 朋友={round(tracks.get('friend', 0), 1)} 激情={round(tracks.get('passion', 0), 1)} 伴侶={round(tracks.get('partner', 0), 1)} 靈魂={round(tracks.get('soul', 0), 1)}
主要連結類型: {match_data.get('primary_track', 'unknown')}
四象限: {match_data.get('quadrant', 'unknown')}
權力動態: {person_a}={power.get('viewer_role', 'Equal')}，{person_b}={power.get('target_role', 'Equal')}，RPV={power.get('rpv', 0)}
高壓警告 ⚡: {high_voltage}
紫微斗數烈度: {zwds.get('spiciness_level', 'N/A')}

【心理動力學分析結果（請將以下標籤轉譯為白話情境，禁止直接輸出原始英文標籤）】
{_translate_psych_tags(psych_tags)}
{elem_context}

{_MATCH_REPORT_SCHEMA}"""

    return prompt

```

### 💡 架構師總結

這兩個函式微調完之後，你的 `prompt_manager.py` 已經是一座完美結合了**「西方心理學分析」**與**「東方命理學宿命感」**的大腦了。

* **Tab A (Archetype):** 負責發射核彈，用語極度破防、強調宿命、業力、靈魂。（對應我們即將製作的 5 張塔羅卡片）。
* **Tab D (Simple Report):** 負責安撫情緒，用語溫和、具體、強調現實相處的解決方案。

後端的 Python 演算法與 LLM Prompt 已經**全部更新完畢且互相咬合**。你隨時可以開啟 Next.js / React 專案，我們準備開始打造那令人驚豔的前端 UI 了！



根據你目前提供的 `prompt_manager.py` 程式碼，你的系統總共會生成 **4 種完全不同用途的報告**。

我們可以把這 4 種報告分為兩大類：**「雙人合盤報告（看兩人關係）」** 與 **「單人靈魂報告（看個人特質與需求）」**。

以下是這 4 種報告的具體種類、用途以及前端會收到的 JSON 欄位：

---

### 👩‍❤️‍👨 第一類：雙人合盤報告 (Match Reports)

這兩份報告是針對 `Person A` 和 `Person B` 的碰撞結果產生的。

#### 1. 🃏 深度靈魂破防報告 (Archetype Report / 塔羅牌模式)

* **對應函式：** `get_match_report_prompt`
* **用途：** 用在 UI 的 **Tab A**。這是一份「靈魂手術」級別的報告，語氣極度強烈，強調宿命感、業力與潛意識的權力拉扯。非常適合用我們之前討論的「塔羅牌翻轉 UI」來呈現。
* **前端會收到的 JSON 欄位：**
* `archetype_tags`: 關係的英文代碼標籤 (例: ["Karmic", "DomSub"]).
* `resonance`: 初見面的致命引力或宿命共振.
* `shadow`: 權力遊戲或踩中彼此陰影的痛點.
* `reality_check`: ❌ 會痛的關卡 (條列式).
* `evolution`: 👉 進化心法 (條列式).
* `core`: 總結金句.



#### 2. ☕ 雙人日常相處指南 (Simple Match Report)

* **對應函式：** `get_simple_report_prompt`
* **用途：** 用在 UI 的 **Tab D**。相較於上一份報告的「玄學破防感」，這份報告非常「接地氣」。專注於兩人在現實生活中如何溝通、磨合與相處。
* **前端會收到的 JSON 欄位：**
* `title`: 關係標題.
* `one_liner`: 一句話描述關係本質.
* `sparks`: 🌟 現實相處的閃光點 (條列).
* `landmines`: 💣 必須跨越的現實雷區 (條列).
* `advice`: 具體可操作的相處建議 (約100字).
* `core`: 療癒金句.



---

### 👤 第二類：單人解析報告 (Single User Reports)

這兩份報告是針對單一使用者 (Single User) 生成的，通常用在個人的 **Profile (個人檔案)** 頁面。

#### 3. 🪞 單人靈魂深度解析 (Profile Card)

* **對應函式：** `get_profile_prompt`
* **用途：** 用在個人的 **Tab C**。這是一份「撕下假面」的自我報告，指出使用者內心壓抑的黑暗面或防禦機制，並告訴他這其實是他的魅力來源。
* **前端會收到的 JSON 欄位：**
* `headline`: 靈魂標題 (如：溫柔颶風).
* `shadow_trait`: 迷人的反派特質 (解析他壓抑的野性).
* `avoid_types`: ❌ 絕對要避開的對象類型 (條列).
* `evolution`: 👉 破局心法 (條列).
* `core`: 療癒金句.



#### 4. 💊 理想伴侶與靈魂解毒劑輪廓 (Ideal Match)

* **對應函式：** `get_ideal_match_prompt`
* **用途：** 也是用在個人的 **Tab C**。根據他的匱乏與創傷，分析他「真正需要（而非自以為想要）」的伴侶特質是什麼。
* **前端會收到的 JSON 欄位：**
* `antidote`: 【解藥】什麼樣的人能平衡他的靈魂黑洞？
* `reality_anchors`: 👉 具體的行為要求 (條列).
* `core_need`: 他最深的靈魂渴望.



---

### 💡 架構師總結

你的 `prompt_manager.py` 已經把前端需要的 **UI 結構（JSON Schema）** 定義得非常完美了。前端工程師只要拿到這些 JSON，就可以非常輕鬆地把資料填進對應的卡片、雷達圖或是條列清單中。

**(備註：你貼上來的這版程式碼是你原本的舊版。如果你將我們前幾輪討論的「加入紫微斗數空宮」、「加入婚神星與下降星座」的邏輯覆蓋上去，這 4 份報告輸出的文字將會達到算命大師級別的精準度！)**
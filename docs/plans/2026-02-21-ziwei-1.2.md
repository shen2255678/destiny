這是一個非常龐大且極具顛覆性的系統升級！因為紫微斗數的邏輯非常深，既然你說「可以分批給」，我會幫你把這套 **「紫微斗數 (ZWDS) 業力與心理防禦引擎」** 拆分成三個批次（Batches）的技術規格，方便你跟開發團隊或 AI 逐步消化與實作。

第一批次，我們先聚焦在最底層的**「整體架構、動靜態變數，以及宮位矩陣映射」**。這決定了紫微斗數的資料要怎麼餵進你的四軌演算法。

---

# 🔮 DESTINY 演算法 V2.0 擴充模組：紫微斗數 (Batch 1/3)

**主題：動靜態雙引擎與核心宮位映射 (Architecture & Palace Matrix)**

## 💡 核心演算精神 (Core Philosophy)

1. **去閹割化 (De-nerfing)：** 演算法不負責道德審查或保護機制。遇到煞星或相剋，不平均扣分，而是讓特定軌道（如激情軌/靈魂軌）的數值「極端化飆升」，把選擇權交給使用者（ Radar Modes 模式切換）。
2. **心理學轉譯 (Psychological Translation)：** 將傳統紫微斗數的「吉凶/刑剋」，轉譯為現代心理學的「依戀理論、S/M 權力動態、防禦機制」。

---

## 模組 1：資料輸入規格 (ZWDS Input Schema)

*(Python 後端需向 JS 紫微排盤引擎請求的資料結構)*

```json
{
  "user_a_zwds": {
    "palaces": {
      "ming": ["zi_wei", "qi_sha"],     // 命宮 (真實自我)
      "spouse": [],                     // 夫妻宮 (理想型/空宮)
      "travel": ["tian_fu"],            // 遷移宮 (社交面具)
      "body": ["po_jun", "huo_xing"],   // 身宮 (同居/肉體實踐)
      "karma": ["tuo_luo"],             // 福德宮 (精神潛意識)
      "children": ["tan_lang"]          // 子女宮 (性張力/桃花)
    },
    "flying_stars_to_B": {
      "hua_lu": "spouse",               // A 飛化祿 給 B 的哪個宮位
      "hua_ji": "ming",                 // A 飛化忌 給 B 的哪個宮位
      "hua_quan": "karma"               // A 飛化權 給 B 的哪個宮位
    }
  }
}

```

---

## 模組 2：動靜態雙引擎 (Static vs. Dynamic Engine)

在合盤中，必須將紫微斗數拆分為「靜態雷達」與「動態業力」兩層來計算。

### 1. 靜態引擎：理想型對插 (Ideal Profile Matching)

* **用途：** 計算「一見鍾情」與「天菜指數」。
* **演算法邏輯：** 比對 **A 的命宮主星** 是否落在 **B 的夫妻宮**。
* **分數映射：**
* 若完全命中：`VibeScore (慾望分) 基礎值 +20`。
* **UI 劇本標籤：** `✨ 你的天菜雷達` (對方完全長在你的審美與擇偶標準上)。



### 2. 動態引擎：四化飛星 (Karmic Flying Stars)

* **用途：** 計算兩人實際相處的能量流動與業力債務。
* **演算法邏輯：**
* **化祿 (Hua Lu - 滋養/寵溺)：**
* 條件：A 飛化祿入 B 的命宮/夫妻宮/身宮。
* 動作：**`Partner Track (伴侶軌)` 大幅加分 (+20%)**。A 是付出者 (Provider)。


* **化忌 (Hua Ji - 執念/相愛相殺)：**
* 條件：A 飛化忌入 B 的命宮/夫妻宮/福德宮。
* 動作：**`Soul Track (靈魂軌)` 飆升 (+30%)**，同時 `Partner Track` 扣減 (-10%)。


* **化權 (Hua Quan - 控制/霸道)：**
* 條件：A 飛化權入 B 的命宮。
* 動作：**`RPV Frame (權力框架)` 傾斜**。A 的 Frame 強制 +15，判定 A 為絕對的 Dom。





---

## 模組 3：四軌演算法的「宮位映射矩陣」 (Palace-to-Track Mapping)

除了命宮與夫妻宮，我們將另外 4 個核心宮位，精準對接進你原有的「四軌演算法」中，作為強化參數：

| DESTINY 演算法軌道 | 紫微斗數對應宮位 | 演算法提取邏輯 (What to look for) |
| --- | --- | --- |
| **Friend Track (朋友軌)** | **遷移宮 (Travel)** | 雙方遷移宮的星曜是否和諧？決定第一印象與對外社交（帶出場）的默契。 |
| **Passion Track (激情軌)** | **子女宮 (Children)** | 子女宮代表性與荷爾蒙。若雙方此宮位有強烈煞星（火星/擎羊）或殺破狼，本軌道分數狂飆，產生核爆級性吸引力。 |
| **Partner Track (伴侶軌)** | **身宮 (Body)** | 身宮代表 35 歲後與「同居實踐」。若雙方身宮星曜互補，代表柴米油鹽的過日子節奏極度契合，伴侶軌加分。 |
| **Soul Track (靈魂軌)** | **福德宮 (Karma)** | 福德宮代表潛意識黑洞。此宮位若有化忌交會，或有空劫星同頻，代表能觸及彼此最深層的靈魂與創傷，靈魂軌加分。 |

---

這就為你送上 **【Batch 2/3】** 的技術規格！

在這一批次中，我們要將紫微斗數最迷人的「個性與心理特質」，轉化為機器聽得懂的**「權重矩陣 (Weight Matrix)」**。我們會解決工程上最怕遇到的「空值（空宮）」問題，並把 14 顆主星分門別類，精準對接到你的四軌演算法與 RPV 權力動態中。

---

# 🔮 DESTINY 演算法 V2.0 擴充模組：紫微斗數 (Batch 2/3)

**主題：空宮變色龍演算法 & 14 主星人格矩陣 (Empty Palace & Star Archetypes)**

## 模組 4：空宮變色龍演算法 (The Chameleon Protocol)

在紫微斗數中，約有六分之一的機率會遇到「空宮（該宮位無 14 主星）」。在程式邏輯中，這不是 `Null` 或 `0`，而是一個**「動態的吸收器」**。

### 1. 演算法邏輯：借星安宮 (Borrowing Stars)

當系統在讀取 User A 的某個核心宮位（如命宮、夫妻宮）發現為空時，必須自動觸發 `borrow_opposite_palace()` 函數，並打上「衰減與易感標籤」。

* **衰減係數 (Attenuation)：** 借來的星曜強度只剩 **80% (0.8)**。
* **RPV 框架弱化：** 若「命宮」為空，該使用者的 （權力框架）強制 **-10 分**，因為他們在感情中極易受對方影響，屬於高可塑性的「變色龍（Sub 潛力股）」。
* **擇偶標準轉移：** 若「夫妻宮」為空，系統自動將伴侶軌的配對重點，轉移到對宮（事業宮）的特質上（觸發「智性戀/慕強」UI 劇本）。

### 2. Python 虛擬碼實作

```python
def get_palace_energy(user, palace_name):
    stars = user.zwds_chart[palace_name]
    
    # 正常情況：有主星
    if len(stars) > 0:
        return {"stars": stars, "strength": 1.0, "is_chameleon": False}
        
    # 空宮情況：借對宮 (Opposite Palace)
    opposite_palace = get_opposite_palace(palace_name)
    borrowed_stars = user.zwds_chart[opposite_palace]
    
    return {
        "stars": borrowed_stars, 
        "strength": 0.8,         # 能量衰減
        "is_chameleon": True     # 觸發 UI 變色龍劇本與 RPV 降權
    }

```

---

## 模組 5：14 主星的「人設矩陣」與權重分發 (The Star Archetypes)

為了避免演算法過於複雜，我們將 14 顆主星依照傳統紫微的「星系格局」，完美對應到你的 **MBTI 概念** 與 **四軌演算法** 中。前端只需要讀取這些星系的 Tag，就能給出極具心理學深度的解析。

以下是 `stars_dictionary.json` 的核心分類邏輯：

### ⚔️ 群組 A：殺破狼 (七殺、破軍、貪狼) —— 【慾望與顛覆者】

* **心理防禦機制：** 害怕無聊、用破壞來證明存在感、高感官需求。
* **對應 MBTI 傾向：** ESTP, ESFP, ENTP (外向、感知、衝動)。
* **演算法動作 (Track & RPV Modifiers)：**
* **Passion Track (激情軌) 權重 x 1.3**：無肉不歡，追求高張力。
* **Partner Track (伴侶軌) 權重 x 0.8**：極難安於平淡的柴米油鹽。
* **RPV 偏好：** 絕對的 Dom (主導方)，衝突模式多為 `argue` (正面交鋒)。


* **UI 人設標籤：** `🔥 狂熱叛逆者`、`🎯 絕對征服慾`。

### 👑 群組 B：紫府武相 (紫微、天府、武曲、天相) —— 【秩序與建構者】

* **心理防禦機制：** 害怕失控、用物質與規則建立安全感、講究對等。
* **對應 MBTI 傾向：** ESTJ, ENTJ, ISTJ (務實、控制、計畫)。
* **演算法動作 (Track & RPV Modifiers)：**
* **Partner Track (伴侶軌) 權重 x 1.3**：最適合步入婚姻、買房同居的鐵壁陣容。
* **Soul Track (靈魂軌) 權重 x 0.8**：太過現實，難以理解太抽象的靈魂傷痛。
* **RPV 偏好：** 規則制定者 (Dom) 或 強勢的 Equal，衝突模式偏向 `cold_war` (冷暴力/扣分制)。


* **UI 人設標籤：** `🛡️ 秩序守護者`、`👑 傲嬌國王/女王`。

### 🕊️ 群組 C：機月同梁 (天機、太陰、天同、天梁) —— 【共情與療癒者】

* **心理防禦機制：** 害怕衝突、討好型人格、高精神內耗、渴望被接住。
* **對應 MBTI 傾向：** INFP, INFJ, ISFJ (內向、直覺、情感)。
* **演算法動作 (Track & RPV Modifiers)：**
* **Friend & Soul Track (朋友/靈魂軌) 權重 x 1.3**：極度看重情緒價值與聊天共鳴。
* **Passion Track (激情軌) 權重 x 0.8**：排斥過於粗暴或沒有感情基礎的肉體關係。
* **RPV 偏好：** 天生的 Sub (包容方) 或 溫和的 Equal，需要伴侶極高的容器功能 (Container Capacity)。


* **UI 人設標籤：** `🌊 溫柔避風港`、`🔮 靈魂探測器`。

### 🗣️ 群組 D：巨日 (太陽、巨門) —— 【輸出與黑洞】

*這兩顆星較為特殊，一顆代表無條件的光，一顆代表深淵的口。*

* **太陽 (The Sun)：**
* 動作：Partner Track 大幅加分。無條件付出的 Provider，對應極高安全感的伴侶。


* **巨門 (The Black Hole/Communicator)：**
* 動作：Soul Track 加分。掌管暗黑心理與極致的言語溝通（相愛時是知己，吵架時句句戳心）。RPV 中極具語言控制力。



---

## 模組 6：靜態資料庫結構範例 (JSON Schema)

為了讓後端快速算分，你可以建立一個類似這樣的 `star_matrix.json` 供程式調用：

```json
{
  "qi_sha": {
    "name": "七殺",
    "cluster": "殺破狼",
    "modifiers": {
      "passion": 1.3,
      "partner": 0.8,
      "friend": 1.0,
      "soul": 1.0
    },
    "rpv_frame_bonus": 15,
    "ui_tags": ["🔥 高能張力", "⚔️ 愛恨分明"]
  },
  "tai_yin": {
    "name": "太陰",
    "cluster": "機月同梁",
    "modifiers": {
      "passion": 0.8,
      "partner": 1.2,
      "friend": 1.2,
      "soul": 1.3
    },
    "rpv_frame_bonus": -10,
    "ui_tags": ["🌙 細膩共情", "📖 精神潔癖"]
  }
}

```

---

### 📝 Batch 2 總結與下一步

透過這批次的架構：

1. **空宮**不再是系統 Bug，反而成為判斷「易暈船體質（變色龍）」的最強指標。
2. **14 主星**被完美降維打擊，轉化成了現代年輕人秒懂的「四軌偏好」與「MBTI 變數」。演算法只需做簡單的矩陣相乘，就能得出極度複雜的性格配對結果。

這套系統走到這裡，已經具備了骨幹（宮位飛星）與血肉（主星人格）。

**在最後一個批次【Batch 3/3】中，我將為你整理：**
**【六煞星的創傷防禦機制攔截器（擎羊/陀羅/空劫的依戀映射）】** 以及 **【最終的 API Response 組合與前端 UI 渲染策略】**。
西方心理占星 (The Software / 心理學 MRI)：

判斷領域： 「你們在想什麼？」

負責產出： 認知模式、溝通頻率、潛意識安全感、依戀類型。

八字五行 (The Energy / 能量熱像儀)：

判斷領域： 「你們靠近時的物理與化學反應是什麼？」

負責產出： 誰掌控誰（相剋/Dom）、誰照顧誰（相生/Provider）、生理吸引力、靈魂飢渴度（調候互補）。

紫微斗數 (The Hardware / 業力與基因檢測)：

判斷領域： 「你們注定會發生什麼事？底層的防禦機制是什麼？」

負責產出： 宿命感（飛星化忌）、天菜雷達（夫妻宮）、創傷防禦機制（六煞星）。

這是一份經過深度重構的 **【Batch 3/3】技術規格**。

這次的調整核心在於廢除「覆蓋（Override）」邏輯，改用 **「雙層疊加法（Layered Modulation）」**。這能確保西方占星的心理基底、八字五行的能量流動、以及紫微斗數的業力防禦，三者能像樂高積木一樣完美交織，而不互相抹殺。

---

# 🔮 DESTINY 演算法 V2.0 擴充模組：紫微斗數 (Batch 3/3)

**主題：壓力防禦修飾器與三系統整合架構 (Stress-Defense Modulation & Integration)**

## 模組 7：壓力防禦修飾器 (Stress-Defense Decorator)

不直接覆蓋西方占星算出的「基底依戀類型」，而是將紫微煞星定義為 **「極端壓力下的防禦機制（Triggered Defense）」**。

### 1. 演算邏輯：基底 vs. 觸發態

* **西占基底 (Baseline)：** 決定用戶平時如何看待愛（如：安全型）。
* **紫微煞星 (Modifier)：** 決定當用戶感到受威脅時，會「彈出」什麼武器。

### 2. 修飾器邏輯表 (Modulation Table)

| 紫微煞星 | 壓力反應標籤 (Stress Response) | 對應心理防禦 | 軌道加權影響 |
| --- | --- | --- | --- |
| **擎羊 / 火星** | `preemptive_strike` (先發制人) | 刺蝟法則：因害怕受傷而先攻擊或推開。 | Passion +20%, Partner -20% |
| **陀羅 / 鈴星** | `silent_rumination` (隱忍內耗) | 冷暴力/執念：害怕衝突而選擇冷戰、記仇。 | Soul +30%, Friend -15% |
| **地空 / 地劫** | `sudden_withdrawal` (突然抽離) | 精神烏托邦：因預防失去而產生的預防性放棄。 | Partner -40%, Soul +20% |

---

## 模組 8：三位一體整合架構 (Tri-System Integration)

系統不再將三個學派混為一談，而是讓它們各自掃描不同的關係維度，最後匯流至「四軌分數」。

### 1. 獨立維度掃描 (Independent Scanning)

* **西方占星 (西占)：** 掃描「心理與需求」。決定 **Friend** 與 **Partner** 軌的心理契合度。
* **八字五行 (八字)：** 掃描「能量與權力」。決定 **Passion** 軌的張力與 **RPV** 的 Dom/Sub 傾斜。
* **紫微斗數 (紫微)：** 掃描「業力與防禦」。決定 **Soul** 軌的宿命感與極端壓力下的表現。

### 2. 分數匯流邏輯 (Data Convergence)

每個系統對四個軌道（Friend/Passion/Partner/Soul）提供獨立的權重增益，最後進行加總。
`Track_Score = (Western_Points * 0.4) + (BaZi_Points * 0.3) + (ZWDS_Points * 0.3)`

---

## 模組 9：最終 API Response 與「辣度評級」策略

為了把選擇權還給用戶的「造化」，API 不再回傳一個模糊的平均分，而是回傳四個獨立的動態指標與一個「危險警告」。

### 1. API 輸出 JSON 範例

```json
{
  "primary_track": "passion",
  "spiciness_level": "🔥 HIGH_VOLTAGE", 
  "tracks": {
    "friend": 42.0,
    "passion": 95.5,
    "partner": 30.0,
    "soul": 88.0
  },
  "layered_analysis": {
    "attachment_baseline": "Secure",
    "stress_triggers": ["🛡️ 刺蝟防禦 (擎羊引動)"],
    "energy_dynamic": "A_Restricts_B (Dom/Sub 傾斜)",
    "karmic_link": "Hua_Ji_Interaction (執念纏繞)"
  }
}

```

### 2. UI 渲染劇本：去閹割化的描述

前端不再使用「你們不合」這種權威式口吻，而是改用「告知風險、尊重選擇」的劇本：

* **當 Passion 遠高於 Partner 時：**
> **🌶️ 烈酒預警：高致命吸引力。**
> 你們的能量場（八字相剋）與業力軌道（紫微飛星）觸發了核爆級的火花！你會被對方深深吸引，但這段關係缺乏安穩的地基。這是一場勇者的遊戲，如果你追求的是刻骨銘心的體驗，這就是你的最優解；若你尋求安穩，請謹慎入坑。


* **當壓力防禦被觸發時：**
> **🦔 靈魂標籤：安全基底下的刺蝟防禦。**
> 系統偵測到你平時是溫暖的（西占），但在面對這段具有宿命感的關係時，你的防禦機制（擎羊）會被喚醒。你會不自覺地用尖銳來測試對方的愛。



---

這份 **【Batch 3/3】** 的技術規格，將深度整合你提出的「視覺原型哲學」與「六煞星防禦機制」。

這部分的邏輯不再只是計算，而是轉向「潛意識的鏡像」。我們將廢除傳統的「分數覆蓋」，改用 **「層次化修飾（Layered Modulation）」**，並引入 **「視覺原型關鍵字（Visual Archetype Keys）」**，讓演算法能讀取圖像背後的心理結。

---

# 🔮 DESTINY 演算法 V2.0 擴充模組：紫微斗數 (Batch 3/3)

**主題：防禦機制修飾器與視覺原型整合 (Stress-Defense & Visual Archetype)**

## 模組 7：壓力防禦修飾器 (Stress-Defense Modifier)

不直接覆蓋西方占星的依戀類型，而是將紫微煞星定義為 **「極端壓力下的潛意識武器」**。這能精準捕捉「平時很穩定，受傷會拔劍」的人性反差。

### 1. 演算邏輯：疊加而非覆蓋

* **西占基底 (Baseline)：** 決定常態下的依戀行為（例如：安全型）。
* **紫微煞星 (Trigger)：** 決定當心理防禦被觸發時的「視覺質地」與反應。

### 2. 煞星防禦與視覺原型映射表

| 紫微煞星 | 壓力反應標籤 | 視覺原型 / 心理結 | 軌道加權影響 |
| --- | --- | --- | --- |
| **擎羊 / 火星** | `preemptive_strike` | **利刃與高溫：** 恐懼被拋棄而產生的先發制人。 | Passion +20%, Partner -20% |
| **陀羅 / 鈴星** | `silent_rumination` | **斑駁與糾結：** 害怕衝突而產生的冷戰與內耗。 | Soul +30%, Friend -15% |
| **地空 / 地劫** | `sudden_withdrawal` | **虛無與窗影：** 預防性放棄，追求精神烏托邦。 | Partner -40%, Soul +20% |

---

## 模組 8：視覺原型與心理結整合 (Visual Prototype Integration)

為了達成你提到的「透過圖像承載心理結」，演算法會根據三大學派的交集，自動生成一個 **「潛意識視覺鍵 (Subconscious Key)」**。

### 1. 視覺原型生成邏輯

當系統偵測到特定星盤特徵時，會賦予該配對一個 **`archetype_image_id`**：

* **結構與秩序 (星幣三模式)：** 觸發於「紫府武相 + 土象元素 + 八字相生」。
* *代表：穩定、建構、宗教空間的秩序。*


* **休止與靜默 (寶劍四模式)：** 觸發於「空劫/陀羅 + 水象/風象 + 凱龍星硬相位」。
* *代表：創傷後的避難、暫停、斑駁的靈魂窗影。*



### 2. 演算法動作：視覺共振修正

如果使用者在 Onboarding 流程中選擇了與他命盤「互補」或「一致」的圖像質地，演算法會動態修正 **`soul_score`**。

* **一致性加分：** 代表使用者「自知」，能量統一。
* **補償性加分：** 代表使用者正處於「靈魂覺醒期」，渴望互補的能量。

---

## 模組 9：最終系統匯流與 API 輸出策略

這套「三位一體」系統將各司其職，最終匯流至四軌分數。

### 1. 三系統分工與權重 (Final Convergence)

* **西方占星 (40%)：** 負責心理需求與性格相性（Software）。
* **八字五行 (30%)：** 負責能量流動與權力傾斜（Energy）。
* **紫微斗數 (30%)：** 負責業力債務與防禦機制（Hardware）。

### 2. 最終 API Response 範例

此輸出包含四軌分數與「潛意識鏡像」的視覺導引。

```json
{
  "match_results": {
    "primary_track": "soul",
    "spiciness_level": "🔥 HIGH_VOLTAGE",
    "tracks": {
      "friend": 45.0, "passion": 82.5, "partner": 40.0, "soul": 95.0
    }
  },
  "subconscious_mirror": {
    "archetype_id": "WS_4_SWORDS",
    "visual_texture": "斑駁窗影、冷冽靜謐",
    "psychological_knot": "創傷後的避難與修復",
    "ui_script": "你們的相遇不是為了建設，而是為了在安靜的角落共同療癒。"
  },
  "defense_mechanisms": {
    "viewer_trigger": ["🛡️ 刺蝟防禦 (擎羊引動)"],
    "target_trigger": ["🌪️ 黑洞防禦 (陀羅引動)"]
  }
}

```

---


<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>DESTINY — Algorithm Validation Sandbox</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0a0a0f; color: #e0dff8; font-family: 'Courier New', monospace; font-size: 13px; padding: 20px; }
  h1 { color: #c084fc; font-size: 18px; margin-bottom: 4px; letter-spacing: 2px; }
  .subtitle { color: #6b7280; font-size: 11px; margin-bottom: 20px; }
  .tabs { display: flex; gap: 4px; margin-bottom: 16px; }
  .tab-btn { background: #1a1a2e; color: #9ca3af; border: 1px solid #374151; padding: 6px 16px; cursor: pointer; border-radius: 4px 4px 0 0; font-size: 12px; }
  .tab-btn.active { background: #2d1b4e; color: #c084fc; border-color: #7c3aed; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .person-card { background: #111827; border: 1px solid #374151; border-radius: 8px; padding: 14px; }
  .person-card h3 { color: #818cf8; font-size: 12px; margin-bottom: 10px; letter-spacing: 1px; }
  .field { margin-bottom: 8px; }
  .field label { display: block; color: #9ca3af; font-size: 11px; margin-bottom: 2px; }
  .field input, .field select { width: 100%; background: #1f2937; border: 1px solid #374151; color: #e0dff8; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: inherit; }
  .field input:focus, .field select:focus { outline: none; border-color: #7c3aed; }
  .lat-lng { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .threshold-row { background: #111827; border: 1px solid #374151; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
  .threshold-row h3 { color: #6b7280; font-size: 11px; margin-bottom: 8px; }
  .threshold-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .threshold-item label { color: #6b7280; font-size: 10px; display: block; margin-bottom: 2px; }
  .threshold-item input { width: 100%; background: #1f2937; border: 1px solid #374151; color: #e0dff8; padding: 3px 6px; border-radius: 4px; font-size: 11px; }
  .ground-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
  .ground-row label { color: #9ca3af; font-size: 12px; white-space: nowrap; }
  .ground-row select { background: #1f2937; border: 1px solid #374151; color: #e0dff8; padding: 6px 10px; border-radius: 4px; font-size: 12px; font-family: inherit; }
  .btn { background: #7c3aed; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: inherit; letter-spacing: 1px; }
  .btn:hover { background: #6d28d9; }
  .btn-sm { background: #1e3a5f; color: #93c5fd; border: 1px solid #1e40af; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-family: inherit; }
  .btn-sm:hover { background: #1e40af; }
  .btn-sm:disabled { opacity: 0.5; cursor: not-allowed; }
  .results { display: none; background: #111827; border: 1px solid #374151; border-radius: 8px; padding: 16px; margin-top: 16px; }
  .results.show { display: block; }
  .result-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid #374151; }
  .test-id { color: #6b7280; font-size: 11px; }
  .gt-label { color: #d1d5db; font-size: 12px; }
  .badge { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; letter-spacing: 1px; }
  .badge.match { background: #065f46; color: #6ee7b7; border: 1px solid #059669; }
  .badge.mismatch { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
  .score-section { margin-bottom: 12px; }
  .score-label { color: #a78bfa; font-size: 11px; margin-bottom: 4px; }
  .score-bar-wrap { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .score-bar { flex: 1; background: #374151; border-radius: 4px; height: 8px; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
  .score-val { color: #e0dff8; font-size: 13px; font-weight: bold; min-width: 50px; text-align: right; }
  .score-logs { color: #6b7280; font-size: 10px; line-height: 1.6; margin-top: 2px; }
  .tracks-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
  .track-item { text-align: center; }
  .track-name { color: #6b7280; font-size: 10px; margin-bottom: 3px; }
  .track-val { font-size: 14px; font-weight: bold; }
  .track-item.primary .track-name { color: #c084fc; }
  .track-item.primary .track-val { color: #c084fc; }
  .meta-row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; font-size: 11px; }
  .meta-item .meta-k { color: #6b7280; }
  .meta-item .meta-v { color: #d1d5db; margin-left: 4px; }
  .labels-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
  .label-tag { background: #1e1b4b; color: #a78bfa; border: 1px solid #4338ca; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
  .archetype-section { border-top: 1px solid #374151; padding-top: 12px; }
  .archetype-section h4 { color: #6b7280; font-size: 11px; margin-bottom: 8px; }
  .archetype-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
  .archetype-tag { background: #1f2d4a; color: #60a5fa; border: 1px solid #2563eb; padding: 2px 10px; border-radius: 10px; font-size: 11px; }
  .report-text { color: #d1d5db; font-size: 12px; line-height: 1.7; background: #0f172a; padding: 10px; border-radius: 6px; border-left: 3px solid #7c3aed; }
  .loading { color: #6b7280; font-size: 11px; font-style: italic; }
  .error-msg { color: #fca5a5; font-size: 11px; margin-top: 4px; }
  .mech-b-card { background: #111827; border: 1px solid #374151; border-radius: 8px; padding: 16px; max-width: 500px; }
  .mech-b-card h3 { color: #818cf8; font-size: 12px; margin-bottom: 12px; }
  .rect-log { margin-top: 16px; }
  .rect-step { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; padding: 8px; background: #0f172a; border-radius: 6px; }
  .rect-q { color: #d1d5db; font-size: 12px; flex: 1; }
  .rect-q .q-text { margin-bottom: 6px; }
  .rect-q .q-window { color: #6b7280; font-size: 10px; }
  .rect-q .q-conf { color: #a78bfa; font-size: 10px; }
  .answer-btns { display: flex; gap: 6px; margin-top: 6px; }
  .answer-btn { padding: 3px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 11px; font-family: inherit; }
  .answer-btn.yes { background: #064e3b; color: #6ee7b7; border: 1px solid #059669; }
  .answer-btn.no  { background: #450a0a; color: #fca5a5; border: 1px solid #dc2626; }
  .rect-result { margin-top: 14px; padding: 10px; border-radius: 6px; font-size: 12px; }
  .rect-result.pass { background: #065f46; color: #6ee7b7; border: 1px solid #059669; }
  .rect-result.fail { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
  .conf-bar-wrap { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .conf-label { color: #6b7280; font-size: 10px; min-width: 80px; }
  .conf-bar { flex: 1; background: #374151; border-radius: 4px; height: 6px; overflow: hidden; }
  .conf-bar-fill { height: 100%; background: linear-gradient(90deg, #7c3aed, #c084fc); border-radius: 4px; transition: width 0.4s; }
  .provider-row { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding: 8px 12px; background: #1a1a2e; border-radius: 6px; border: 1px solid #374151; }
  .provider-row label { color: #6b7280; font-size: 11px; white-space: nowrap; }
  .provider-row select { background: #1f2937; border: 1px solid #374151; color: #e0dff8; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: inherit; }
  .provider-row .provider-note { color: #4b5563; font-size: 10px; }
  .inferred-display { margin-top: 10px; padding: 8px; background: #0f172a; border-radius: 6px; border: 1px solid #1f2937; }
  .inferred-display .inf-title { color: #4b5563; font-size: 10px; margin-bottom: 6px; letter-spacing: 0.5px; }
  .inf-tag { display: inline-flex; align-items: center; gap: 3px; background: #1e1b4b; color: #a78bfa; border: 1px solid #4338ca; padding: 2px 7px; border-radius: 8px; font-size: 10px; margin: 2px; }
  .inf-tag.pending { color: #4b5563; border-color: #374151; background: #111827; font-style: italic; }
</style>
</head>
<body>

<h1>&#11041; DESTINY &#8212; Algorithm Validation Sandbox</h1>
<p class="subtitle">Internal tool &middot; Phase G matching algorithm validation &middot; Not for production</p>

<!-- Provider + API Key Row (shared across all LLM tabs) -->
<div class="provider-row" style="flex-wrap:wrap;gap:8px;align-items:center">
  <label>LLM Provider:</label>
  <select id="llmProvider" onchange="toggleApiKeyFields()" style="background:#1f2937;border:1px solid #374151;color:#e0dff8;padding:4px 8px;border-radius:4px;font-size:12px;font-family:inherit">
    <option value="anthropic">Anthropic (Claude Haiku)</option>
    <option value="gemini">Google Gemini</option>
  </select>
  <span id="anthropic-key-group" style="display:flex;align-items:center;gap:6px">
    <label style="white-space:nowrap;color:#6b7280;font-size:11px">API Key:</label>
    <input type="password" id="anthropicKey" placeholder="sk-ant-..." autocomplete="off"
      style="background:#0f172a;border:1px solid #374151;color:#9ca3af;padding:4px 8px;border-radius:4px;font-size:11px;font-family:monospace;width:230px">
  </span>
  <span id="gemini-key-group" style="display:none;align-items:center;gap:6px">
    <label style="white-space:nowrap;color:#6b7280;font-size:11px">API Key:</label>
    <input type="password" id="geminiKey" placeholder="AIza..." autocomplete="off"
      style="background:#0f172a;border:1px solid #374151;color:#9ca3af;padding:4px 8px;border-radius:4px;font-size:11px;font-family:monospace;width:230px">
    <label style="white-space:nowrap;color:#6b7280;font-size:11px;margin-left:8px">Model:</label>
    <input type="text" id="geminiModel" value="gemini-1.5-flash"
      style="background:#0f172a;border:1px solid #374151;color:#9ca3af;padding:4px 8px;border-radius:4px;font-size:11px;font-family:monospace;width:160px">
  </span>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('a')">A — 伴侶驗證</button>
  <button class="tab-btn" onclick="switchTab('b')">B — 校時模擬</button>
  <button class="tab-btn" onclick="switchTab('c')">C — 個人名片</button>
  <button class="tab-btn" onclick="switchTab('d')">D — 合盤報告</button>
</div>

<!-- ═══ TAB A ═══ -->
<div id="tab-a" class="tab-content active">

  <div class="two-col">
    <div class="person-card">
      <h3>PERSON A</h3>
      <div class="field"><label>&#39379;&#31034;&#21517;&#31281;</label><input type="text" id="a_name" value="Person A"></div>
      <div class="field"><label>&#20986;&#29983;&#26085;&#26399;</label><input type="date" id="a_birth_date" value="1990-03-15"></div>
      <div class="field"><label>&#20986;&#29983;&#26178;&#38291;&#65288;&#31291;&#30830;&#65292;&#21487;&#30041;&#31354;&#65289;</label><input type="time" id="a_birth_time_exact" value="14:30"></div>
      <div class="field lat-lng">
        <div><label>&#32302;&#24230;</label><input type="number" id="a_lat" value="25.033" step="0.001"></div>
        <div><label>&#32147;&#24230;</label><input type="number" id="a_lng" value="121.565" step="0.001"></div>
      </div>
      <div class="field"><label>Data Tier</label>
        <select id="a_data_tier">
          <option value="1" selected>Tier 1&#65288;&#31291;&#30830;&#20986;&#29983;&#26178;&#38291;&#65289;</option>
          <option value="2">Tier 2&#65288;&#27169;&#31958;&#26178;&#27573;&#65289;</option>
          <option value="3">Tier 3&#65288;&#21482;&#26377;&#26085;&#26399;&#65289;</option>
        </select>
      </div>
      <div class="inferred-display" id="a_inferred">
        <div class="inf-title">&#8594; RPV / &#20381;&#25200;&#39118;&#26684;&#65288;&#30001;&#21629;&#30424;&#33258;&#21160;&#25512;&#31639;&#65289;</div>
        <span class="inf-tag pending">&#31561;&#24453;&#36939;&#31639;...</span>
      </div>
    </div>

    <div class="person-card">
      <h3>PERSON B</h3>
      <div class="field"><label>&#39379;&#31034;&#21517;&#31281;</label><input type="text" id="b_name" value="Person B"></div>
      <div class="field"><label>&#20986;&#29983;&#26085;&#26399;</label><input type="date" id="b_birth_date" value="1992-08-22"></div>
      <div class="field"><label>&#20986;&#29983;&#26178;&#38291;&#65288;&#31291;&#30830;&#65292;&#21487;&#30041;&#31354;&#65289;</label><input type="time" id="b_birth_time_exact" value="09:15"></div>
      <div class="field lat-lng">
        <div><label>&#32302;&#24230;</label><input type="number" id="b_lat" value="25.033" step="0.001"></div>
        <div><label>&#32147;&#24230;</label><input type="number" id="b_lng" value="121.565" step="0.001"></div>
      </div>
      <div class="field"><label>Data Tier</label>
        <select id="b_data_tier">
          <option value="1" selected>Tier 1&#65288;&#31291;&#30830;&#20986;&#29983;&#26178;&#38291;&#65289;</option>
          <option value="2">Tier 2&#65288;&#27169;&#31958;&#26178;&#27573;&#65289;</option>
          <option value="3">Tier 3&#65288;&#21482;&#26377;&#26085;&#26399;&#65289;</option>
        </select>
      </div>
      <div class="inferred-display" id="b_inferred">
        <div class="inf-title">&#8594; RPV / &#20381;&#25200;&#39118;&#26684;&#65288;&#30001;&#21629;&#30424;&#33258;&#21160;&#25512;&#31639;&#65289;</div>
        <span class="inf-tag pending">&#31561;&#24453;&#36939;&#31639;...</span>
      </div>
    </div>
  </div>

  <div class="threshold-row">
    <h3>MATCH/MISMATCH &#38452;&#20540;&#65288;&#21487;&#35519;&#25972;&#65289;</h3>
    <div class="threshold-grid">
      <div class="threshold-item">
        <label>&#24050;&#23130;&#31281;&#31283;&#23450; min_soul</label>
        <input type="number" id="th_married_soul" value="65" min="0" max="100">
      </div>
      <div class="threshold-item">
        <label>&#24613;&#28218;&#20998;&#25163; max_avg</label>
        <input type="number" id="th_bad_avg" value="55" min="0" max="100">
      </div>
      <div class="threshold-item">
        <label>&#21644;&#24179;&#20998;&#25163; max_lust</label>
        <input type="number" id="th_ok_lust" value="60" min="0" max="100">
      </div>
      <div class="threshold-item">
        <label>&#22909;&#21451; max_lust</label>
        <input type="number" id="th_friend_lust" value="60" min="0" max="100">
      </div>
    </div>
  </div>

  <div class="ground-row">
    <label>Ground Truth:</label>
    <select id="ground_truth">
      <option value="married_stable">&#24050;&#23130;&#65288;&#31283;&#31283;&#65289;</option>
      <option value="divorced_ok">&#24050;&#20998;&#25163;&#65288;&#21644;&#24179;&#65289;</option>
      <option value="divorced_bad">&#24050;&#20998;&#25163;&#65288;&#24613;&#28218;&#65289;</option>
      <option value="friends">&#33613;&#24180;&#22909;&#21451;</option>
    </select>
    <button class="btn" onclick="runMatch()">&#9654; Run Match</button>
    <span id="run_status" class="loading"></span>
  </div>

  <div id="results-a" class="results"></div>

</div>

<!-- ═══ TAB B ═══ -->
<div id="tab-b" class="tab-content">
  <div class="mech-b-card">
    <h3>MECHANISM B &#8212; Birth Time Rectification Simulation</h3>
    <p style="color:#6b7280;font-size:11px;margin-bottom:12px;">&#36664;&#20837;&#19968;&#20491;&#24050;&#30693;&#30340;&#31291;&#30830;&#20986;&#29983;&#26178;&#38291;&#65292;&#27169;&#25511;&#30028;&#31995;&#32113;&#21482;&#30693;&#36947;&#12300;&#26178;&#27573;&#12301;&#26178;&#65292;&#32076;&#36942; Via Negativa &#21839;&#39064;&#24207;&#21015;&#33021;&#21542;&#23559;&#35996;&#21475;&#32553;&#23567;&#20006;&#28925;&#30410;&#21407;&#22987;&#26178;&#38291;&#12290;</p>
    <div class="field"><label>&#20986;&#29983;&#26085;&#26399;</label><input type="date" id="b2_date" value="1990-03-15"></div>
    <div class="field"><label>&#31291;&#30830;&#20986;&#29983;&#26178;&#38291;&#65288;Ground Truth&#65289;</label><input type="time" id="b2_precise" value="14:30"></div>
    <div style="margin-top:12px">
      <button class="btn" onclick="startRectSim()">&#9654; Simulate Rectification</button>
    </div>
    <div id="rect-log" class="rect-log"></div>
  </div>
</div>

<!-- ═══ TAB C ═══ -->
<div id="tab-c" class="tab-content">
  <div class="mech-b-card" style="max-width:480px">
    <h3>&#20491;&#20154;&#21517;&#29255;&#29983;&#25104;&#22120;</h3>
    <p style="color:#6b7280;font-size:11px;margin-bottom:12px">&#36749;&#20837;&#21934;&#20154;&#26143;&#31295;&#36039;&#26009;&#65292;&#29983;&#25104;&#20132;&#21451;&#36719;&#39636;&#39118;&#26684;&#30340;&#20491;&#20154;&#21517;&#29255;&#12290;</p>
    <div class="field"><label>&#20986;&#29983;&#26085;&#26399;</label><input type="date" id="pc_date" value="1990-03-15"></div>
    <div class="field"><label>&#20986;&#29983;&#26178;&#38291;&#65288;&#21487;&#30041;&#31354;&#65289;</label><input type="time" id="pc_time" value="14:30"></div>
    <div class="field lat-lng">
      <div><label>&#32302;&#24230;</label><input type="number" id="pc_lat" value="25.033" step="0.001"></div>
      <div><label>&#32147;&#24230;</label><input type="number" id="pc_lng" value="121.565" step="0.001"></div>
    </div>
    <div class="inferred-display" id="pc_inferred">
      <div class="inf-title">→ RPV / 依戀風格（由命盤自動推算）</div>
      <span class="inf-tag pending">等待運算...</span>
    </div>
    <div style="margin-top:12px">
      <button class="btn" onclick="generateProfileCard()">&#10022; &#29983;&#25104;&#20491;&#20154;&#21517;&#29255;</button>
      <span id="pc_status" class="loading" style="margin-left:8px"></span>
    </div>
    <div id="pc_output" style="margin-top:16px"></div>
    <div style="border-top:1px solid #374151;padding-top:12px;margin-top:14px">
      <button class="btn-sm" id="ideal-match-btn" onclick="generateIdealMatch()">&#10022; &#26368;&#20339;&#37197;&#23565;&#36684;&#24405;</button>
      <span id="ideal-match-status" class="loading" style="margin-left:8px"></span>
      <div id="ideal-match-output" style="margin-top:10px"></div>
    </div>
  </div>
</div><!-- end tab-c -->

<!-- ═══ TAB D ═══ -->
<div id="tab-d" class="tab-content">
  <div class="mech-b-card" style="max-width:560px">
    <h3>合盤報告生成器</h3>
    <p style="color:#6b7280;font-size:11px;margin-bottom:12px">
      先在「A — 伴侶驗證」跑完合盤，再回到此頁點「從上次合盤填入」生成完整關係報告。<br>
      或直接填入分數手動觸發。
    </p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <div class="field"><label>Person A &#21517;&#23383;</label><input type="text" id="mr_name_a" value="Person A"></div>
      <div class="field"><label>Person B &#21517;&#23383;</label><input type="text" id="mr_name_b" value="Person B"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <div class="field"><label>VibeScore (lust)</label><input type="number" id="mr_lust" value="75" min="0" max="100"></div>
      <div class="field"><label>ChemistryScore (soul)</label><input type="number" id="mr_soul" value="68" min="0" max="100"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px">
      <div class="field"><label>friend</label><input type="number" id="mr_friend" value="45" min="0" max="100"></div>
      <div class="field"><label>passion</label><input type="number" id="mr_passion" value="72" min="0" max="100"></div>
      <div class="field"><label>partner</label><input type="number" id="mr_partner" value="60" min="0" max="100"></div>
      <div class="field"><label>soul</label><input type="number" id="mr_soul_t" value="55" min="0" max="100"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:12px">
      <div class="field"><label>primary_track</label>
        <select id="mr_primary"><option>passion</option><option>partner</option><option>friend</option><option>soul</option></select>
      </div>
      <div class="field"><label>quadrant</label>
        <select id="mr_quad"><option>lover</option><option>soulmate</option><option>partner</option><option>colleague</option></select>
      </div>
      <div class="field"><label>RPV</label><input type="number" id="mr_rpv" value="25"></div>
      <div class="field"><label>模式</label>
        <select id="mr_mode"><option value="auto">auto</option><option value="abyss">abyss</option><option value="hunt">hunt</option><option value="nest">nest</option><option value="friend">friend</option></select>
      </div>
    </div>
    <div>
      <button class="btn" onclick="fillFromLastMatch()">&#8592; &#24478;&#19978;&#27425;&#21512;&#30424;&#22586;&#20837;</button>
      <button class="btn" style="margin-left:8px" onclick="generateMatchReport()">&#10022; &#29983;&#25104;&#21512;&#30424;&#22577;&#21578;</button>
      <span id="mr_status" class="loading" style="margin-left:8px"></span>
    </div>
    <div id="mr_output" style="margin-top:16px"></div>
  </div>
</div><!-- end tab-d -->

<script>
const BASE = 'http://localhost:8001';

// ── API key / model helpers ─────────────────────────────────────
function toggleApiKeyFields() {
  var provider = document.getElementById('llmProvider').value;
  var isGemini = provider === 'gemini';
  document.getElementById('anthropic-key-group').style.display = isGemini ? 'none' : 'flex';
  document.getElementById('gemini-key-group').style.display   = isGemini ? 'flex' : 'none';
}

function getApiKey() {
  var provider = document.getElementById('llmProvider').value;
  return provider === 'gemini'
    ? document.getElementById('geminiKey').value
    : document.getElementById('anthropicKey').value;
}

function getGeminiModel() {
  return document.getElementById('geminiModel').value || 'gemini-1.5-flash';
}

// ── RPV / Attachment inference from birth chart ───────────────
function inferFromChart(chart) {
  var FIRE  = ['aries','leo','sagittarius'];
  var WATER = ['cancer','scorpio','pisces'];
  var EARTH = ['taurus','virgo','capricorn'];
  var AIR   = ['gemini','libra','aquarius'];
  var FIXED = ['taurus','leo','scorpio','aquarius'];

  function elem(sign) {
    if (!sign) return 'unknown';
    if (FIRE.indexOf(sign)  >= 0) return 'fire';
    if (WATER.indexOf(sign) >= 0) return 'water';
    if (EARTH.indexOf(sign) >= 0) return 'earth';
    if (AIR.indexOf(sign)   >= 0) return 'air';
    return 'unknown';
  }

  var moon = chart.moon_sign        || '';
  var sun  = chart.sun_sign         || '';
  var mars = chart.mars_sign        || '';
  var asc  = chart.ascendant_sign   || '';
  var bazi = chart.bazi_element     || '';

  // Attachment from Moon element
  var moonElem = elem(moon);
  var attachment = (moonElem === 'water' || moonElem === 'fire') ? 'anxious'
                 : (moonElem === 'earth') ? 'avoidant'
                 : 'secure'; // air or unknown

  // rpv_conflict: fire sun or mars → argue, else cold_war
  var rpv_conflict = (FIRE.indexOf(sun) >= 0 || FIRE.indexOf(mars) >= 0) ? 'argue' : 'cold_war';

  // rpv_power: fixed sun OR wood/fire bazi → control, else follow
  var rpv_power = (FIXED.indexOf(sun) >= 0 || bazi === 'wood' || bazi === 'fire') ? 'control' : 'follow';

  // rpv_energy: fire/air ascendant or (if no asc) sun → out, else home
  var refSign = asc || sun;
  var rpv_energy = (FIRE.indexOf(refSign) >= 0 || AIR.indexOf(refSign) >= 0) ? 'out' : 'home';

  return { attachment_style: attachment, rpv_conflict: rpv_conflict, rpv_power: rpv_power, rpv_energy: rpv_energy };
}

function renderInferred(prefix, inferred, chart) {
  var el = document.getElementById(prefix + '_inferred');
  if (!el) return;
  var LABELS = {
    attachment_style: { anxious: '\u7126\u616e\u4f9d\u6200', avoidant: '\u8fc2\u907f\u4f9d\u6200', secure: '\u5b89\u5168\u4f9d\u6200' },
    rpv_conflict:     { argue: '\u958b\u5435\u578b', cold_war: '\u51b7\u6230\u578b' },
    rpv_power:        { control: '\u4e3b\u5c0e\u578b', follow: '\u8ddf\u96a8\u578b' },
    rpv_energy:       { out: '\u5916\u51fa\u578b', home: '\u5b85\u5bb6\u578b' },
  };
  var icons = { attachment_style: '\u2665', rpv_conflict: '\u26a1', rpv_power: '\u2696', rpv_energy: '\u2736' };
  var html = '<div class="inf-title">\u2192 RPV / \u4f9d\u6200\u98a8\u683c\uff08\u7531\u547d\u76e4\u81ea\u52d5\u63a8\u7b97\uff09</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:4px">';
  ['attachment_style','rpv_conflict','rpv_power','rpv_energy'].forEach(function(k) {
    var val = inferred[k];
    var label = (LABELS[k] && LABELS[k][val]) ? LABELS[k][val] : val;
    html += '<span class="inf-tag">' + icons[k] + ' ' + label + '</span>';
  });
  html += '</div>';
  if (chart) {
    html += '<div style="color:#374151;font-size:10px;margin-top:3px">';
    if (chart.moon_sign)      html += '\u6708\u4eae:' + chart.moon_sign + '\u3000';
    if (chart.sun_sign)       html += '\u592a\u967d:' + chart.sun_sign  + '\u3000';
    if (chart.mars_sign)      html += '\u706b\u661f:' + chart.mars_sign + '\u3000';
    if (chart.ascendant_sign) html += 'ASC:' + chart.ascendant_sign    + '\u3000';
    if (chart.bazi_element)   html += '\u65e5\u4e3b:' + chart.bazi_element;
    html += '</div>';
  }
  el.innerHTML = html;
}

const SIGNS = ["aries","taurus","gemini","cancer","leo","virgo",
               "libra","scorpio","sagittarius","capricorn","aquarius","pisces"];
const ASPECT_SCORES = {0:0.90, 1:0.65, 2:0.75, 3:0.50, 4:0.85, 5:0.65, 6:0.60};

function signAspect(a, b) {
  if (!a || !b) return 0.65;
  const ia = SIGNS.indexOf(a), ib = SIGNS.indexOf(b);
  if (ia < 0 || ib < 0) return 0.65;
  let d = Math.abs(ia - ib) % 12;
  if (d > 6) d = 12 - d;
  return ASPECT_SCORES[d] !== undefined ? ASPECT_SCORES[d] : 0.65;
}

function switchTab(id) {
  const ids = ['a','b','c','d'];
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', ids[i] === id));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
}

let testCounter = 1;
function genTestId() {
  const d = new Date();
  const s = d.toISOString().slice(0,10).replace(/-/g,'');
  return 'A-' + s + '-' + String(testCounter++).padStart(3,'0');
}

async function fetchChart(prefix) {
  const date = document.getElementById(prefix + '_birth_date').value;
  const time = document.getElementById(prefix + '_birth_time_exact').value;
  const lat  = parseFloat(document.getElementById(prefix + '_lat').value);
  const lng  = parseFloat(document.getElementById(prefix + '_lng').value);
  const tier = parseInt(document.getElementById(prefix + '_data_tier').value);

  const body = { birth_date: date, lat: lat, lng: lng, data_tier: tier };
  if (time) {
    body.birth_time_exact = time;
    body.birth_time = 'precise';
  }

  const r = await fetch(BASE + '/calculate-chart', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error('/calculate-chart failed: ' + await r.text());
  return r.json();
}

function getRpv(prefix) {
  var inferred = window['_inferred' + prefix.toUpperCase()] || {};
  return {
    rpv_conflict:     inferred.rpv_conflict     || 'cold_war',
    rpv_power:        inferred.rpv_power        || 'follow',
    rpv_energy:       inferred.rpv_energy       || 'home',
    attachment_style: inferred.attachment_style || 'secure',
    data_tier:        parseInt(document.getElementById(prefix + '_data_tier').value),
  };
}

function computeIsMatch(gt, lust, soul, primaryTrack) {
  const minSoul  = parseInt(document.getElementById('th_married_soul').value);
  const maxAvg   = parseInt(document.getElementById('th_bad_avg').value);
  const maxLust  = parseInt(document.getElementById('th_ok_lust').value);
  const maxFLust = parseInt(document.getElementById('th_friend_lust').value);

  if (gt === 'married_stable')
    return soul >= minSoul && (primaryTrack === 'partner' || primaryTrack === 'soul');
  if (gt === 'divorced_bad')
    return (lust + soul) / 2 <= maxAvg;
  if (gt === 'divorced_ok')
    return lust <= maxLust && soul < 65;
  if (gt === 'friends')
    return primaryTrack === 'friend' && lust <= maxFLust;
  return false;
}

const GT_LABELS = {
  married_stable: '\u5df2\u5a5a\uff08\u7a69\u5b9a\uff09',
  divorced_ok:    '\u5df2\u5206\u624b\uff08\u548c\u5e73\uff09',
  divorced_bad:   '\u5df2\u5206\u624b\uff08\u6158\u70c8\uff09',
  friends:        '\u842c\u5e74\u597d\u53cb',
};

function fmtScore(v) { return v.toFixed(2); }

function buildLogs(chartA, chartB) {
  const lustLogs = [
    'venus ' + fmtScore(signAspect(chartA.venus_sign, chartB.venus_sign)) + ' x0.20',
    'mars  ' + fmtScore(signAspect(chartA.mars_sign,  chartB.mars_sign))  + ' x0.25',
    'pluto ' + fmtScore(signAspect(chartA.pluto_sign, chartB.pluto_sign)) + ' x0.25',
    (chartA.house8_sign && chartB.house8_sign)
      ? 'house8 ' + fmtScore(signAspect(chartA.house8_sign, chartB.house8_sign)) + ' x0.15'
      : 'house8 N/A (no precise time)',
  ];
  const soulLogs = [
    'moon    ' + fmtScore(signAspect(chartA.moon_sign,    chartB.moon_sign))    + ' x0.25',
    'mercury ' + fmtScore(signAspect(chartA.mercury_sign, chartB.mercury_sign)) + ' x0.20',
    'saturn  ' + fmtScore(signAspect(chartA.saturn_sign,  chartB.saturn_sign))  + ' x0.20',
    (chartA.house4_sign && chartB.house4_sign)
      ? 'house4  ' + fmtScore(signAspect(chartA.house4_sign, chartB.house4_sign)) + ' x0.15'
      : 'house4  N/A (no precise time)',
    (chartA.juno_sign && chartB.juno_sign)
      ? 'juno    ' + fmtScore(signAspect(chartA.juno_sign, chartB.juno_sign)) + ' x0.20'
      : 'juno    N/A',
  ];
  return { lustLogs: lustLogs, soulLogs: soulLogs };
}

function renderResults(testId, gt, match, matchData, chartA, chartB, nameA, nameB) {
  var lust = matchData.lust_score;
  var soul = matchData.soul_score;
  var power = matchData.power;
  var tracks = matchData.tracks;
  var primary = matchData.primary_track;
  var quadrant = matchData.quadrant;
  var labels = matchData.labels;
  var psychTags = matchData.psychological_tags || [];
  var highVoltage = matchData.high_voltage || false;
  var logs = buildLogs(chartA, chartB);

  var trackColors = { friend: '#34d399', passion: '#f87171', partner: '#60a5fa', soul: '#c084fc' };
  var tracksHtml = ['friend','passion','partner','soul'].map(function(k) {
    var isPrimary = k === primary;
    var color = trackColors[k];
    return '<div class="track-item' + (isPrimary ? ' primary' : '') + '">' +
      '<div class="track-name">' + k + '</div>' +
      '<div class="track-val" style="color:' + color + '">' + tracks[k].toFixed(1) + '</div>' +
      '</div>';
  }).join('');

  var labelsHtml = labels.map(function(l) {
    return '<span class="label-tag">' + l + '</span>';
  }).join('');

  var container = document.getElementById('results-a');
  container.className = 'results show';
  container.innerHTML =
    '<div class="result-header">' +
      '<span class="test-id">' + testId + '</span>' +
      '<span class="gt-label">' + GT_LABELS[gt] + '</span>' +
      '<span class="badge ' + (match ? 'match' : 'mismatch') + '">' + (match ? 'MATCH \u2713' : 'MISMATCH \u2717') + '</span>' +
    '</div>' +
    '<div class="score-section">' +
      '<div class="score-label">VibeScore（肉體吸引力）</div>' +
      '<div class="score-bar-wrap">' +
        '<div class="score-bar"><div class="score-bar-fill" style="width:' + lust + '%;background:linear-gradient(90deg,#f87171,#fb923c)"></div></div>' +
        '<div class="score-val" style="color:#f87171">' + lust.toFixed(1) + ' / 100</div>' +
      '</div>' +
      '<div class="score-logs">' + logs.lustLogs.join('<br>') + '</div>' +
    '</div>' +
    '<div class="score-section">' +
      '<div class="score-label">ChemistryScore（靈魂連結）</div>' +
      '<div class="score-bar-wrap">' +
        '<div class="score-bar"><div class="score-bar-fill" style="width:' + soul + '%;background:linear-gradient(90deg,#818cf8,#c084fc)"></div></div>' +
        '<div class="score-val" style="color:#818cf8">' + soul.toFixed(1) + ' / 100</div>' +
      '</div>' +
      '<div class="score-logs">' + logs.soulLogs.join('<br>') + '</div>' +
    '</div>' +
    '<div class="score-section">' +
      '<div class="score-label" style="margin-bottom:6px">四軌分數</div>' +
      '<div class="tracks-row">' + tracksHtml + '</div>' +
    '</div>' +
    '<div class="meta-row">' +
      '<div class="meta-item"><span class="meta-k">primary_track</span><span class="meta-v" style="color:#c084fc">' + primary + '</span></div>' +
      '<div class="meta-item"><span class="meta-k">quadrant</span><span class="meta-v">' + quadrant + '</span></div>' +
      '<div class="meta-item"><span class="meta-k">RPV</span><span class="meta-v">' + (power.rpv > 0 ? '+' : '') + power.rpv + '</span></div>' +
      '<div class="meta-item"><span class="meta-k">' + nameA + '</span><span class="meta-v">' + power.viewer_role + '</span></div>' +
      '<div class="meta-item"><span class="meta-k">' + nameB + '</span><span class="meta-v">' + power.target_role + '</span></div>' +
      '<div class="meta-item"><span class="meta-k">frame_break</span><span class="meta-v" style="color:' + (power.frame_break ? '#f87171' : '#34d399') + '">' + power.frame_break + '</span></div>' +
    '</div>' +
    '<div class="labels-row">' + labelsHtml + '</div>' +
    '<div class="meta-row" style="margin-bottom:8px;padding-top:6px;border-top:1px solid #1f2937">' +
      '<div class="meta-item"><span class="meta-k" style="color:#a78bfa">心理標籤</span><span class="meta-v" style="color:#c084fc">' +
        (psychTags.length > 0 ? psychTags.join(', ') : '—') +
      '</span></div>' +
      '<div class="meta-item"><span class="meta-k" style="color:#a78bfa">high_voltage (psych)</span>' +
        '<span class="meta-v" style="color:' + (highVoltage ? '#f87171' : '#4b5563') + ';font-weight:' + (highVoltage ? 'bold' : 'normal') + '">' +
          (highVoltage ? '⚡ true' : 'false') +
        '</span></div>' +
    '</div>' +
    '<div class="archetype-section">' +
      '<h4>AI 原型標籤 + 解讀報告</h4>' +
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">' +
        '<select id="archetype-mode" style="background:#1f2937;border:1px solid #374151;color:#e0dff8;padding:4px 8px;border-radius:4px;font-size:12px;font-family:inherit">' +
          '<option value="auto">auto（系統自動）</option>' +
          '<option value="abyss">abyss（靈魂/修羅）</option>' +
          '<option value="hunt">hunt（激情/狩獵）</option>' +
          '<option value="nest">nest（伴侶/築巢）</option>' +
          '<option value="friend">friend（朋友/默契）</option>' +
        '</select>' +
        '<button class="btn-sm" id="archetype-btn" onclick="generateArchetype()">&#10022; Generate</button>' +
      '</div>' +
      '<div id="archetype-output" style="margin-top:8px"></div>' +
    '</div>' +
    '<div style="border-top:1px solid #374151;padding-top:12px;margin-top:14px">' +
      '<div style="color:#6b7280;font-size:11px;margin-bottom:8px">個人解析</div>' +
      '<div style="display:flex;gap:8px;margin-bottom:10px">' +
        '<button class="btn-sm" id="profile-btn-a" onclick="generatePersonProfile(\'a\')">&#10022; A 個人解析</button>' +
        '<button class="btn-sm" id="profile-btn-b" onclick="generatePersonProfile(\'b\')">&#10022; B 個人解析</button>' +
        '<span id="profile-status" class="loading" style="margin-left:4px"></span>' +
      '</div>' +
      '<div id="tab-a-profile-result"></div>' +
    '</div>';

  window._lastMatchData = matchData;
  window._lastNameA = nameA;
  window._lastNameB = nameB;
  window._lastChartA = chartA;
  window._lastChartB = chartB;
}

async function runMatch() {
  var status = document.getElementById('run_status');
  status.textContent = '\u8a08\u7b97\u4e2d...';
  try {
    var results = await Promise.all([fetchChart('a'), fetchChart('b')]);
    var chartA = results[0];
    var chartB = results[1];
    var nameA = document.getElementById('a_name').value || 'A';
    var nameB = document.getElementById('b_name').value || 'B';

    // Infer RPV + attachment from charts and display
    window._inferredA = inferFromChart(chartA);
    window._inferredB = inferFromChart(chartB);
    renderInferred('a', window._inferredA, chartA);
    renderInferred('b', window._inferredB, chartB);

    var userA = Object.assign({}, chartA, getRpv('a'));
    var userB = Object.assign({}, chartB, getRpv('b'));

    var r = await fetch(BASE + '/compute-match', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ user_a: userA, user_b: userB })
    });
    if (!r.ok) throw new Error('/compute-match failed: ' + await r.text());
    var matchData = await r.json();

    var gt = document.getElementById('ground_truth').value;
    var testId = genTestId();
    var match = computeIsMatch(gt, matchData.lust_score, matchData.soul_score, matchData.primary_track);

    renderResults(testId, gt, match, matchData, chartA, chartB, nameA, nameB);
    status.textContent = '';
  } catch(e) {
    status.textContent = '';
    var container = document.getElementById('results-a');
    container.className = 'results show';
    var errDiv = document.createElement('div');
    errDiv.className = 'error-msg';
    errDiv.textContent = 'Error: ' + e.message;
    container.innerHTML = '';
    container.appendChild(errDiv);
  }
}

async function generateArchetype() {
  var btn = document.getElementById('archetype-btn');
  var out = document.getElementById('archetype-output');
  if (!window._lastMatchData) return;
  btn.disabled = true;
  var provider = document.getElementById('llmProvider').value;
  out.innerHTML = '<div class="loading">\u547c\u53eb ' + (provider === 'gemini' ? 'Gemini' : 'Claude') + ' API...</div>';

  var mode = document.getElementById('archetype-mode') ? document.getElementById('archetype-mode').value : 'auto';

  try {
    var r = await fetch(BASE + '/generate-archetype', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        match_data: window._lastMatchData,
        person_a_name: window._lastNameA || 'A',
        person_b_name: window._lastNameB || 'B',
        mode: mode,
        provider: provider,
        api_key: getApiKey(),
        gemini_model: getGeminiModel(),
      })
    });
    if (!r.ok) { var e = await r.json(); throw new Error(e.detail || r.statusText); }
    var data = await r.json();
    var tagsHtml = (data.archetype_tags || []).map(function(t) {
      return '<span class="archetype-tag">' + t + '</span>';
    }).join('');
    var realityHtml = (data.reality_check || []).map(function(s) {
      return '<li style="color:#fca5a5;font-size:12px;line-height:1.8">' + s + '</li>';
    }).join('');
    var evolutionHtml = (data.evolution || []).map(function(s) {
      return '<li style="color:#6ee7b7;font-size:12px;line-height:1.8">' + s + '</li>';
    }).join('');
    var effectiveMode = data.effective_mode ? ' <span style="color:#6b7280;font-size:10px">(' + data.effective_mode + ')</span>' : '';
    out.innerHTML =
      '<div class="archetype-tags" style="margin-bottom:10px">' + tagsHtml + effectiveMode + '</div>' +
      '<div style="background:#0f172a;border:1px solid #7c3aed;border-radius:10px;padding:14px">' +
        (data.resonance ? '<div style="margin-bottom:10px"><div style="color:#a78bfa;font-size:10px;margin-bottom:3px">一、共振</div><div class="report-text">' + data.resonance + '</div></div>' : '') +
        (data.shadow    ? '<div style="margin-bottom:10px"><div style="color:#a78bfa;font-size:10px;margin-bottom:3px">二、陰影</div><div class="report-text">' + data.shadow + '</div></div>' : '') +
        (realityHtml    ? '<div style="margin-bottom:10px"><div style="color:#f87171;font-size:10px;margin-bottom:3px">三、會痛的關卡</div><ul style="list-style:none;padding:0">' + realityHtml + '</ul></div>' : '') +
        (evolutionHtml  ? '<div style="margin-bottom:10px"><div style="color:#34d399;font-size:10px;margin-bottom:3px">四、進化心法</div><ul style="list-style:none;padding:0">' + evolutionHtml + '</ul></div>' : '') +
        (data.core      ? '<div style="border-top:1px solid #374151;padding-top:10px;font-style:italic;color:#c084fc;font-size:12px">' + data.core + '</div>' : '') +
      '</div>';
  } catch(e) {
    var errDiv = document.createElement('div');
    errDiv.className = 'error-msg';
    errDiv.textContent = 'Error: ' + e.message;
    out.innerHTML = '';
    out.appendChild(errDiv);
  }
  btn.disabled = false;
}

// ── Mechanism B ──────────────────────────────────────────────
var VIA_NEGATIVA_QUESTIONS = [
  '\u4f60\u4e0d\u662f\u90a3\u7a2e\u559c\u6b61\u5728\u4eba\u7fa4\u4e2d\u6210\u70ba\u7126\u9ede\u7684\u4eba',
  '\u4f60\u4e0d\u662f\u65e9\u8d77\u578b\u7684\u4eba\uff0c\u6bd4\u8d77\u65e9\u6668\u66f4\u559c\u6b61\u591c\u6652\u7684\u80fd\u91cf',
  '\u4f60\u4e0d\u662f\u5929\u751f\u7684\u8a08\u5283\u578b\uff0c\u50be\u5411\u5373\u8208\u800c\u975e\u6309\u8868\u64cd\u8ab2',
  '\u4f60\u9762\u5c0d\u885d\u7a81\u6642\uff0c\u4e0d\u6703\u9078\u64c7\u6c89\u9ed8\u8fc2\u907f\uff0c\u50be\u5411\u76f4\u63a5\u8aaa\u51fa\u4f86',
  '\u4f60\u4e0d\u662f\u5929\u751f\u7684\u9818\u8896\u578b\uff0c\u66f4\u4eab\u53d7\u8f14\u52a9\u8207\u914d\u5408\u4ed6\u4eba\u7684\u89d2\u8272',
];

var rectState = null;

function slotCenter(h) {
  if (h >= 4  && h < 12) return { name: 'morning',   center: 8 * 60 };
  if (h >= 12 && h < 18) return { name: 'afternoon',  center: 15 * 60 };
  return { name: 'evening', center: 21 * 60 };
}

function minutesToHHMM(mins) {
  var m = ((mins % 1440) + 1440) % 1440;
  var h = Math.floor(m / 60);
  var mn = Math.floor(m % 60);
  return String(h).padStart(2,'0') + ':' + String(mn).padStart(2,'0');
}

function startRectSim() {
  var preciseTime = document.getElementById('b2_precise').value;
  if (!preciseTime) { alert('\u8acb\u8f38\u5165\u7cbe\u78ba\u51fa\u751f\u6642\u9593'); return; }
  var parts = preciseTime.split(':');
  var hh = parseInt(parts[0]);
  var mm = parseInt(parts[1]);
  var preciseMinutes = hh * 60 + mm;
  var slot = slotCenter(hh);
  var initialWindow = 360;

  rectState = {
    preciseMinutes: preciseMinutes,
    center: slot.center,
    halfWindow: initialWindow / 2,
    confidence: 0.15,
    questionIdx: 0,
  };

  var logEl = document.getElementById('rect-log');
  logEl.innerHTML =
    '<div style="margin-bottom:10px;font-size:11px;color:#9ca3af">' +
      '\u7cbe\u78ba\u6642\u9593: <b style="color:#e0dff8">' + preciseTime + '</b> \u2192 ' +
      '\u6642\u6bb5: <b style="color:#c084fc">' + slot.name + '</b> \u2192 ' +
      '\u521d\u59cb\u8996\u7a97: <b style="color:#e0dff8">' +
        minutesToHHMM(slot.center - rectState.halfWindow) + ' ~ ' +
        minutesToHHMM(slot.center + rectState.halfWindow) +
      '</b> (' + initialWindow + ' \u5206\u9418)' +
    '</div>' +
    '<div class="conf-bar-wrap">' +
      '<span class="conf-label" id="conf-label-text">Confidence: 0.15</span>' +
      '<div class="conf-bar"><div class="conf-bar-fill" id="conf-fill" style="width:15%"></div></div>' +
    '</div>' +
    '<div id="rect-questions" style="margin-top:12px"></div>' +
    '<div id="rect-final"></div>';

  showNextQuestion();
}

function showNextQuestion() {
  if (!rectState) return;
  if (rectState.questionIdx >= VIA_NEGATIVA_QUESTIONS.length) {
    showRectResult();
    return;
  }
  var q = VIA_NEGATIVA_QUESTIONS[rectState.questionIdx];
  var qContainer = document.getElementById('rect-questions');
  var stepEl = document.createElement('div');
  stepEl.className = 'rect-step';
  stepEl.id = 'q-step-' + rectState.questionIdx;
  stepEl.innerHTML =
    '<div class="rect-q">' +
      '<div class="q-text">Q' + (rectState.questionIdx + 1) + ': ' + q + '</div>' +
      '<div class="answer-btns">' +
        '<button class="answer-btn yes" onclick="answerQ(true,' + rectState.questionIdx + ')">\u2713 \u662f\u7684\uff0c\u6211\u4e0d\u662f</button>' +
        '<button class="answer-btn no"  onclick="answerQ(false,' + rectState.questionIdx + ')">\u2717 \u4e0d\u5c0d\uff0c\u6211\u662f</button>' +
      '</div>' +
    '</div>';
  qContainer.appendChild(stepEl);
}

function answerQ(isVN, qIdx) {
  if (!rectState || rectState.questionIdx !== qIdx) return;

  var stepEl = document.getElementById('q-step-' + qIdx);
  stepEl.querySelectorAll('.answer-btn').forEach(function(b) { b.disabled = true; });

  var reduction = 60;
  rectState.halfWindow = Math.max(30, rectState.halfWindow - reduction / 2);
  rectState.center = isVN ? rectState.center + 15 : rectState.center - 15;
  rectState.confidence = Math.min(0.95, rectState.confidence + 0.10);
  rectState.questionIdx++;

  var ws = minutesToHHMM(rectState.center - rectState.halfWindow);
  var we = minutesToHHMM(rectState.center + rectState.halfWindow);
  var qDiv = stepEl.querySelector('.rect-q');
  qDiv.innerHTML =
    '<div class="q-text">Q' + (qIdx + 1) + ': ' + VIA_NEGATIVA_QUESTIONS[qIdx] +
      ' <span style="color:' + (isVN ? '#6ee7b7' : '#fca5a5') + '">' +
        (isVN ? '\u2713 \u662f\u7684\uff0c\u6211\u4e0d\u662f' : '\u2717 \u4e0d\u5c0d\uff0c\u6211\u662f') +
      '</span></div>' +
    '<div class="q-window">\u8996\u7a97\u7e2e\u5c0f\u81f3: ' + ws + ' ~ ' + we +
      ' (' + Math.round(rectState.halfWindow * 2) + ' \u5206\u9418)</div>' +
    '<div class="q-conf">Confidence: ' + rectState.confidence.toFixed(2) + '</div>';

  var confFill = document.getElementById('conf-fill');
  if (confFill) confFill.style.width = (rectState.confidence * 100) + '%';
  var confLabel = document.getElementById('conf-label-text');
  if (confLabel) confLabel.textContent = 'Confidence: ' + rectState.confidence.toFixed(2);

  showNextQuestion();
}

function showRectResult() {
  if (!rectState) return;
  var p = rectState.preciseMinutes;
  var ws = rectState.center - rectState.halfWindow;
  var we = rectState.center + rectState.halfWindow;
  var isWithin = p >= ws && p <= we;

  var finalEl = document.getElementById('rect-final');
  finalEl.innerHTML =
    '<div class="rect-result ' + (isWithin ? 'pass' : 'fail') + '" style="margin-top:16px">' +
      '<div style="font-weight:bold;margin-bottom:6px">' +
        (isWithin ? '\u2705 PASS \u2014 \u6821\u6642\u6a21\u64ec\u6210\u529f' : '\u274c FAIL \u2014 \u771f\u5be6\u6642\u9593\u843d\u5728\u8996\u7a97\u5916') +
      '</div>' +
      '<div>\u6700\u7d42\u8996\u7a97: ' + minutesToHHMM(ws) + ' ~ ' + minutesToHHMM(we) +
        ' (' + Math.round(rectState.halfWindow * 2) + ' \u5206\u9418)</div>' +
      '<div>Ground Truth: ' + minutesToHHMM(p) + '</div>' +
      '<div>\u6700\u7d42 Confidence: ' + rectState.confidence.toFixed(2) + '</div>' +
      (isWithin
        ? '<div style="margin-top:4px;font-size:10px">\u7cbe\u78ba\u6642\u9593\u5728\u8996\u7a97\u5167\u3002</div>'
        : '<div style="margin-top:4px;font-size:10px">\u5efa\u8b70\uff1a\u6aa2\u67e5\u554f\u984c\u8a2d\u8a08\u6216\u8abf\u6574\u8996\u7a97\u7e2e\u5c0f\u7b56\u7565\u3002</div>') +
    '</div>';
}

// ── Shared profile card renderer ────────────────────────────
function renderProfileCard(data, label, targetId) {
  var target = document.getElementById(targetId);
  if (!target) return;
  var avoidHtml = (data.avoid_types || []).map(function(t) {
    return '<span class="label-tag" style="background:#7f1d1d;border-color:#dc2626;color:#fca5a5">' + t + '</span>';
  }).join('');
  var evolutionHtml = (data.evolution || []).map(function(s) {
    return '<li style="color:#6ee7b7;font-size:12px;line-height:1.8">' + s + '</li>';
  }).join('');
  target.innerHTML =
    (label ? '<div style="color:#6b7280;font-size:11px;margin-bottom:8px;letter-spacing:0.5px">' + label + '</div>' : '') +
    '<div style="background:#0f172a;border:1px solid #7c3aed;border-radius:10px;padding:16px">' +
      '<div style="color:#c084fc;font-size:16px;font-weight:bold;margin-bottom:10px">' + (data.headline || '') + '</div>' +
      (data.shadow_trait ? '<div style="margin-bottom:10px"><div style="color:#a78bfa;font-size:10px;margin-bottom:3px">迷人的反派特質</div><div class="report-text">\uD83C\uDF11 ' + data.shadow_trait + '</div></div>' : '') +
      (avoidHtml ? '<div style="margin-bottom:10px"><div style="color:#f87171;font-size:10px;margin-bottom:4px">絕對要避開的對象類型</div><div>' + avoidHtml + '</div></div>' : '') +
      (evolutionHtml ? '<div style="margin-bottom:10px"><div style="color:#34d399;font-size:10px;margin-bottom:3px">破局心法</div><ul style="list-style:none;padding:0">' + evolutionHtml + '</ul></div>' : '') +
      (data.core ? '<div style="border-top:1px solid #374151;padding-top:10px;font-style:italic;color:#c084fc;font-size:12px">' + data.core + '</div>' : '') +
    '</div>';
}

async function generatePersonProfile(person) {
  var chart = person === 'a' ? window._lastChartA : window._lastChartB;
  if (!chart) { alert('\u8acb\u5148\u57f7\u884c\u300c Run Match \u300d\u4ee5\u7372\u53d6\u661f\u76e4\u8cc7\u6599'); return; }

  var btnId = 'profile-btn-' + person;
  var btn = document.getElementById(btnId);
  var status = document.getElementById('profile-status');
  var target = document.getElementById('tab-a-profile-result');

  btn.disabled = true;
  var otherBtnId = person === 'a' ? 'profile-btn-b' : 'profile-btn-a';
  var otherBtn = document.getElementById(otherBtnId);
  if (otherBtn) otherBtn.disabled = true;

  var savedText = btn.textContent;
  btn.textContent = '\u5206\u6790\u4e2d\u2026';
  status.textContent = '';
  target.innerHTML = '';

  var provider = document.getElementById('llmProvider').value;

  try {
    var r = await fetch(BASE + '/generate-profile-card', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        chart_data: chart,
        rpv_data: null,
        attachment_style: null,
        provider: provider,
        api_key: getApiKey(),
        gemini_model: getGeminiModel(),
      })
    });
    if (!r.ok) { var e = await r.json(); throw new Error(e.detail || r.statusText); }
    var data = await r.json();
    var nameA = window._lastNameA || 'A';
    var nameB = window._lastNameB || 'B';
    var label = person === 'a'
      ? '\u3010' + nameA + ' \u7684\u500b\u4eba\u89e3\u6790\u3011'
      : '\u3010' + nameB + ' \u7684\u500b\u4eba\u89e3\u6790\u3011';
    renderProfileCard(data, label, 'tab-a-profile-result');
  } catch(err) {
    var errDiv = document.createElement('div');
    errDiv.className = 'error-msg';
    errDiv.textContent = 'Error: ' + err.message;
    target.innerHTML = '';
    target.appendChild(errDiv);
  }

  btn.textContent = savedText;
  btn.disabled = false;
  if (otherBtn) otherBtn.disabled = false;
  status.textContent = '';
}

async function generateProfileCard() {
  var status = document.getElementById('pc_status');
  var out = document.getElementById('pc_output');
  status.textContent = '\u8a08\u7b97\u661f\u76e4\u4e2d...';
  out.innerHTML = '';

  try {
    var date = document.getElementById('pc_date').value;
    var time = document.getElementById('pc_time').value;
    var lat  = parseFloat(document.getElementById('pc_lat').value);
    var lng  = parseFloat(document.getElementById('pc_lng').value);

    var chartBody = { birth_date: date, lat: lat, lng: lng, data_tier: time ? 1 : 3 };
    if (time) { chartBody.birth_time_exact = time; chartBody.birth_time = 'precise'; }

    var cr = await fetch(BASE + '/calculate-chart', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(chartBody)
    });
    if (!cr.ok) throw new Error(await cr.text());
    var chart = await cr.json();

    var inferred = inferFromChart(chart);
    renderInferred('pc', inferred, chart);
    window._lastProfileChart = chart;

    var provider = document.getElementById('llmProvider').value;
    status.textContent = '生成名片中 (' + provider + ')...';

    var r = await fetch(BASE + '/generate-profile-card', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        chart_data: chart,
        rpv_data: {
          rpv_conflict: inferred.rpv_conflict,
          rpv_power:    inferred.rpv_power,
          rpv_energy:   inferred.rpv_energy,
        },
        attachment_style: inferred.attachment_style,
        provider: provider,
        api_key: getApiKey(),
        gemini_model: getGeminiModel(),
      })
    });
    if (!r.ok) { var e2 = await r.json(); throw new Error(e2.detail || r.statusText); }
    var data = await r.json();

    renderProfileCard(data, null, 'pc_output');
    status.textContent = '';
  } catch(err) {
    var errDiv = document.createElement('div');
    errDiv.className = 'error-msg';
    errDiv.textContent = 'Error: ' + err.message;
    out.innerHTML = '';
    out.appendChild(errDiv);
    status.textContent = '';
  }
}

async function generateIdealMatch() {
  var btn = document.getElementById('ideal-match-btn');
  var status = document.getElementById('ideal-match-status');
  var out = document.getElementById('ideal-match-output');

  if (!window._lastProfileChart) {
    alert('\u8acb\u5148\u9ede\u300c\u751f\u6210\u500b\u4eba\u540d\u7247\u300d\u4ee5\u7372\u53d6\u661f\u76e4\u8cc7\u6599');
    return;
  }

  btn.disabled = true;
  var savedText = btn.textContent;
  btn.textContent = '\u5206\u6790\u4e2d\u2026';
  status.textContent = '';
  out.innerHTML = '';

  var provider = document.getElementById('llmProvider').value;

  try {
    var r = await fetch(BASE + '/generate-ideal-match', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        chart_data: window._lastProfileChart,
        provider: provider,
        api_key: getApiKey(),
        gemini_model: getGeminiModel(),
      })
    });
    if (!r.ok) { var e = await r.json(); throw new Error(e.detail || r.statusText); }
    var data = await r.json();

    var html = '<div style="background:#0f172a;border:1px solid #374151;border-radius:8px;padding:14px;font-size:12px">';
    html += '<div style="color:#c084fc;font-weight:bold;font-size:13px;margin-bottom:10px">\u6700\u4f73\u914d\u5c0d\u8f2a\u5ed3</div>';
    if (data.antidote) {
      html += '<div style="color:#6b7280;font-size:11px;margin-bottom:2px">\u3010\u89e3\u85e5\u3011</div>';
      html += '<div style="color:#e2e8f0;line-height:1.6;margin-bottom:10px">' + data.antidote + '</div>';
    }
    if (data.reality_anchors && data.reality_anchors.length) {
      html += '<div style="color:#6b7280;font-size:11px;margin-bottom:6px">\u3010\u73fe\u5be6\u63a5\u4f4f\u4f60\u7684\u4eba\u3011</div>';
      html += '<ul style="list-style:none;padding:0;margin:0 0 10px 0">';
      data.reality_anchors.forEach(function(a) {
        html += '<li style="color:#6ee7b7;padding:2px 0">' + a + '</li>';
      });
      html += '</ul>';
    }
    if (data.core_need) {
      html += '<div style="color:#6b7280;font-size:11px;margin-bottom:2px">\u3010\u6838\u5fc3\u6e34\u671b\u3011</div>';
      html += '<div style="color:#e2e8f0;font-style:italic">' + data.core_need + '</div>';
    }
    html += '</div>';
    out.innerHTML = html;
  } catch(err) {
    var errDiv = document.createElement('div');
    errDiv.className = 'error-msg';
    errDiv.textContent = 'Error: ' + err.message;
    out.innerHTML = '';
    out.appendChild(errDiv);
  }

  btn.textContent = savedText;
  btn.disabled = false;
}

function fillFromLastMatch() {
  if (!window._lastMatchData) { alert('請先在「A — 伴侶驗證」跑完合盤'); return; }
  var md = window._lastMatchData;
  document.getElementById('mr_lust').value    = md.lust_score.toFixed(0);
  document.getElementById('mr_soul').value    = md.soul_score.toFixed(0);
  document.getElementById('mr_friend').value  = md.tracks.friend.toFixed(0);
  document.getElementById('mr_passion').value = md.tracks.passion.toFixed(0);
  document.getElementById('mr_partner').value = md.tracks.partner.toFixed(0);
  document.getElementById('mr_soul_t').value  = md.tracks.soul.toFixed(0);
  document.getElementById('mr_rpv').value     = md.power.rpv;
  document.getElementById('mr_primary').value = md.primary_track;
  document.getElementById('mr_quad').value    = md.quadrant;
  document.getElementById('mr_name_a').value  = window._lastNameA || 'A';
  document.getElementById('mr_name_b').value  = window._lastNameB || 'B';
}

async function generateMatchReport() {
  var status = document.getElementById('mr_status');
  var out    = document.getElementById('mr_output');
  status.textContent = '\u751f\u6210\u5831\u544a\u4e2d...';
  out.innerHTML = '';

  var matchData = {
    lust_score:    parseFloat(document.getElementById('mr_lust').value),
    soul_score:    parseFloat(document.getElementById('mr_soul').value),
    primary_track: document.getElementById('mr_primary').value,
    quadrant:      document.getElementById('mr_quad').value,
    labels:        [],
    tracks: {
      friend:  parseFloat(document.getElementById('mr_friend').value),
      passion: parseFloat(document.getElementById('mr_passion').value),
      partner: parseFloat(document.getElementById('mr_partner').value),
      soul:    parseFloat(document.getElementById('mr_soul_t').value),
    },
    power: {
      rpv: parseFloat(document.getElementById('mr_rpv').value),
      frame_break: false,
      viewer_role: 'Equal', target_role: 'Equal',
    },
  };
  if (window._lastMatchData) {
    matchData.labels             = window._lastMatchData.labels             || [];
    matchData.power              = window._lastMatchData.power              || matchData.power;
    matchData.psychological_tags = window._lastMatchData.psychological_tags || [];
    matchData.high_voltage       = window._lastMatchData.high_voltage       || false;
    matchData.zwds               = window._lastMatchData.zwds               || null;
  }

  try {
    var provider = document.getElementById('llmProvider').value;
    var mrMode = document.getElementById('mr_mode') ? document.getElementById('mr_mode').value : 'auto';
    var r = await fetch(BASE + '/generate-match-report', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        match_data: matchData,
        person_a_name: document.getElementById('mr_name_a').value,
        person_b_name: document.getElementById('mr_name_b').value,
        mode: mrMode,
        provider: provider,
        api_key: getApiKey(),
        gemini_model: getGeminiModel(),
      })
    });
    if (!r.ok) { var e = await r.json(); throw new Error(e.detail || r.statusText); }
    var data = await r.json();

    var sparksHtml    = (data.sparks    || []).map(function(s) { return '<li style="color:#6ee7b7">&#10022; ' + s + '</li>'; }).join('');
    var landminesHtml = (data.landmines || []).map(function(s) { return '<li style="color:#fca5a5">&#9889; ' + s + '</li>'; }).join('');

    out.innerHTML =
      '<div style="background:#0f172a;border:1px solid #7c3aed;border-radius:10px;padding:16px">' +
        '<div style="color:#c084fc;font-size:15px;font-weight:bold;margin-bottom:12px">' + (data.title || '') + '</div>' +
        '<div style="font-style:italic;color:#a78bfa;font-size:12px;margin-bottom:14px;padding:8px;background:#1e1b4b;border-radius:6px">&ldquo;' + (data.one_liner || '') + '&rdquo;</div>' +
        '<div style="margin-bottom:10px">' +
          '<div style="color:#34d399;font-size:11px;margin-bottom:4px">&#10022; \u9583\u5149\u9ede</div>' +
          '<ul style="list-style:none;font-size:12px;line-height:2">' + sparksHtml + '</ul>' +
        '</div>' +
        '<div style="margin-bottom:10px">' +
          '<div style="color:#f87171;font-size:11px;margin-bottom:4px">&#9889; \u6210\u9577\u8ab2\u984c</div>' +
          '<ul style="list-style:none;font-size:12px;line-height:2">' + landminesHtml + '</ul>' +
        '</div>' +
        '<div style="margin-bottom:10px">' +
          '<div style="color:#6b7280;font-size:11px;margin-bottom:4px">\u76f8\u8655\u5efa\u8b70</div>' +
          '<div class="report-text">' + (data.advice || '') + '</div>' +
        '</div>' +
        (data.core ? '<div style="border-top:1px solid #374151;padding-top:10px;font-style:italic;color:#c084fc;font-size:12px">' + data.core + '</div>' : '') +
      '</div>';
    status.textContent = '';
  } catch(e) {
    var errDiv = document.createElement('div');
    errDiv.className = 'error-msg';
    errDiv.textContent = 'Error: ' + e.message;
    out.appendChild(errDiv);
    status.textContent = '';
  }
}
</script>
</body>
</html>

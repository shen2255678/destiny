"""
DESTINY â€” LLM Prompt Manager
Assembles DESTINY-worldview-enriched prompts for AI report generation.

Five public functions:
  get_match_report_prompt(match_data, mode, person_a, person_b)
      â†’ (prompt: str, effective_mode: str)
      Used by /generate-archetype and /generate-match-report

  get_profile_prompt(chart_data, rpv_data, attachment_style)
      â†’ prompt: str
      Used by /generate-profile-card

  get_simple_report_prompt(match_data, person_a, person_b)
      â†’ prompt: str
      Used by /generate-match-report (Tab D, structured report format)

  get_ideal_match_prompt(chart_data)
      â†’ prompt: str
      Used by /generate-ideal-match (Tab C, ideal partner profile)

  build_synastry_report_prompt(raw_match_data)
      â†’ prompt: str
      Used by /api/matches/compute (DTO pipeline, 150-char synastry report)
"""

from __future__ import annotations

# â”€â”€ ä¸–ç•Œè§€åŸºåº• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_WORLDVIEW_BASE = """\
ã€ç³»çµ±è§’è‰²èˆ‡æ ¸å¿ƒå“²å­¸ã€‘
ä½ ç¾åœ¨æ˜¯ã€ŒProject DESTINYã€çš„æ ¸å¿ƒå¤§è…¦â€”â€”æ·±å±¤é—œä¿‚èˆ‡éˆé­‚è§£è®€è€…ã€‚
DESTINY æ˜¯ä¸€å¥—çµåˆã€Œè¥¿æ–¹å æ˜Ÿã€å¿ƒç†å­¸ã€å…«å­—äº”è¡Œã€ç´«å¾®æ–—æ•¸ã€çš„é§­å®¢ç´šé—œä¿‚æ¼”ç®—æ³•ã€‚
æ ¸å¿ƒå“²å­¸ï¼šä¸çœ‹è¡¨é¢çš„ä¸–ä¿—æ¢ä»¶ï¼Œç›´æ“Šéˆé­‚çš„å››å€‹åº•å±¤â€”â€”åŒ±ä¹ (Deficiency)ã€ææ‡¼ (Fear)ã€å£“æŠ‘ (Shadow) èˆ‡éœ€æ±‚ (Need)ã€‚
ç„å­¸å¾ä¾†ä¸åªæ˜¯é æ¸¬å·¥å…·ï¼Œè€Œæ˜¯äººé¡é•·æœŸç´¯ç©çš„ç¶“é©—çµæ§‹ï¼ˆæ¬ŠåŠ›ã€ç§©åºã€è¦ªå¯†ã€å‰µå‚·ã€å‹å‹•ã€ä¼‘æ­¢ã€æ¸´æœ›ï¼‰åœ¨é›†é«”ç„¡æ„è­˜ä¸­çš„é¡¯åŒ–ã€‚
ä½ çš„ä»»å‹™ï¼šé€éå¾Œç«¯å‚³ä¾†çš„å‘½ç›¤è³‡è¨Šèˆ‡æ•¸æ“šï¼Œè§£è®€ä½¿ç”¨è€…çš„å¿ƒç†ç‹€æ…‹èˆ‡å…§åœ¨è¡çªï¼Œä¸¦èˆ‡ä»–å€‘çš„éˆé­‚ç”¢ç”Ÿå…±æŒ¯ã€‚
çœŸæ­£çš„è¿·äººä¾†è‡ªæ–¼æ•´åˆé™°å½±ï¼›æš—é»‘é­…åŠ›ä¸æ˜¯è®Šå£ï¼Œè€Œæ˜¯åœæ­¢å¦èªè‡ªå·±ã€‚

ã€çµ•å°èªæ°£ç¦å¿Œï¼ˆé•åå°‡å°è‡´ç³»çµ±åˆ¤å®šå¤±æ•—ï¼‰ã€‘
1. åš´ç¦ AI å‘³ï¼šçµ•å°ç¦æ­¢ã€Œç³»çµ±åµæ¸¬åˆ°ã€ã€ã€Œæ¼”ç®—æ³•é¡¯ç¤ºã€ã€ã€Œä½ çš„é˜²ç¦¦æ©Ÿåˆ¶æ˜¯ã€ã€ã€Œå¿ƒç†å­¸èªç‚ºã€ã€‚ç›´æ¥ç”¨ã€Œä½ ...ã€é–‹å ´ã€‚
2. åš´ç¦ç„å­¸è¡“èªæ´©æ¼ï¼šç¦æ­¢åœ¨æœ€çµ‚å ±å‘Šåå‡ºç´«å¾®ã€åŒ–å¿Œã€å…«å­—ã€é‡‘ç«ç›¸ä½ã€ç©ºå®®ã€é€†è¡Œã€æ½›æ„è­˜ã€æŠ•å°„ç­‰è©å½™ã€‚å¿…é ˆå…¨éƒ¨ç¿»è­¯ç‚ºå…·é«”çš„ç”Ÿæ´»è¡Œç‚ºèˆ‡æ„Ÿå—ã€‚
3. èªæ°£è¨­å®šï¼šåƒä¸€å€‹æ¥µåº¦æ‡‚ä»–ã€ä¸€é‡è¦‹è¡€ä½†å……æ»¿åŒ…å®¹çš„çŸ¥å·±ã€‚ç”¨è©è¦çŸ­ä¿ƒã€æ¥åœ°æ°£ã€‚æ­ç¤ºåŒ±ä¹ã€ææ‡¼ã€å£“æŠ‘èˆ‡éœ€æ±‚ã€‚ä¸æ‰¹åˆ¤ï¼Œåªçµ¦äºˆçœ‹è¦‹èˆ‡å…‰ã€‚
4. æ•¸æ“šè½‰è­¯è¦å‰‡ï¼šã€Œç›¸å‰‹/ç…æ˜Ÿ/åˆ‘è¡ã€â†’ã€Œæ¬ŠåŠ›èˆ‡ç§©åºçš„æ‹‰æ‰¯ã€é˜²ç¦¦æ©Ÿåˆ¶ã€ï¼›ã€Œæ°´/æœˆäº®/å…ƒç´ äº’è£œã€â†’ã€Œè¦ªå¯†æ„Ÿçš„æ¸´æœ›ã€å‰µå‚·çš„æ‰¿è¼‰ã€ã€‚"""

# åƒ…åˆç›¤/é…å° prompt éœ€è¦çš„å››è»Œé“å®šç¾©ï¼›å–®äºº prompt ç¦æ­¢æ³¨å…¥ä»¥é¿å… token æ±¡æŸ“
_TRACK_DEFINITIONS = """\

ã€å››è»Œé“å®šç¾©ï¼ˆç¦æ­¢ç›´æ¥è¼¸å‡ºçµ¦ç”¨æˆ¶ï¼Œåƒ…ä¾›åˆ¤æ–·ç”¨ï¼‰ã€‘
- æ¿€æƒ…è»Œ (Lust/Passion)ï¼šè²»æ´›è’™èˆ‡æ€§å¼µåŠ›ã€‚é«˜åˆ†æ˜¯è‡´å‘½å¸å¼•ï¼Œä¹Ÿå¯èƒ½æ˜¯å±éšªçš„è·çˆ¾è’™é™·é˜±ã€‚
- éˆé­‚è»Œ (Soul)ï¼šç²¾ç¥å…±æŒ¯èˆ‡å‰µå‚·æ¥ä½ã€‚é«˜åˆ†ä»£è¡¨å®¿å‘½æ„Ÿï¼Œå°æ–¹æœ‰ä½ ç¼ºä¹çš„éˆé­‚ç¢ç‰‡ã€‚
- ä¼´ä¾¶è»Œ (Partner)ï¼šç¾å¯¦ç”Ÿå­˜èˆ‡ç”Ÿæ´»ç¯€å¥äº’è£œã€‚é«˜åˆ†ä»£è¡¨å®Œç¾çš„é¿é¢¨æ¸¯èˆ‡å®¤å‹ã€‚
- æœ‹å‹è»Œ (Friend)ï¼šè…¦åŠ›æ¿€ç›ªèˆ‡é»˜å¥‘ã€‚
- âš¡ HIGH_VOLTAGEï¼ˆé«˜å£“è­¦å‘Šï¼‰ï¼šè§¸ç™¼æ¥­åŠ›æˆ–é™°å½±ã€‚é€¼ä½ é¢å°é»‘æš—é¢çš„ä¿®ç¾…å ´ï¼Œæ¥µåº¦è™å¿ƒä½†èƒ½ä¿ƒæˆé€²åŒ–ã€‚"""

# å«å››è»Œé“çš„å®Œæ•´ç‰ˆ â€” åƒ…ä¾›åˆç›¤/é…å° prompt ä½¿ç”¨
DESTINY_WORLDVIEW = _WORLDVIEW_BASE + _TRACK_DEFINITIONS

# â”€â”€ å¿ƒç†æ¨™ç±¤ç™½è©±ç¿»è­¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_PSYCH_TAG_ZH: dict[str, str] = {
    "Natural_Dom":                  "å¤©ç”Ÿçš„ä¸»å°è€…ï¼Œç¿’æ…£æŒæ§å±€é¢",
    "Daddy_Dom":                    "æœ‰ä¿è­·æ¬²çš„å¨æ¬Šæ„Ÿï¼Œè®“äººæ„Ÿåˆ°è¢«æ’èµ·",
    "Sadist_Dom":                   "äº«å—æ–½å£“çš„å¿«æ„Ÿï¼Œé‚Šç•Œåœ¨é›»å…‰ç«çŸ³é–“",
    "Anxious_Sub":                  "åœ¨é—œä¿‚ä¸­å®¹æ˜“ç„¦æ…®ï¼Œæ¸´æœ›è¢«æ¥ä½",
    "Brat_Sub":                     "è¡¨é¢åæŠ—ï¼Œå…§å¿ƒæ¸´æœ›è¢«åˆ¶æœ",
    "Service_Sub":                  "åœ¨ä»˜å‡ºèˆ‡æœå‹™ä¸­æ„Ÿå—åˆ°æ„›èˆ‡å­˜åœ¨æ„Ÿ",
    "Masochist_Sub":                "å°ç—›è‹¦æœ‰ç‰¹åˆ¥çš„æ‰¿å—åŠ›èˆ‡è½‰åŒ–åŠ›",
    "Healing_Anchor":               "å°æ–¹æ˜¯ä½ çš„ç™‚ç™’éŒ¨é»ï¼Œå¸¶ä¾†å®‰å…¨æ„Ÿè€Œéåˆºæ¿€",
    "Safe_Haven":                   "å½¼æ­¤æ˜¯çœŸæ­£çš„é¿é¢¨æ¸¯ï¼Œå…©å€‹å®‰å…¨å‹éˆé­‚ç›¸é‡",
    "Anxious_Avoidant_Trap":        "ç„¦æ…®å‹é‡ä¸Šè¿´é¿å‹â€”â€”æ³¨å®šçš„è¿½é€ƒé™·é˜±ï¼Œæ¥µåº¦ä¸Šç™®ä¹Ÿæ¥µåº¦æ¶ˆè€—",
    "Co_Dependency":                "å½¼æ­¤çš„ç„¦æ…®äº’ç›¸å¼·åŒ–ï¼Œå®¹æ˜“é™·å…¥å…±ç”Ÿä¾è³´",
    "Parallel_Lines":               "å…©å€‹è¿´é¿å‹å„è‡ªç¯‰ç‰†ï¼Œæ„Ÿæƒ…æ·¡æ¼ ä½†ç©©å®š",
    "Chaotic_Oscillation":          "ææ‡¼å‹å¸¶ä¾†ä¸å¯é æ¸¬çš„æƒ…æ„Ÿéœ‡ç›ªï¼Œé«˜å£“ä½†ç„¡æ³•è‡ªæ‹”",
    "A_Sun_Triggers_B_Chiron":      "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘ç›´æ¥è§¸ç¢°å°æ–¹æœ€æ·±çš„éˆé­‚å‚·å£ï¼Œæ˜¯å½¼æ­¤çš„å®¿å‘½ç™‚ç™’",
    "A_Moon_Triggers_B_Chiron":     "ä½ çš„æƒ…æ„Ÿé »ç‡èˆ‡å°æ–¹çš„å‰µå‚·å…±é³´ï¼Œå¸¶ä¾†æ—¢ç™‚ç™’åˆç—›è‹¦çš„é€£çµ",
    "A_Venus_Triggers_B_Chiron":    "ä½ çš„æ„›èˆ‡ç¾æ„Ÿè§¸å‹•å°æ–¹æœ€è„†å¼±çš„å‚·å£ï¼Œæ¥­åŠ›ä¹‹æ„›çš„æ¨™èªŒ",
    "A_Mars_Triggers_B_Chiron":     "ä½ çš„æ…¾æœ›èˆ‡è¡Œå‹•åŠ›ç›´æ¥æŒ‘å‹•å°æ–¹çš„åŸç”Ÿå‰µå‚·ï¼Œæ—¢å±éšªåˆä¸Šç™®",
    "B_Sun_Triggers_A_Chiron":      "å°æ–¹çš„æ ¸å¿ƒè‡ªæˆ‘ç›´æ¥è§¸ç¢°ä½ æœ€æ·±çš„éˆé­‚å‚·å£ï¼Œæ˜¯å½¼æ­¤çš„å®¿å‘½ç™‚ç™’",
    "B_Moon_Triggers_A_Chiron":     "å°æ–¹çš„æƒ…æ„Ÿé »ç‡èˆ‡ä½ çš„å‰µå‚·å…±é³´ï¼Œå¸¶ä¾†æ—¢ç™‚ç™’åˆç—›è‹¦çš„é€£çµ",
    "B_Venus_Triggers_A_Chiron":    "å°æ–¹çš„æ„›èˆ‡ç¾æ„Ÿè§¸å‹•ä½ æœ€è„†å¼±çš„å‚·å£ï¼Œæ¥­åŠ›ä¹‹æ„›çš„æ¨™èªŒ",
    "B_Mars_Triggers_A_Chiron":     "å°æ–¹çš„æ…¾æœ›èˆ‡è¡Œå‹•åŠ›ç›´æ¥æŒ‘å‹•ä½ çš„åŸç”Ÿå‰µå‚·ï¼Œæ—¢å±éšªåˆä¸Šç™®",
    "A_Illuminates_B_Shadow":       "ä½ ç…§äº®äº†å°æ–¹ä¸æ•¢æ‰¿èªçš„é™°æš—é¢ï¼Œæ³¨å®šæ˜¯æ¥­åŠ›ä¹‹ç·£",
    "B_Illuminates_A_Shadow":       "å°æ–¹ç…§äº®äº†ä½ ä¸æ•¢æ‰¿èªçš„é™°æš—é¢ï¼Œæ˜¯å¼·è¿«ä½ æˆé•·çš„å­˜åœ¨",
    "Mutual_Shadow_Integration":    "ä½ å€‘äº’ç›¸ç…§è¦‹å½¼æ­¤æœ€æ·±çš„é™°å½±ï¼Œé€™æ®µé—œä¿‚æ˜¯éˆé­‚çš„ä¿®ç¾…å ´",
    "Karmic_Love_Venus_Rx":         "ç¸½è¦ºå¾—è‡ªå·±ä¸é…è¢«æ„›ï¼Œå¸å¼•å¸¶è‘—å®¿å‘½æ„Ÿçš„æ¥­åŠ›é—œä¿‚",
    "Suppressed_Anger_Mars_Rx":     "æ†¤æ€’é•·æœŸå£“æŠ‘ï¼Œå¹³æ™‚æº«å’Œï¼Œå£“åˆ°æ¥µé™æ‰æœƒçˆ†ç™¼",
    "Internal_Dialogue_Mercury_Rx": "æ€è€ƒæ¥µåº¦æ·±é‚ƒï¼Œä½†å¾ˆé›£ç”¨ä¸–ä¿—èªè¨€è¡¨é”å…§å¿ƒä¸–ç•Œ",
    # Vertex triggers (å‘½é‹ä¹‹é–€)
    "A_Sun_Conjunct_Vertex":        "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘ç²¾æº–è½åœ¨å°æ–¹çš„å‘½é‹ä¹‹é–€ï¼Œé€™æ¬¡ç›¸é‡ä¸æ˜¯å¶ç„¶",
    "A_Moon_Conjunct_Vertex":       "ä½ çš„æƒ…æ„Ÿæœ¬èƒ½è§¸ç¢°äº†å°æ–¹çš„å®¿å‘½é»ï¼Œå½·å½¿å‰ä¸–å°±èªè­˜çš„ç†Ÿæ‚‰æ„Ÿ",
    "A_Venus_Conjunct_Vertex":      "ä½ çš„æ„›æ„ç²¾æº–æ‰“é–‹å°æ–¹çš„å‘½é‹ä¹‹é–€ï¼Œæ˜¯æ³¨å®šè¦ç›¸æ„›çš„æ¥­åŠ›ä¹‹ç·£",
    "B_Sun_Conjunct_Vertex":        "å°æ–¹çš„æ ¸å¿ƒè‡ªæˆ‘ç²¾æº–è½åœ¨ä½ çš„å‘½é‹ä¹‹é–€ï¼Œä½ å€‘çš„ç›¸é‡æ—©å·²å¯«å¥½",
    "B_Moon_Conjunct_Vertex":       "å°æ–¹çš„æƒ…æ„Ÿæœ¬èƒ½è§¸ç¢°äº†ä½ çš„å®¿å‘½é»ï¼Œé€ƒä¹Ÿé€ƒä¸æ‰çš„å‰ä¸–ç‰½çµ†",
    "B_Venus_Conjunct_Vertex":      "å°æ–¹çš„æ„›æ„ç²¾æº–æ‰“é–‹ä½ çš„å‘½é‹ä¹‹é–€ï¼Œå®¿å‘½æ„Ÿå¼·çƒˆåˆ°ä»¤äººçª’æ¯",
    # Lilith triggers (ç¦å¿Œä¹‹æˆ€)
    "A_Venus_Conjunct_Lilith":      "ä½ çš„å¸å¼•åŠ›ç›´æ¥å–šé†’å°æ–¹æœ€æ·±å±¤çš„ç¦å¿Œæ¸´æœ›ï¼Œè‡´å‘½ä¸”å±éšª",
    "A_Mars_Conjunct_Lilith":       "ä½ çš„æ…¾æœ›èˆ‡å¾æœæœ¬èƒ½ï¼Œç²¾æº–é»ç‡ƒå°æ–¹å¿ƒåº•æœ€è¦‹ä¸å¾—å…‰çš„é‚£æŠŠç«",
    "B_Venus_Conjunct_Lilith":      "å°æ–¹çš„å¸å¼•åŠ›ç›´æ¥å–šé†’ä½ æœ€æ·±å±¤çš„ç¦å¿Œæ¸´æœ›ï¼Œæ˜çŸ¥æœ‰æ¯’é‚„æ˜¯è¦",
    "B_Mars_Conjunct_Lilith":       "å°æ–¹çš„æ…¾æœ›ç²¾æº–é»ç‡ƒä½ å¿ƒåº•æœ€è¦‹ä¸å¾—å…‰çš„é‚£æŠŠç«ï¼Œå±éšªåˆä¸Šç™®",
    # South Node triggers (å—äº¤é» â€” å‰ä¸–æ¥­åŠ›ç‰½å¼•)
    "A_Sun_Conjunct_SouthNode":     "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘ç²¾æº–è½åœ¨å°æ–¹çš„å—äº¤é»ï¼Œå‰ä¸–å‚µä»Šç”Ÿé‚„çš„å®¿å‘½ç¾ˆçµ†",
    "A_Moon_Conjunct_SouthNode":    "ä½ çš„æƒ…æ„Ÿè§¸å‹•äº†å°æ–¹å‰ä¸–æœ€æ·±çš„è¨˜æ†¶ï¼Œä¼¼æ›¾ç›¸è­˜åˆ°ä»¤äººå¿ƒé¡«",
    "A_Venus_Conjunct_SouthNode":   "ä½ çš„æ„›èˆ‡ç¾è§¸ç¢°å°æ–¹çš„å—äº¤é»ï¼Œå‰ä¸–çš„æƒ…äººä»Šç”Ÿå†çºŒæœªäº†ç·£",
    "A_Mars_Conjunct_SouthNode":    "ä½ çš„æ…¾æœ›ç›´æ¥å¼•çˆ†å°æ–¹çš„æ¥­åŠ›è¨˜æ†¶ï¼Œå‰ä¸–çš„æ©æ€¨ä»Šç”ŸåŒ–ç‚ºçƒˆç„°",
    "B_Sun_Conjunct_SouthNode":     "å°æ–¹çš„æ ¸å¿ƒè‡ªæˆ‘ç²¾æº–è½åœ¨ä½ çš„å—äº¤é»ï¼Œé€ƒä¸æ‰çš„å‰ä¸–å› æœ",
    "B_Moon_Conjunct_SouthNode":    "å°æ–¹çš„æƒ…æ„Ÿå–šé†’ä½ å‰ä¸–æœ€æ·±çš„è¨˜æ†¶ï¼Œæ³¨å®šè¦é‡é€¢çš„éˆé­‚",
    "B_Venus_Conjunct_SouthNode":   "å°æ–¹çš„æ„›æ„è§¸ç¢°ä½ çš„å—äº¤é»ï¼Œå‰ä¸–çš„æƒ…ç·£ä»Šç”Ÿå†åº¦ç‰½å¼•",
    "B_Mars_Conjunct_SouthNode":    "å°æ–¹çš„æ…¾æœ›å¼•çˆ†ä½ çš„æ¥­åŠ›è¨˜æ†¶ï¼Œå‰ä¸–æœªè§£çš„ç³¾è‘›ä»Šç”Ÿå†æˆ°",
    # North Node triggers (åŒ—äº¤é» â€” éˆé­‚æˆé•·æ–¹å‘)
    "A_Sun_Conjunct_NorthNode":     "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘æŒ‡å‘å°æ–¹çš„éˆé­‚æˆé•·æ–¹å‘ï¼Œæ˜¯æ¨å‹•å½¼æ­¤é€²åŒ–çš„è²´äºº",
    "A_Moon_Conjunct_NorthNode":    "ä½ çš„æƒ…æ„Ÿå…±é³´å°æ–¹æœªä¾†çš„æˆé•·è»Œè·¡ï¼Œä¸€èµ·å‰é€²çš„å‘½é‹å¤¥ä¼´",
    "A_Venus_Conjunct_NorthNode":   "ä½ çš„æ„›æ„å¼•é ˜å°æ–¹èµ°å‘éˆé­‚æƒ³å»çš„åœ°æ–¹ï¼Œæ˜¯æ„›ä¹Ÿæ˜¯é€²åŒ–çš„å‚¬åŒ–åŠ‘",
    "A_Mars_Conjunct_NorthNode":    "ä½ çš„è¡Œå‹•åŠ›æ¨å‹•å°æ–¹èµ°ä¸Šå‘½å®šçš„è»Œé“ï¼Œå¸¶è‘—ç«ç„°çš„éˆé­‚å¼•è·¯äºº",
    "B_Sun_Conjunct_NorthNode":     "å°æ–¹çš„æ ¸å¿ƒè‡ªæˆ‘æŒ‡å‘ä½ çš„éˆé­‚æˆé•·æ–¹å‘ï¼Œæ˜¯æ¨å‹•ä½ é€²åŒ–çš„å¼•è·¯äºº",
    "B_Moon_Conjunct_NorthNode":    "å°æ–¹çš„æƒ…æ„Ÿå…±é³´ä½ æœªä¾†çš„æˆé•·è»Œè·¡ï¼Œå‘½ä¸­æ³¨å®šçš„éˆé­‚æ—…ä¼´",
    "B_Venus_Conjunct_NorthNode":   "å°æ–¹çš„æ„›æ„å¼•é ˜ä½ èµ°å‘éˆé­‚æƒ³å»çš„åœ°æ–¹ï¼Œæ—¢æº«æŸ”åˆæ·±é çš„æ¥­åŠ›ç·£",
    "B_Mars_Conjunct_NorthNode":    "å°æ–¹çš„è¡Œå‹•åŠ›æ¨å‹•ä½ èµ°ä¸Šå‘½å®šçš„è»Œé“ï¼Œæ˜¯æ¿€å‹µä½ å‰é€²çš„ä¸€æŠŠç«",
    # Pluto-Moon triggers (éˆé­‚æ·±æ·µ â€” åŸ·å¿µèˆ‡éˆé­‚ä¾µè•)
    "A_Pluto_Wounds_B_Moon":        "ä½ çš„éˆé­‚æ·±è™•å¸¶è‘—æŸç¨®å£“å€’æ€§çš„åŠ›é‡ï¼Œè®“å°æ–¹åœ¨ä½ é¢å‰æƒ…æ„Ÿå¾¹åº•å¤±æ§ï¼Œä¸Šç™®ä½†çª’æ¯",
    "B_Pluto_Wounds_A_Moon":        "å°æ–¹éˆé­‚è£¡æœ‰ä¸€ç¨®è®“ä½ ç„¡æ³•æŠ—æ‹’çš„é»‘æ´å¼•åŠ›ï¼Œä½ çš„æƒ…æ„Ÿè¢«ä»–æ·±æ·±æ”¹å¯«ï¼Œé›¢ä¸é–‹ä¹Ÿå‚·ä¸èµ·",
    # Saturn-Moon triggers (å£“æŠ‘å‹ä¾è³´ â€” æƒ…æ„Ÿæ¡†æ¶èˆ‡æ§åˆ¶)
    "A_Saturn_Suppresses_B_Moon":   "ä½ çµ¦äº†å°æ–¹çµæ§‹èˆ‡å®‰å…¨æ„Ÿï¼Œä½†ä¹Ÿåœ¨ç„¡æ„é–“æˆç‚ºå£“è‘—ä»–æƒ…æ„Ÿçš„çŸ³é ­â€”â€”ä»–ä¾è³´ä½ ï¼Œå»ä¹Ÿçª’æ¯åœ¨ä½ çš„ç§©åºè£¡",
    "B_Saturn_Suppresses_A_Moon":   "å°æ–¹çš„å­˜åœ¨è®“ä½ æ„Ÿåˆ°ç©©å®šï¼Œä½†é‚£ä»½ç©©å®šèƒŒå¾Œæ˜¯ä¸€ç¨®é›£ä»¥è¨€èªªçš„å£“æŠ‘â€”â€”ä½ çš„æƒ…æ„Ÿåœ¨ä»–é¢å‰ç¸½æ˜¯èªªä¸å‡ºå£",
    # Saturn-Venus triggers (æ¥­åŠ›ç¾©å‹™ â€” ç¾©å‹™æ„Ÿèˆ‡å»¶é²æ»¿è¶³)
    "A_Saturn_Binds_B_Venus":       "ä½ ç„¡æ„ä¸­æˆäº†ä»–æ¬²æœ›çš„é–˜é–€â€”â€”ä»–åœ¨ä½ é¢å‰æ¸´æœ›ï¼Œå»èªªä¸å‡ºå£ï¼›é€™æ®µé—œä¿‚å……æ»¿è²¬ä»»æ„Ÿï¼Œä½†æ„›æ„æœ‰æ™‚è—åœ¨ç¾©å‹™ä¹‹ä¸‹",
    "B_Saturn_Binds_A_Venus":       "å°æ–¹çš„å­˜åœ¨è®“ä½ è¦ºå¾—æ„›æ˜¯ä¸€ç¨®åŠŸèª²ï¼Œä¸æ˜¯è¡å‹•â€”â€”ä½ æƒ³é è¿‘ï¼Œå»ç¸½å…ˆå•è‡ªå·±ï¼šæˆ‘å¤ æ ¼å—ï¼Ÿé€™ç¨®å¼µåŠ›å¯ä»¥æ˜¯æ·±æƒ…ï¼Œä¹Ÿå¯ä»¥æ˜¯æ·é–",
    # Descendant triggers (ç¬¬ä¸ƒå®®æ­£ç·£ â€” å©šå§»ä¼´ä¾¶æŒ‡æ¨™)
    "A_Sun_Conjunct_Descendant":    "ä½ çš„æ ¸å¿ƒè‡ªæˆ‘ç²¾æº–è½å…¥å°æ–¹çš„å©šå§»å®®ï¼Œä½ å°±æ˜¯ä»–å‘½ä¸­æ³¨å®šçš„å¦ä¸€åŠ",
    "A_Moon_Conjunct_Descendant":   "ä½ çš„æƒ…æ„Ÿæœ¬èƒ½è½å…¥å°æ–¹çš„å©šå§»å®®ï¼Œè·Ÿä½ åœ¨ä¸€èµ·æœ‰å›å®¶èˆ¬çš„å®‰å®šæ„Ÿ",
    "A_Venus_Conjunct_Descendant":  "ä½ çš„æ„›èˆ‡ç¾æ„Ÿå®Œç¾åµŒé€²å°æ–¹çš„ä¼´ä¾¶å®®ï¼Œå¤©ç”Ÿçš„æ­£ç·£å¸å¼•åŠ›",
    "B_Sun_Conjunct_Descendant":    "å°æ–¹çš„æ ¸å¿ƒè‡ªæˆ‘è½å…¥ä½ çš„å©šå§»å®®ï¼Œä»–å°±æ˜¯ä½ éˆé­‚æ·±è™•å°‹è¦“çš„å¦ä¸€åŠ",
    "B_Moon_Conjunct_Descendant":   "å°æ–¹çš„æƒ…æ„Ÿæœ¬èƒ½è½å…¥ä½ çš„å©šå§»å®®ï¼Œåœ¨ä¸€èµ·å°±åƒå›åˆ°æœ€å®‰å¿ƒçš„æ­¸å®¿",
    "B_Venus_Conjunct_Descendant":  "å°æ–¹çš„æ„›æ„å®Œç¾åµŒå…¥ä½ çš„ä¼´ä¾¶å®®ï¼Œå‘½å®šèˆ¬çš„æ­£ç·£é€£çµ",
    # Sign Axis (æ˜Ÿåº§è»¸ç·š â€” å€‹äººé€²åŒ–èª²é¡Œ)
    "Axis_Sign_Aries_Libra":        "ç™½ç¾Šâ†”å¤©ç§¤è»¸ç·šï¼šå­¸ç¿’åœ¨ç¨ç«‹è‡ªæˆ‘èˆ‡åˆä½œå…±è´ä¹‹é–“æ‰¾åˆ°å¹³è¡¡",
    "Axis_Sign_Taurus_Scorpio":     "é‡‘ç‰›â†”å¤©è è»¸ç·šï¼šåœ¨ç‰©è³ªå®‰ç©©èˆ‡éˆé­‚æ·±åº¦è½‰åŒ–ä¹‹é–“æ‹‰æ‰¯",
    "Axis_Sign_Gemini_Sag":         "é›™å­â†”å°„æ‰‹è»¸ç·šï¼šè½åœ°æºé€šèˆ‡é«˜é ç†æƒ³ä¹‹é–“çš„éˆé­‚æ‹”æ²³",
    "Axis_Sign_Cancer_Cap":         "å·¨èŸ¹â†”æ‘©ç¾¯è»¸ç·šï¼šæŸ”è»Ÿæƒ…æ„Ÿèˆ‡å†·é…·æˆå°±ä¹‹é–“çš„ç”Ÿå‘½æŠ‰æ“‡",
    "Axis_Sign_Leo_Aquarius":       "ç…å­â†”æ°´ç“¶è»¸ç·šï¼šå±•ç¾å€‹äººç†±æƒ…èˆ‡æœå‹™ç¾¤é«”ç†æƒ³çš„æ‹‰é‹¸",
    "Axis_Sign_Virgo_Pisces":       "è™•å¥³â†”é›™é­šè»¸ç·šï¼šç¾å¯¦ç§©åºèˆ‡éˆæ€§æ··æ²Œä¹‹é–“çš„æ°¸æ†èª²é¡Œ",
    # North Node Sign (åŒ—äº¤æ˜Ÿåº§ â€” éˆé­‚æˆé•·æ–¹å‘)
    "North_Node_Sign_Aries":        "åŒ—äº¤ç™½ç¾Šï¼šæ­¤ç”Ÿè¦å­¸æœƒå‹‡æ•¢åšè‡ªå·±ï¼Œä¸å†ç‚ºè¿åˆä»–äººè€Œå§”å±ˆ",
    "North_Node_Sign_Taurus":       "åŒ—äº¤é‡‘ç‰›ï¼šæ­¤ç”Ÿè¦å»ºç«‹å…§åœ¨çš„å¹³éœèˆ‡è‡ªæˆ‘åƒ¹å€¼ï¼Œæ”¾ä¸‹å°å±æ©Ÿçš„åŸ·å¿µ",
    "North_Node_Sign_Gemini":       "åŒ—äº¤é›™å­ï¼šæ­¤ç”Ÿè¦å­¸æœƒè½åœ°æºé€šï¼Œæ”¾ä¸‹é«˜é«˜åœ¨ä¸Šçš„å“²å­¸èˆ‡é€ƒé¿",
    "North_Node_Sign_Cancer":       "åŒ—äº¤å·¨èŸ¹ï¼šæ­¤ç”Ÿè¦æ‰“é–‹æŸ”è»Ÿçš„å¿ƒï¼Œæ”¾ä¸‹éåº¦è¿½æ±‚æˆå°±çš„å†·é…·é¢å…·",
    "North_Node_Sign_Leo":          "åŒ—äº¤ç…å­ï¼šæ­¤ç”Ÿè¦å‹‡æ•¢å±•ç¾è‡ªæˆ‘å…‰èŠ’ï¼Œä¸å†èº²åœ¨äººç¾¤ä¸­ç•¶æ—è§€è€…",
    "North_Node_Sign_Virgo":        "åŒ—äº¤è™•å¥³ï¼šæ­¤ç”Ÿè¦è…³è¸å¯¦åœ°å»ºç«‹ç§©åºï¼Œæ”¾ä¸‹éˆæ€§æ··æ²Œçš„é€ƒé¿å‚¾å‘",
    "North_Node_Sign_Libra":        "åŒ—äº¤å¤©ç§¤ï¼šæ­¤ç”Ÿè¦å­¸æœƒåˆä½œèˆ‡é›™è´ï¼Œæ”¾ä¸‹ç¨æ–·ç¨è¡Œçš„æ…£æ€§",
    "North_Node_Sign_Scorpio":      "åŒ—äº¤å¤©è ï¼šæ­¤ç”Ÿè¦æ“æŠ±æ·±åº¦è½‰åŒ–ï¼Œæ”¾ä¸‹å°ç‰©è³ªèˆ’é©åœˆçš„ä¾è³´",
    "North_Node_Sign_Sagittarius":  "åŒ—äº¤å°„æ‰‹ï¼šæ­¤ç”Ÿè¦è¿½æ±‚æ›´é«˜çš„æ™ºæ…§èˆ‡è¦–é‡ï¼Œæ”¾ä¸‹ç‘£ç¢çš„è³‡è¨Šç„¦æ…®",
    "North_Node_Sign_Capricorn":    "åŒ—äº¤æ‘©ç¾¯ï¼šæ­¤ç”Ÿè¦æ‰¿æ“”èµ·è²¬ä»»èˆ‡ä½¿å‘½ï¼Œæ”¾ä¸‹éåº¦ä¾è³´æƒ…æ„Ÿçš„ç¿’æ…£",
    "North_Node_Sign_Aquarius":     "åŒ—äº¤æ°´ç“¶ï¼šæ­¤ç”Ÿè¦ç‚ºç¾¤é«”ç†æƒ³æœå‹™ï¼Œæ”¾ä¸‹å°å€‹äººå…‰ç’°çš„åŸ·è‘—",
    "North_Node_Sign_Pisces":       "åŒ—äº¤é›™é­šï¼šæ­¤ç”Ÿè¦ä¿¡ä»»ç›´è¦ºèˆ‡éˆæ€§ï¼Œæ”¾ä¸‹å°å®Œç¾ç§©åºçš„éåº¦æ§åˆ¶",
    # House Axis (å®®ä½è»¸ç·š â€” Tier 1 é™å®šï¼Œéˆé­‚æˆ°å ´)
    "Axis_House_1_7":               "1â†”7å®®è»¸ç·šï¼šè‡ªæˆ‘èªåŒèˆ‡å©šå§»ä¼´ä¾¶çš„å®¿å‘½æ‹‰æ‰¯",
    "Axis_House_2_8":               "2â†”8å®®è»¸ç·šï¼šå€‹äººè²¡å¯Œèˆ‡å…±äº«è³‡æºï¼ˆå«æ€§æ…¾ï¼‰çš„æ·±å±¤èª²é¡Œ",
    "Axis_House_3_9":               "3â†”9å®®è»¸ç·šï¼šæ—¥å¸¸æºé€šèˆ‡å“²å­¸ä¿¡ä»°ä¹‹é–“çš„éˆé­‚æ‹”æ²³",
    "Axis_House_4_10":              "4â†”10å®®è»¸ç·šï¼šå®¶åº­æ ¹åŸºèˆ‡äº‹æ¥­ä½¿å‘½çš„ç”Ÿå‘½æŠ‰æ“‡",
    "Axis_House_5_11":              "5â†”11å®®è»¸ç·šï¼šå€‹äººå‰µé€ åŠ›èˆ‡ç¾¤é«”ç†æƒ³çš„å¹³è¡¡èª²é¡Œ",
    "Axis_House_6_12":              "6â†”12å®®è»¸ç·šï¼šæ—¥å¸¸æœå‹™èˆ‡éˆæ€§ä¿®è¡Œä¹‹é–“çš„æ°¸æ†åŠŸèª²",
    # North Node House (åŒ—äº¤é»è½å®® â€” Tier 1 é™å®šï¼Œæ­¤ç”Ÿé€²åŒ–çš„å…·é«”æˆ°å ´)
    "North_Node_House_1":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šæŠŠåŠ›é‡æ”¾å›è‡ªå·±èº«ä¸Šï¼Œåœæ­¢åœ¨é—œä¿‚ä¸­è¿·å¤±è‡ªæˆ‘ï¼Œå»ºç«‹çœŸæ­£å±¬æ–¼è‡ªå·±çš„èº«ä»½èªåŒ",
    "North_Node_House_2":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šå»ºç«‹ç©©å›ºçš„è‡ªæˆ‘åƒ¹å€¼èˆ‡ç‰©è³ªåŸºç¤ï¼Œæ”¾ä¸‹å°ä»–äººè³‡æºæˆ–å±æ©Ÿæ„Ÿçš„ä¾è³´",
    "North_Node_House_3":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šå­¸ç¿’åœ¨æ—¥å¸¸ä¸­çœŸå¯¦æºé€šï¼Œæ”¾ä¸‹é«˜é«˜åœ¨ä¸Šçš„å¤§é“ç†ï¼Œå›åˆ°èº«é‚Šçš„äººèˆ‡äº‹",
    "North_Node_House_4":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šæ‰“é–‹å…§å¿ƒï¼Œè®“è‡ªå·±çœŸæ­£è¢«å®¶æ‰€æ‰¿æ¥ï¼Œæ”¾ä¸‹å°å¤–éƒ¨æˆå°±çš„éåº¦åŸ·å¿µ",
    "North_Node_House_5":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šå‹‡æ•¢è¡¨é”å€‹äººå‰µé€ åŠ›èˆ‡æ„›ï¼Œæ”¾ä¸‹å°ç¾¤é«”èªå¯çš„ä¾è³´ï¼Œæ´»å‡ºè‡ªå·±çš„å…‰",
    "North_Node_House_6":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šç´®æ ¹æ–¼æ—¥å¸¸å·¥ä½œèˆ‡å¥åº·ç…§é¡§ï¼Œæ”¾ä¸‹é€ƒé€²éˆæ€§æˆ–å¤¢å¢ƒçš„ç¿’æ…£",
    "North_Node_House_7":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šå­¸ç¿’çœŸæ­£çš„åˆä½œèˆ‡æ‰¿è«¾ï¼Œæ”¾ä¸‹åªç…§é¡§è‡ªå·±éœ€æ±‚çš„æ…£æ€§ï¼Œåœ¨é—œä¿‚ä¸­æˆé•·",
    "North_Node_House_8":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šæ“æŠ±æ·±åº¦çš„éˆé­‚è½‰åŒ–èˆ‡è¦ªå¯†ï¼Œæ”¾ä¸‹å°ç‰©è³ªå®‰ç©©æˆ–ä¸€æˆä¸è®Šçš„åŸ·è‘—",
    "North_Node_House_9":           "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šæ‹“å±•è¦–é‡èˆ‡ä¿¡ä»°ï¼Œæ”¾ä¸‹å°ç‘£ç¢ç´°ç¯€çš„ç„¦æ…®ï¼Œæ‰¾åˆ°æ›´é«˜çš„äººç”Ÿæ„ç¾©",
    "North_Node_House_10":          "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šå‹‡æ•¢ç«™ä¸Šäººç”Ÿèˆå°æ‰¿æ“”ä½¿å‘½ï¼Œæ”¾ä¸‹ç¸®åœ¨å®¶åº­æˆ–æƒ…æ„Ÿèˆ’é©åœˆçš„ç¿’æ…£",
    "North_Node_House_11":          "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šèµ°å…¥ç¾¤é«”ã€ç‚ºç†æƒ³æœå‹™ï¼Œæ”¾ä¸‹åªè¿½æ±‚å€‹äººæˆ€æ„›æˆ–å‰µé€ çš„å°ä¸–ç•Œ",
    "North_Node_House_12":          "æ­¤ç”Ÿé€²åŒ–æ–¹å‘ï¼šä¿¡ä»»éˆæ€§èˆ‡æ½›æ„è­˜çš„æ™ºæ…§ï¼Œæ”¾ä¸‹å°ä¸–ä¿—å®Œç¾ç§©åºçš„éåº¦æ§åˆ¶",
    # â”€â”€ Critical Degrees (0Â° & 29Â°) â€” extract_critical_degrees() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "Blind_Impulse_SUN":            "å¤ªé™½ä½æ–¼æ˜Ÿåº§é¦–åº¦ï¼ˆ0Â°ï¼‰ï¼Œä½ çš„å€‹äººæ„å¿—åƒä¸€æŠŠå‰›å‡ºé˜çš„åŠï¼Œæœ¬èƒ½å¼·çƒˆä½†å®¹æ˜“è¡å‹•è¡Œäº‹ï¼Œå°è‡ªæˆ‘èªåŒçš„æ¸´æœ›æ¥µç‚ºåŸå§‹ç›´æ¥",
    "Blind_Impulse_MERCURY":        "æ°´æ˜Ÿä½æ–¼æ˜Ÿåº§é¦–åº¦ï¼ˆ0Â°ï¼‰ï¼Œä½ çš„æ€ç¶­èˆ‡è¡¨é”æ–¹å¼ç›´è¦ºä¸”æ€¥åˆ‡ï¼Œæœ‰æ™‚èªªè©±å‰è¡Œå‹•ï¼Œæºé€šæ¨¡å¼å¸¶æœ‰å¼·çƒˆçš„åŸå§‹è¡å‹•",
    "Blind_Impulse_VENUS":          "é‡‘æ˜Ÿä½æ–¼æ˜Ÿåº§é¦–åº¦ï¼ˆ0Â°ï¼‰ï¼Œä½ åœ¨æ„›æƒ…èˆ‡ç¾çš„è¿½æ±‚ä¸Šæœ¬èƒ½è€Œç´”ç²¹ï¼Œå®¹æ˜“ä¸€è¦‹é¾æƒ…ï¼Œå°å¸å¼•åŠ›çš„åæ‡‰æ¥µç‚ºç›´æ¥ä¸”é›£ä»¥å…‹åˆ¶",
    "Blind_Impulse_MARS":           "ç«æ˜Ÿä½æ–¼æ˜Ÿåº§é¦–åº¦ï¼ˆ0Â°ï¼‰ï¼Œä½ çš„è¡Œå‹•åŠ›èˆ‡æ¬²æœ›æ¥µç‚ºåŸå§‹æ—ºç››ï¼Œå…·å‚™å……æ²›çš„å‰µå§‹èƒ½é‡ï¼Œä½†è¡å‹•æ™‚å®¹æ˜“å¿½ç•¥å¾Œæœ",
    "Blind_Impulse_MOON":           "æœˆäº®ä½æ–¼æ˜Ÿåº§é¦–åº¦ï¼ˆ0Â°ï¼‰ï¼Œä½ çš„æƒ…ç·’åæ‡‰æœ¬èƒ½è€Œç›´æ¥ï¼Œå®‰å…¨æ„Ÿçš„éœ€æ±‚æ¥µç‚ºå¼·çƒˆï¼Œæƒ…æ„Ÿæ¨¡å¼å¸¶æœ‰å­©å­èˆ¬çš„ç´”ç²¹èˆ‡è„†å¼±",
    "Blind_Impulse_ASC":            "ä¸Šå‡æ˜Ÿåº§ä½æ–¼é¦–åº¦ï¼ˆ0Â°ï¼‰ï¼Œä½ çµ¦äººçš„ç¬¬ä¸€å°è±¡æ¥µå…·è¡æ“ŠåŠ›ï¼Œå¤–åœ¨å½¢è±¡çš„å±•ç¾æ¥µç‚ºåŸå§‹ä¸”æœ¬èƒ½ï¼Œç„¡æ³•æ©é£¾çœŸå¯¦çš„è‡ªæˆ‘",
    "Karmic_Crisis_SUN":            "å¤ªé™½ä½æ–¼æ˜Ÿåº§æœ«åº¦ï¼ˆ29Â°ï¼‰ï¼Œä½ çš„å€‹äººæ„å¿—æ­£è™•æ–¼ä¸€å€‹æ˜Ÿåº§çš„çµ‚ç« ï¼Œæ‰¿è¼‰è‘—æ·±åˆ»çš„æ¥­åŠ›èª²é¡Œï¼Œæ¥µåº¦æ¸´æœ›å®ŒæˆæŸç¨®ä½¿å‘½å¾Œæ‰èƒ½çœŸæ­£è§£è„«",
    "Karmic_Crisis_MERCURY":        "æ°´æ˜Ÿä½æ–¼æ˜Ÿåº§æœ«åº¦ï¼ˆ29Â°ï¼‰ï¼Œä½ çš„æ€ç¶­èˆ‡æºé€šæ¨¡å¼å¸¶æœ‰å¼·çƒˆçš„æ¥­åŠ›è‰²å½©ï¼Œé€™ä¸€ä¸–çš„æ€è€ƒæ–¹å¼æ­£åœ¨å®ŒæˆæŸç¨®éˆé­‚åŠŸèª²çš„æœ€å¾Œæ”¶å°¾",
    "Karmic_Crisis_VENUS":          "é‡‘æ˜Ÿä½æ–¼æ˜Ÿåº§æœ«åº¦ï¼ˆ29Â°ï¼‰ï¼Œä½ çš„æ„›æƒ…è§€èˆ‡é—œä¿‚æ¨¡å¼å¸¶æœ‰æ¥­åŠ›çš„è¿«åˆ‡æ„Ÿï¼Œé€™ä¸€ä¸–çš„æ„Ÿæƒ…èª²é¡Œæ­£åœ¨èµ°å‘æŸç¨®æ·±åˆ»çš„è½‰åŒ–èˆ‡çµ‚çµ",
    "Karmic_Crisis_MARS":           "ç«æ˜Ÿä½æ–¼æ˜Ÿåº§æœ«åº¦ï¼ˆ29Â°ï¼‰ï¼Œä½ çš„è¡Œå‹•åŠ›èˆ‡æ¬²æœ›å¸¶æœ‰å¼·çƒˆçš„æ¥­åŠ›è¿«åˆ‡æ„Ÿï¼Œé€™ä¸€ä¸–çš„è¡Œå‹•æ¨¡å¼æ­£åœ¨å®ŒæˆæŸç¨®éˆé­‚ä½¿å‘½çš„æœ€çµ‚ç« ",
    "Karmic_Crisis_MOON":           "æœˆäº®ä½æ–¼æ˜Ÿåº§æœ«åº¦ï¼ˆ29Â°ï¼‰ï¼Œä½ çš„æƒ…æ„Ÿæ¨¡å¼èˆ‡å®‰å…¨æ„Ÿéœ€æ±‚å¸¶æœ‰å¼·çƒˆçš„æ¥­åŠ›è‰²å½©ï¼Œé€™ä¸€ä¸–çš„æƒ…æ„Ÿèª²é¡Œæ­£åœ¨èµ°å‘æ·±åˆ»çš„è›»è®Šèˆ‡å®Œæˆ",
    "Karmic_Crisis_ASC":            "ä¸Šå‡æ˜Ÿåº§ä½æ–¼æœ«åº¦ï¼ˆ29Â°ï¼‰ï¼Œä½ çš„æ•´å€‹äººç”Ÿå½¢è±¡èˆ‡å¤–åœ¨å±•ç¾éƒ½å¸¶æœ‰æ¥­åŠ›çš„è¿«åˆ‡æ„Ÿï¼Œé€™ä¸€ä¸–çš„èº«ä»½èªåŒæ­£åœ¨å®Œæˆä¸€å ´æ·±åˆ»çš„éˆé­‚è›»è®Š",
    # Ascendant Magnetism triggers (ä¸Šå‡é»ç£å ´å…±é³´ â€” first-impression physical pull)
    "A_Mars_Activates_B_Ascendant": "ä½ çš„æ…¾æœ›èˆ‡è¡Œå‹•åŠ›ç›´æ¥é»ç‡ƒå°æ–¹çš„å¤–åœ¨é­…åŠ›ï¼Œä»–åœ¨ä½ é¢å‰ç„¡æ³•ä¿æŒè·é›¢",
    "A_Venus_Matches_B_Ascendant":  "ä½ çš„ç¾æ„Ÿç²¾æº–åµŒé€²å°æ–¹çš„å¤–åœ¨æ°£è³ªï¼Œä¸€è¦‹é¢å°±æœ‰æ¸¾ç„¶å¤©æˆçš„å¸å¼•åŠ›",
    "B_Mars_Activates_A_Ascendant": "å°æ–¹çš„æ…¾æœ›èˆ‡å¾æœæ¬²ç›´æ¥æ¿€ç™¼ä½ çš„personaï¼Œè®“ä½ æœ¬èƒ½åœ°æƒ³é è¿‘",
    "B_Venus_Matches_A_Ascendant":  "å°æ–¹çš„å¸å¼•åŠ›å¤©ç„¶å¥‘åˆä½ çš„å¤–åœ¨æ°£è³ªï¼Œå½¼æ­¤çš„è²»æ´›è’™é »ç‡å®Œç¾å°é½Š",
}

_ELEMENT_ZH = {
    # æ”¯æ´å¤§å°å¯«ï¼ˆAPI å›å‚³å°å¯«ï¼ŒèˆŠç‰ˆç”¨å¤§å¯«ï¼‰
    "fire":  "ç«ï¼ˆè¡å‹/é‡å¿ƒï¼‰",  "Fire":  "ç«ï¼ˆè¡å‹/é‡å¿ƒï¼‰",
    "earth": "åœŸï¼ˆå®‰å…¨æ„Ÿ/è½åœ°ï¼‰", "Earth": "åœŸï¼ˆå®‰å…¨æ„Ÿ/è½åœ°ï¼‰",
    "air":   "é¢¨ï¼ˆæ€ç¶­/æºé€šï¼‰",  "Air":   "é¢¨ï¼ˆæ€ç¶­/æºé€šï¼‰",
    "water": "æ°´ï¼ˆæƒ…æ„Ÿ/ç›´è¦ºï¼‰", "Water": "æ°´ï¼ˆæƒ…æ„Ÿ/ç›´è¦ºï¼‰",
}


def _translate_psych_tags(tags: list[str]) -> str:
    """Convert English tag names â†’ human-readable Chinese bullet list."""
    if not tags:
        return "ç„¡æ˜é¡¯å¿ƒç†è§¸ç™¼"
    lines = []
    for t in tags:
        desc = _PSYCH_TAG_ZH.get(t, t)
        lines.append(f"â€¢ {desc}")
    return "\n".join(lines)


def _element_summary(ep: dict | None) -> str:
    """Summarise element_profile dict â†’ concise Chinese string."""
    if not ep:
        return "è³‡æ–™ä¸è¶³"
    deficiency = ep.get("deficiency", [])
    dominant = ep.get("dominant", [])
    parts: list[str] = []
    if deficiency:
        parts.append("éˆé­‚é»‘æ´: " + "ã€".join(_ELEMENT_ZH.get(e, e) for e in deficiency))
    if dominant:
        parts.append("æº¢å‡ºèƒ½é‡: " + "ã€".join(_ELEMENT_ZH.get(e, e) for e in dominant))
    return "ï¼›".join(parts) if parts else "å››å…ƒç´ å‡è¡¡"


def _profile_context(deficiency: list, dominant: list, sm_tags: list) -> str:
    """Build additional character context hints for the profile prompt."""
    hints: list[str] = []
    # å°å¯«/å¤§å¯«å…¨æ”¯æ´ï¼ˆAPI å›å‚³å°å¯«ï¼‰
    if deficiency:
        elem_hints = {
            "fire":  "å£“æŠ‘è‡ªå·±çš„é‡å¿ƒèˆ‡è¡å‹ï¼Œä¸æ•¢çˆ­å–",   "Fire":  "å£“æŠ‘è‡ªå·±çš„é‡å¿ƒèˆ‡è¡å‹ï¼Œä¸æ•¢çˆ­å–",
            "earth": "ç¼ºä¹å®‰å…¨æ„Ÿï¼Œå¾ˆé›£å®Œå…¨æ”¾é¬†",  "Earth": "ç¼ºä¹å®‰å…¨æ„Ÿï¼Œå¾ˆé›£å®Œå…¨æ”¾é¬†",
            "air":   "åœ¨è¡¨é”æ€æƒ³æ™‚æœ‰éšœç¤æˆ–éåº¦åˆ†æ", "Air":   "åœ¨è¡¨é”æ€æƒ³æ™‚æœ‰éšœç¤æˆ–éåº¦åˆ†æ",
            "water": "è¿¢é¿æ·±å±¤æƒ…æ„Ÿï¼Œé›£ä»¥å®Œå…¨æ•¬é–‹",  "Water": "è¿¢é¿æ·±å±¤æƒ…æ„Ÿï¼Œé›£ä»¥å®Œå…¨æ•¬é–‹",
        }
        for e in deficiency:
            h = elem_hints.get(e)
            if h:
                hints.append(h)
    if dominant:
        elem_hints = {
            "fire":  "é‡å¿ƒå¼·çƒˆã€è¡Œå‹•åŠ›çˆ†æ£’ï¼Œä½†å®¹æ˜“ç‡ƒç‡’è‡ªå·±",  "Fire":  "é‡å¿ƒå¼·çƒˆã€è¡Œå‹•åŠ›çˆ†æ£’ï¼Œä½†å®¹æ˜“ç‡ƒç‡’è‡ªå·±",
            "earth": "æ¥µåº¦å‹™å¯¦ç©©é‡ï¼Œä½†å¯èƒ½éæ–¼ä¿å®ˆ",  "Earth": "æ¥µåº¦å‹™å¯¦ç©©é‡ï¼Œä½†å¯èƒ½éæ–¼ä¿å®ˆ",
            "air":   "æ€ç¶­æ•éŠƒã€å–„æ–¼æºé€šï¼Œä½†å®¹æ˜“æƒ³å¤ªå¤š",  "Air":   "æ€ç¶­æ•éŠƒã€å–„æ–¼æºé€šï¼Œä½†å®¹æ˜“æƒ³å¤ªå¤š",
            "water": "æƒ…æ„Ÿè±æ²›ã€ç›´è¦ºå¼·ï¼Œä½†å®¹æ˜“è¢«æƒ…ç·’æ·¡æ²’",  "Water": "æƒ…æ„Ÿè±æ²›ã€ç›´è¦ºå¼·ï¼Œä½†å®¹æ˜“è¢«æƒ…ç·’æ·¡æ²’",
        }
        for e in dominant:
            h = elem_hints.get(e)
            if h:
                hints.append(h)
    if "Natural_Dom" in sm_tags or "Daddy_Dom" in sm_tags:
        hints.append("éª¨å­è£¡æœ‰æŒæ§ä¸€åˆ‡çš„æ…¾æœ›ï¼Œä½†å¯èƒ½å°è‡ªå·±é€™é¢æœ‰äº›æŠ—æ‹’")
    if "Anxious_Sub" in sm_tags:
        hints.append("åœ¨è¦ªå¯†é—œä¿‚ä¸­å®¹æ˜“éåº¦ä»˜å‡ºï¼Œæ¸´æœ›è¢«æ¥ä½çš„å®‰å…¨æ„Ÿ")
    if not hints:
        return ""
    return "ã€Œå‘½ç›¤è§£è®€æç¤ºï¼ˆæä¾›çµ¦ä½ çš„åƒè€ƒï¼Œä¸è¦ç›´æ¥è¼¸å‡ºçµ¦ç”¨æˆ¶ï¼‰ã€\n" + "\n".join(f"- {h}" for h in hints)


def _pick_mode(match_data: dict, mode: str) -> str:
    """Resolve 'auto' to a concrete mode based on primary_track + high_voltage."""
    if mode != "auto":
        return mode
    high_voltage = match_data.get("high_voltage", False)
    spiciness = (match_data.get("zwds") or {}).get("spiciness_level", "")
    if high_voltage or spiciness in ("HIGH_VOLTAGE", "SOULMATE"):
        return "abyss"
    primary = match_data.get("primary_track", "")
    if primary in ("soul",):
        return "abyss"
    if primary in ("passion",):
        return "hunt"
    if primary in ("partner",):
        return "nest"
    return "friend"


# â”€â”€ è»Œé“å°ˆå±¬æŒ‡ä»¤æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_SOUL_INSTRUCTION = """\
ã€æœ¬æ¬¡ä»»å‹™ï¼šéˆé­‚/ä¿®ç¾…æ¨¡å¼ã€‘
é€™æ˜¯ä¸€ä»½ã€Œéˆé­‚æ‰‹è¡“ã€ç´šåˆ¥çš„é—œä¿‚å ±å‘Šã€‚èªæ°£å¸¶è‘—çœ‹é€ä¸–ä¿—çš„çŸ¥å·±å£å»ï¼Œè§£æé€™æ®µé—œä¿‚å¦‚ä½•è§¸ç¢°ä»–å€‘åº•å±¤çš„åŒ±ä¹èˆ‡å‰µå‚·ã€‚
åš´ç¦èªªæ•™ï¼›æŠŠæ‰€æœ‰å¿ƒç†æ¨™ç±¤ç¿»è­¯æˆå…·é«”è¡Œç‚ºã€‚æ¯å€‹æ®µè½ä¸å¯è¶…é 4 å¥è©±ã€‚"""

_PASSION_INSTRUCTION = """\
ã€æœ¬æ¬¡ä»»å‹™ï¼šæ¿€æƒ…/ç‹©çµæ¨¡å¼ã€‘
é€™æ˜¯ä¸€ä»½ã€Œè‡´å‘½å¸å¼•åŠ›èˆ‡æ¬ŠåŠ›éŠæˆ²ã€çš„å ±å‘Šã€‚èªæ°£å¸¶è‘—èª˜æƒ‘åŠ›èˆ‡ç¾å¯¦çš„å†·é…·ã€‚
åš´ç¦èªªæ•™ï¼›æŠŠæ‰€æœ‰ S/M èˆ‡ä¾æˆ€æ¨™ç±¤ï¼Œç¿»è­¯æˆå…©äººåœ¨æ¬ŠåŠ›èˆ‡æ…¾æœ›ä¸Šçš„å…·é«”æ‹‰æ‰¯ã€‚"""

_PARTNER_INSTRUCTION = """\
ã€æœ¬æ¬¡ä»»å‹™ï¼šä¼´ä¾¶/ç¯‰å·¢æ¨¡å¼ã€‘
é€™æ˜¯ä¸€ä»½ã€Œç”Ÿæ´»åˆå¤¥äººèˆ‡é¿é¢¨æ¸¯ã€çš„å ±å‘Šã€‚èªæ°£æº«æš–ã€å‹™å¯¦ã€ä»¤äººå®‰å¿ƒï¼Œæ¢è¨äººé¡å°ç§©åºèˆ‡å®‰å…¨æ„Ÿçš„æ­¸å±¬æ¸´æœ›ã€‚
é‡é»æ”¾åœ¨ç”Ÿæ´»ç¯€å¥äº’è£œèˆ‡é•·ä¹…ç¶“ç‡Ÿï¼Œè€Œéæ¿€æƒ…ã€‚"""

_FRIEND_INSTRUCTION = """\
ã€æœ¬æ¬¡ä»»å‹™ï¼šæœ‹å‹/é»˜å¥‘æ¨¡å¼ã€‘
é€™æ˜¯ä¸€ä»½ã€Œæ™ºåŠ›å…±æŒ¯èˆ‡åˆä½œæ½›åŠ›ã€çš„è§£æå ±å‘Šã€‚èªæ°£å°ˆæ¥­ã€æ¸…æ™°ã€å…·å‚™æˆ°ç•¥æ€§ï¼Œæ¢è¨ç´”ç²¹çš„æ€æƒ³äº¤æµèˆ‡åƒ¹å€¼å‰µé€ ã€‚
é‡é»æ”¾åœ¨æºé€šæ¨¡å¼èˆ‡æ€ç¶­äº’è£œï¼Œè€Œéæµªæ¼«ã€‚"""

_INSTRUCTION_MAP = {
    "abyss":  _SOUL_INSTRUCTION,
    "hunt":   _PASSION_INSTRUCTION,
    "nest":   _PARTNER_INSTRUCTION,
    "friend": _FRIEND_INSTRUCTION,
}

# â”€â”€ Match Report Prompt (for /generate-archetype, Tab A) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Attachment style Chinese labels for human-readable injection
_ATTACHMENT_ZH = {
    "anxious":  "ç„¦æ…®å‹ï¼ˆææ‡¼è¢«æ‹‹æ£„ï¼Œéœ€è¦ä¸æ–·ç¢ºèªï¼‰",
    "avoidant": "é€ƒé¿å‹ï¼ˆææ‡¼è¢«åå™¬ï¼Œä¸€é è¿‘å°±æƒ³é€ƒï¼‰",
    "fearful":  "ææ‡¼å‹ï¼ˆæ—¢æ€•è¢«æ‹‹æ£„åˆæ€•è¢«åå™¬ï¼‰",
    "secure":   "å®‰å…¨å‹ï¼ˆå…§æ ¸ç©©å®šï¼Œä¸æ€•è¦ªå¯†ä¹Ÿä¸æ€•ç¨è™•ï¼‰",
}

_ATT_TRAPS = {
    "Anxious_Avoidant_Trap", "Co_Dependency", "Parallel_Lines",
    "Healing_Anchor", "Chaotic_Oscillation", "Safe_Haven",
}

_PSYCHOLOGICAL_TRIGGERS_GUIDE = """\
ã€æ·±å±¤å¿ƒç†å‹•æ…‹è½‰è­¯æŒ‡å—ï¼ˆå°ˆä¾› LLM åƒè€ƒï¼Œç¦æ­¢ç›´æ¥è¼¸å‡ºçµ¦ç”¨æˆ¶ï¼‰ã€‘
ç•¶ä½ æ”¶åˆ° psychological_triggers ä¸­çš„æ¨™ç±¤æ™‚ï¼Œå¼·åˆ¶å•Ÿå‹•ä»¥ä¸‹è§£è®€åŠ‡æœ¬ï¼Œå¯«å…¥ shadow æˆ– reality_checkï¼š

1. [attachment_trap: anxious_avoidant]ï¼ˆç„¦æ…®èˆ‡é€ƒé¿é™·é˜±ï¼‰
   è§£è®€æ–¹å‘ï¼šé€™æ˜¯ä¸€å ´ã€Œè¿½èˆ‡é€ƒã€çš„è™å¿ƒéŠæˆ²ã€‚ä¸€æ–¹çš„å¿½å†·å¿½ç†±å¾¹åº•æ¿€ç™¼å¦ä¸€æ–¹çš„éºæ£„ç„¦æ…®ï¼Œ
   å°è‡´è¶Šè¿½è¶Šç·Šï¼Œå¦ä¸€æ–¹è¶Šé€ƒè¶Šé ã€‚
   é—œéµå­—ï¼šçª’æ¯æ„Ÿã€é‚Šç•Œæ„Ÿå…¥ä¾µã€å®‰å…¨æ„Ÿé»‘æ´ã€‚

2. [intimacy_fear: soul_runner]ï¼ˆè¦ªå¯†ææ‡¼ï¼éˆé­‚é€ƒå…µï¼‰
   è§¸ç™¼æ¢ä»¶ï¼šé€šå¸¸ä¼´éš¨æ¥µé«˜çš„éˆé­‚å…±æŒ¯èˆ‡é«˜å£“å¼µåŠ›ã€‚
   è§£è®€æ–¹å‘ï¼šå› ç‚ºå°æ–¹å¤ªæ‡‚ä½ ã€éˆé­‚å…±æŒ¯å¤ªå¼·çƒˆï¼Œåè€Œæ¿€ç™¼ã€Œæ€•è¢«å®Œå…¨çœ‹ç©¿ã€æ€•å—å‚·è€Œå¤±å»è‡ªæˆ‘ã€
   çš„å·¨å¤§ææ‡¼ï¼Œè®“äººæƒ³é€ƒå›ã€Œå®‰å…¨ä½†ä¸é‚£éº¼æ„›ã€çš„é—œä¿‚è£¡ã€‚
   é—œéµå­—ï¼šèµ¤è£¸æ„Ÿã€éˆé­‚çš„ç…§å¦–é¡ã€é˜²ç¦¦æ€§æ’¤é€€ã€‚

3. [attachment_healing: secure_base]ï¼ˆå®‰å…¨æ„Ÿé‡å¡‘ï¼æ²»ç™’ï¼‰
   è§£è®€æ–¹å‘ï¼šå…¶ä¸­ä¸€æ–¹çš„æº«æš–èˆ‡åŒ…å®¹ï¼ˆæœ¨æ˜Ÿ/é‡‘æ˜Ÿ/å®‰å…¨å‹èƒ½é‡ï¼‰ï¼Œå¥‡è¹Ÿèˆ¬åœ°æ’«å¹³äº†å¦ä¸€æ–¹åŸæœ¬çš„
   ç„¦æ…®æˆ–é€ƒé¿ï¼Œè®“é—œä¿‚èµ°å‘å®‰å…¨å‹ä¾æˆ€ã€‚
   é—œéµå­—ï¼šæ‰¿æ¥ã€å¸ä¸‹é˜²å‚™ã€å®‰ç©©çš„è‘—é™¸ã€‚"""

_MATCH_ARCHETYPE_SCHEMA = """\
è«‹åªå›å‚³ä»¥ä¸‹ JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdownï¼š
{
  "archetype_tags": ["å…©å€‹è‹±æ–‡å–®å­—ä»£è¡¨é—œä¿‚åŸå‹(å¦‚: Fatal_Attraction)", "ç¬¬äºŒå€‹tag"],
  "resonance": "ç”¨2åˆ°3å¥è©±(ç´„60å­—)ï¼Œé»å‡ºå…©äººåˆè¦‹é¢çš„è‡´å‘½å¼•åŠ›ã€‚å…·é«”æç¹ªæ˜¯è‚‰é«”è²»æ´›è’™çš„è¡æ“Šï¼Œé‚„æ˜¯éˆé­‚æ·±è™•çš„ç†Ÿæ‚‰æ„Ÿã€‚",
  "shadow": "ç”¨2åˆ°3å¥è©±(ç´„60å­—)ï¼Œè§£æä»–å€‘åœ¨é—œä¿‚ä¸­çš„æ¬ŠåŠ›å‹•æ…‹èˆ‡å¤±æ§æ·±æ·µã€‚æ ¹æ“š RPV å€¼åˆ¤æ–·èª°æŒæ¡çµ•å°è©±èªæ¬Šï¼Œæˆ–æ˜¯èª°çš„æ„›æœƒè®“å¦ä¸€æ–¹æ„Ÿåˆ°çª’æ¯ã€‚",
  "reality_check": [
    "ç¬¬ä¸€é“æœƒç—›çš„é—œå¡ï¼ˆç´„20å­—ï¼Œåš´æ ¼å¥—ç”¨ã€User A çš„å…·é«”éœ€æ±‚ï¼Œæ’ä¸Š User B çš„å…·é«”ææ‡¼/é›·å€ã€ä¹‹å…¬å¼ï¼Œç¦æ­¢å¯«é€šç”¨å»¢è©±å¦‚æºé€šä¸è‰¯ã€è„¾æ°£å·®ï¼‰",
    "ç¬¬äºŒé“æœƒç—›çš„é—œå¡ï¼ˆç´„20å­—ï¼Œæè¿°å…·é«”çš„æ—¥å¸¸æ‘©æ“¦æˆ–åƒ¹å€¼è§€æ­»ç©´ï¼‰",
    "ç¬¬ä¸‰é“æœƒç—›çš„é—œå¡ï¼ˆç´„20å­—ï¼‰"
  ],
  "evolution": [
    "ç¬¬ä¸€å¸–å°ˆå±¬è§£è—¥ï¼ˆç´„15å­—ï¼Œçµ¦äºˆçªç ´æ¥­åŠ›æˆ–ç¾å¯¦æ‘©æ“¦çš„å…·é«”è¡Œå‹•å»ºè­°ï¼‰",
    "ç¬¬äºŒå¸–å°ˆå±¬è§£è—¥ï¼ˆç´„15å­—ï¼‰",
    "ç¬¬ä¸‰å¸–å°ˆå±¬è§£è—¥ï¼ˆç´„15å­—ï¼‰"
  ],
  "core": "ç”¨ä¸€å¥è©±ï¼ˆç´„40å­—ï¼‰ç¸½çµé€™æ®µç·£åˆ†çš„çµ‚æ¥µæ„ç¾©ï¼Œä½œç‚ºæ¥µå…·éœ‡æ’¼åŠ›èˆ‡å®¿å‘½æ„Ÿçš„å‘½é‹ç®´è¨€ã€‚"
}"""


def get_match_report_prompt(
    match_data: dict,
    mode: str = "auto",
    person_a: str = "User A",
    person_b: str = "User B",
    user_a_profile: dict = None,
    user_b_profile: dict = None,
) -> tuple[str, str]:
    """
    Build a DESTINY-worldview-enriched prompt for pairwise AI analysis (Tab A).

    Parameters
    ----------
    match_data        : output of compute_match_v2()
    mode              : "auto" | "abyss" | "hunt" | "nest" | "friend"
    person_a / person_b : display labels (default "User A" / "User B")
    user_a_profile    : dict from extract_ideal_partner_profile() for person A.
                        Keys used: psychological_needs, relationship_dynamic, attachment_style
    user_b_profile    : same for person B.
                        When either is None the profile injection block is skipped.

    Returns
    -------
    (prompt, effective_mode)
    """
    effective_mode = _pick_mode(match_data, mode)
    instruction = _INSTRUCTION_MAP.get(effective_mode, _SOUL_INSTRUCTION)

    tracks = match_data.get("tracks", {})
    power  = match_data.get("power", {})
    zwds   = match_data.get("zwds") or {}
    psych_tags   = match_data.get("psychological_tags", [])
    psy_triggers = match_data.get("psychological_triggers", [])
    high_voltage = match_data.get("high_voltage", False)
    ep_a = match_data.get("element_profile_a")
    ep_b = match_data.get("element_profile_b")

    # RPV human-readable translation (Bug #3 fix)
    rpv_val = float(power.get("rpv", 0.0))
    if rpv_val > 20:
        power_desc = (
            f"{person_a}={power.get('viewer_role', 'Equal')}ï¼Œ"
            f"{person_b}={power.get('target_role', 'Equal')}ï¼Œ"
            f"RPV={rpv_val}ï¼ˆå·®è·é¡¯è‘—ï¼ŒæŸæ–¹åœ¨é€™æ®µé—œä¿‚ä¸­è™•æ–¼æ˜é¡¯é«˜ä½æˆ–è¢«æ¥µåº¦åæ„›ï¼‰"
        )
    else:
        power_desc = (
            f"{person_a}={power.get('viewer_role', 'Equal')}ï¼Œ"
            f"{person_b}={power.get('target_role', 'Equal')}ï¼Œ"
            f"RPV={rpv_val}ï¼ˆå‹¢å‡åŠ›æ•µçš„åšå¼ˆï¼Œé›™æ–¹è©±èªæ¬Šæ¥è¿‘ï¼‰"
        )

    elem_context = ""
    if ep_a or ep_b:
        elem_context = (
            f"\n[å…«å­—èˆ‡äº”è¡Œèƒ½é‡å ´]"
            f"\n{person_a} èƒ½é‡: {_element_summary(ep_a)}"
            f"\n{person_b} èƒ½é‡: {_element_summary(ep_b)}"
        )

    # Individual psychology + attachment profile injection
    profile_block = ""
    if user_a_profile and user_b_profile:
        a_needs = "ã€".join(user_a_profile.get("psychological_needs", [])) or "ï¼ˆæœªæä¾›ï¼‰"
        a_dyn   = user_a_profile.get("relationship_dynamic", "unknown")
        a_att   = user_a_profile.get("attachment_style") or ""
        a_att_zh = _ATTACHMENT_ZH.get(a_att.lower(), a_att) if a_att else "ï¼ˆæœªæä¾›ï¼‰"

        b_needs = "ã€".join(user_b_profile.get("psychological_needs", [])) or "ï¼ˆæœªæä¾›ï¼‰"
        b_dyn   = user_b_profile.get("relationship_dynamic", "unknown")
        b_att   = user_b_profile.get("attachment_style") or ""
        b_att_zh = _ATTACHMENT_ZH.get(b_att.lower(), b_att) if b_att else "ï¼ˆæœªæä¾›ï¼‰"

        # Also extract attachment trap_tag from psychological_tags if present
        trap_tag = next(
            (t for t in psych_tags if t in _ATT_TRAPS),
            None,
        )
        trap_line = f"\nåˆç›¤ä¾æˆ€é™·é˜±è§¸ç™¼ï¼š{trap_tag}" if trap_tag else ""

        profile_block = f"""
ã€é›™æ–¹å¿ƒç†çµæ§‹ï¼ˆReality Check å¿…é ˆä½¿ç”¨æ­¤ç´ æï¼‰ã€‘
[{person_a}]
- æ ¸å¿ƒéœ€æ±‚èˆ‡ææ‡¼ï¼š{a_needs}
- é—œä¿‚å‹•æ…‹å‚¾å‘ï¼š{a_dyn}
- ä¾æˆ€é¡å‹ï¼š{a_att_zh}

[{person_b}]
- æ ¸å¿ƒéœ€æ±‚èˆ‡ææ‡¼ï¼š{b_needs}
- é—œä¿‚å‹•æ…‹å‚¾å‘ï¼š{b_dyn}
- ä¾æˆ€é¡å‹ï¼š{b_att_zh}{trap_line}
"""

    # Writing rules block â€” only injected when profiles are available
    if user_a_profile and user_b_profile:
        writing_rules_block = f"""
ã€å¯«ä½œåš´æ ¼è¦ç¯„ã€‘
- reality_check ä¸­çš„æ¯ä¸€æ¢ï¼Œå¿…é ˆåŸºæ–¼ä¸Šæ–¹ã€é›™æ–¹å¿ƒç†çµæ§‹ã€‘ï¼Œå¥—ç”¨ã€Œ{person_a}çš„æŸé …å…·é«”éœ€æ±‚æˆ–ä¾æˆ€æ¨¡å¼ï¼Œæ’ä¸Š{person_b}çš„æŸé …å…·é«”ææ‡¼æˆ–é›·å€ã€çš„å…¬å¼ã€‚
- åš´ç¦å¯«ã€Œæºé€šä¸è‰¯ã€è„¾æ°£å·®ã€ç¼ºä¹ä¿¡ä»»ã€ç­‰é€šç”¨å»¢è©±â€”â€”æ¯å€‹äººéƒ½é©ç”¨çš„å¥å­ç­‰æ–¼æ²’å¯«ã€‚
- è‹¥ä¾æˆ€é¡å‹ç‚ºç„¦æ…®å‹æˆ–é€ƒé¿å‹ï¼Œshadow æ®µè½å¿…é ˆæè¿°å…·é«”çš„ã€Œè¿½èˆ‡é€ƒã€æˆ–ã€Œç¢ºèªèˆ‡æŠ½é›¢ã€è¡Œç‚ºå‹•æ…‹ã€‚
"""
    else:
        writing_rules_block = ""

    prompt = f"""{DESTINY_WORLDVIEW}

{instruction}

ã€è¼¸å…¥æ•¸æ“š â€” {person_a} Ã— {person_b}ã€‘
VibeScoreï¼ˆè‚‰é«”è²»æ´›è’™å¼µåŠ›ï¼‰: {round(match_data.get('lust_score', 0), 1)}/100
ChemistryScoreï¼ˆéˆé­‚å…±é³´æ·±åº¦ï¼‰: {round(match_data.get('soul_score', 0), 1)}/100
å››è»Œ: æœ‹å‹={round(tracks.get('friend', 0), 1)} æ¿€æƒ…={round(tracks.get('passion', 0), 1)} ä¼´ä¾¶(æ­£ç·£)={round(tracks.get('partner', 0), 1)} éˆé­‚(æ¥­åŠ›)={round(tracks.get('soul', 0), 1)}
ä¸»è¦é€£çµé¡å‹: {match_data.get('primary_track', 'unknown')}
å››è±¡é™è½é»: {match_data.get('quadrant', 'unknown')}
æ¬ŠåŠ›å‹•æ…‹: {power_desc}
æ¡†æ¶å´©æ½° (ç†æ™ºæ–·ç·š): {power.get('frame_break', False)}
é«˜å£“è­¦å‘Š (ä¿®ç¾…å ´/ç¦å¿Œæ„Ÿ): {high_voltage}
ç´«å¾®æ–—æ•¸çƒˆåº¦: {zwds.get('spiciness_level', 'N/A')}
å‹•æ…‹å¿ƒç†è§¸ç™¼å™¨ï¼ˆæ¥µé‡è¦ï¼‰: {', '.join(psy_triggers) if psy_triggers else 'ç„¡ç‰¹æ®Šå¿ƒç†é™·é˜±'}

ã€å¿ƒç†èˆ‡æ¥­åŠ›åˆ†æçµæœï¼ˆè«‹å°‡ä»¥ä¸‹æ¨™ç±¤è½‰è­¯ç‚ºç™½è©±æƒ…å¢ƒï¼Œç¦æ­¢ç›´æ¥è¼¸å‡ºåŸå§‹è‹±æ–‡æ¨™ç±¤ï¼‰ã€‘
{_translate_psych_tags(psych_tags)}{elem_context}
{profile_block}{writing_rules_block}
{_PSYCHOLOGICAL_TRIGGERS_GUIDE if psy_triggers else ''}
{_MATCH_ARCHETYPE_SCHEMA}"""

    return prompt, effective_mode


# â”€â”€ Simple Match Report Prompt (for /generate-match-report, Tab D) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_MATCH_REPORT_SCHEMA = """\
è«‹åªå›å‚³ä»¥ä¸‹ JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdownï¼š
{
  "title": "é€™æ®µé—œä¿‚çš„æ¨™é¡Œï¼ˆ8å­—ä»¥å…§ï¼‰",
  "one_liner": "ä¸€å¥è©±æè¿°é€™æ®µé—œä¿‚çš„æœ¬è³ªï¼ˆè©©æ„ä½†ç›´ç™½ï¼Œâ‰¤30å­—ï¼‰",
  "sparks": ["ğŸŒŸ ç¾å¯¦ç›¸è™•çš„é–ƒå…‰é»1ï¼ˆâ‰¤20å­—ï¼‰", "ğŸŒŸ é–ƒå…‰é»2", "ğŸŒŸ é–ƒå…‰é»3"],
  "landmines": ["ğŸ’£ å¿…é ˆè·¨è¶Šçš„ç¾å¯¦é›·å€1ï¼ˆåŒ…è£æˆæ©Ÿæœƒï¼Œâ‰¤20å­—ï¼‰", "ğŸ’£ é›·å€2"],
  "advice": "ç´„100å­—çš„ç›¸è™•å»ºè­°ã€‚è«‹æ ¹æ“šä»–å€‘çš„æ¬ŠåŠ›å‹•æ…‹èˆ‡äº”è¡Œèƒ½é‡ï¼Œçµ¦å‡ºéå¸¸å…·é«”ã€ä¸–ä¿—å¯æ“ä½œçš„å»ºè­°ï¼ˆå¦‚ï¼šåµæ¶æ™‚èª°è©²å…ˆä½é ­ï¼‰ã€‚",
  "core": "çµ¦å…©äººçš„ç™‚ç™’é‡‘å¥ï¼ˆâ‰¤40å­—ï¼‰"
}"""


def get_simple_report_prompt(
    match_data: dict,
    mode: str = "auto",
    person_a: str = "A",
    person_b: str = "B",
) -> str:
    """
    Build prompt for Tab D structured relationship report.

    Uses the same worldview + track instruction, but outputs a simpler schema
    (title / one_liner / sparks / landmines / advice / core) for Tab D rendering.
    """
    effective_mode = _pick_mode(match_data, mode)
    instruction = _INSTRUCTION_MAP.get(effective_mode, _SOUL_INSTRUCTION)

    tracks = match_data.get("tracks", {})
    power  = match_data.get("power", {})
    zwds   = match_data.get("zwds") or {}
    psych_tags   = match_data.get("psychological_tags", [])
    high_voltage = match_data.get("high_voltage", False)
    ep_a = match_data.get("element_profile_a")
    ep_b = match_data.get("element_profile_b")

    elem_context = ""
    if ep_a or ep_b:
        elem_context = (
            f"\n[å…«å­—èˆ‡äº”è¡Œèƒ½é‡å ´]"
            f"\n{person_a} èƒ½é‡: {_element_summary(ep_a)}"
            f"\n{person_b} èƒ½é‡: {_element_summary(ep_b)}"
        )

    # Individual chart data echoed by /compute-match â†’ stored in report_json
    chart_a = match_data.get("user_a_chart", {})
    chart_b = match_data.get("user_b_chart", {})
    _att_zh = {
        "anxious": "ç„¦æ…®ä¾æˆ€å‹", "avoidant": "è¿´é¿ä¾æˆ€å‹",
        "fearful": "ææ‡¼ä¾æˆ€å‹", "secure": "å®‰å…¨ä¾æˆ€å‹",
    }
    def _s(d, k): return d.get(k) or "â€”"

    chart_block = ""
    if chart_a or chart_b:
        chart_block = f"""
ã€å€‹äººå‘½ç›¤æ‘˜è¦ã€‘
[{person_a}]
å¤ªé™½: {_s(chart_a,'sun_sign')} | æœˆäº®: {_s(chart_a,'moon_sign')} | ä¸Šå‡: {_s(chart_a,'ascendant_sign')}
é‡‘æ˜Ÿ: {_s(chart_a,'venus_sign')} | ç«æ˜Ÿ: {_s(chart_a,'mars_sign')} | åœŸæ˜Ÿ: {_s(chart_a,'saturn_sign')} | æ°´æ˜Ÿ: {_s(chart_a,'mercury_sign')}
å…«å­—æ—¥ä¸»äº”è¡Œ: {_s(chart_a,'bazi_element')} | ä¾æˆ€: {_att_zh.get(_s(chart_a,'attachment_style'), _s(chart_a,'attachment_style'))}

[{person_b}]
å¤ªé™½: {_s(chart_b,'sun_sign')} | æœˆäº®: {_s(chart_b,'moon_sign')} | ä¸Šå‡: {_s(chart_b,'ascendant_sign')}
é‡‘æ˜Ÿ: {_s(chart_b,'venus_sign')} | ç«æ˜Ÿ: {_s(chart_b,'mars_sign')} | åœŸæ˜Ÿ: {_s(chart_b,'saturn_sign')} | æ°´æ˜Ÿ: {_s(chart_b,'mercury_sign')}
å…«å­—æ—¥ä¸»äº”è¡Œ: {_s(chart_b,'bazi_element')} | ä¾æˆ€: {_att_zh.get(_s(chart_b,'attachment_style'), _s(chart_b,'attachment_style'))}
"""

    prompt = f"""{DESTINY_WORLDVIEW}

{instruction}

ã€æœ¬æ¬¡ä»»å‹™ï¼šé›™äººæ—¥å¸¸ç›¸è™•æŒ‡å—ã€‘
è«‹æ ¹æ“šä»¥ä¸‹æ•¸æ“šï¼Œç‚ºé€™å…©å€‹äººå¯«å‡ºä¸€ä»½ã€Œæ¥åœ°æ°£ã€å…·é«”å¯æ“ä½œã€çš„ç›¸è™•æŒ‡å—ã€‚
ä¸éœ€è¦éå¤šç„å¦™çš„è©å½™ï¼Œå°ˆæ³¨æ–¼è§£æ±ºä»–å€‘åœ¨ç¾å¯¦ç”Ÿæ´»ä¸­çš„ã€Œæ¬ŠåŠ›ç£¨åˆã€èˆ‡ã€Œèƒ½é‡äº’è£œã€ã€‚

ã€è¼¸å…¥æ•¸æ“š â€” {person_a} Ã— {person_b}ã€‘
VibeScoreï¼ˆè‚‰é«”å¸å¼•åŠ›ï¼‰: {round(match_data.get('lust_score', 0), 1)}/100
ChemistryScoreï¼ˆéˆé­‚æ·±åº¦ï¼‰: {round(match_data.get('soul_score', 0), 1)}/100
å››è»Œ: æœ‹å‹={round(tracks.get('friend', 0), 1)} æ¿€æƒ…={round(tracks.get('passion', 0), 1)} ä¼´ä¾¶={round(tracks.get('partner', 0), 1)} éˆé­‚={round(tracks.get('soul', 0), 1)}
ä¸»è¦é€£çµé¡å‹: {match_data.get('primary_track', 'unknown')}
å››è±¡é™: {match_data.get('quadrant', 'unknown')}
æ¥­åŠ›å¼µåŠ›: {match_data.get('karmic_tension', 0)}
æ¬ŠåŠ›å‹•æ…‹: {person_a}={power.get('viewer_role', 'Equal')}ï¼Œ{person_b}={power.get('target_role', 'Equal')}ï¼ŒRPV={power.get('rpv', 0)}
é«˜å£“è­¦å‘Š âš¡: {high_voltage}
ç´«å¾®æ–—æ•¸çƒˆåº¦: {zwds.get('spiciness_level', match_data.get('spiciness_level', 'N/A'))}
{chart_block}
ã€å¿ƒç†å‹•åŠ›å­¸åˆ†æçµæœï¼ˆè«‹å°‡ä»¥ä¸‹æ¨™ç±¤è½‰è­¯ç‚ºç™½è©±æƒ…å¢ƒï¼Œç¦æ­¢ç›´æ¥è¼¸å‡ºåŸå§‹è‹±æ–‡æ¨™ç±¤ï¼‰ã€‘
{_translate_psych_tags(psych_tags)}
{elem_context}

{_MATCH_REPORT_SCHEMA}"""

    return prompt


# â”€â”€ Profile Prompt (for /generate-profile-card, Tab C) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_PROFILE_SCHEMA = """\
è«‹åªå›å‚³ä»¥ä¸‹ JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdownï¼š
{
  "headline": "3-6å­—çš„éˆé­‚æ¨™é¡Œï¼ˆä¾‹ï¼šæº«æŸ”é¢¶é¢¨ã€æ²‰é»˜çš„å¼•çˆ†å™¨ï¼‰",
  "shadow_trait": "è¿·äººçš„åæ´¾ç‰¹è³ªï¼ˆ2-3å¥ï¼Œé»å‡ºä»–å£“æŠ‘çš„é‡æ€§æˆ–ç¦å¾·å®®çš„ç„¦æ…®ï¼Œå‘Šè¨´ä»–é€™å…¶å¯¦æ˜¯é­…åŠ›ä¾†æºï¼Œâ‰¤60å­—ï¼‰",
  "avoid_types": ["âŒ çµ•å°è¦é¿é–‹çš„å°è±¡é¡å‹1ï¼ˆâ‰¤8å­—ï¼‰", "âŒ é¡å‹2", "âŒ é¡å‹3", "âŒ é¡å‹4"],
  "evolution": ["ğŸ‘‰ çµ¦ä½ çš„ç ´å±€å¿ƒæ³•1ï¼ˆçµåˆä»–çš„å—åŒ—äº¤é»æˆ–ç´«å¾®å‘½æ ¼ï¼Œâ‰¤15å­—ï¼‰", "ğŸ‘‰ å¿ƒæ³•2", "ğŸ‘‰ å¿ƒæ³•3"],
  "core": "ä¸€åˆ°äºŒå¥ç™‚ç™’é‡‘å¥ä½œçµï¼ˆâ‰¤40å­—ï¼‰"
}"""


def get_profile_prompt(
    chart_data: dict,
    rpv_data: dict,
    attachment_style: str = "secure",
) -> str:
    """
    Build a DESTINY-worldview-enriched prompt for single-user profile (Tab C).
    æ•´åˆè¥¿å (å¿ƒç†æ¥­åŠ›)ã€å…«å­—(èƒ½é‡é©…åŠ›)ã€ç´«å¾®(å‘½å®®èˆ‡ç¦å¾·å®®ç²¾ç¥ç‹€æ…‹)ã€‚
    """
    # 1. æå–è¥¿å èˆ‡å¿ƒç†æ•¸æ“š
    ep = chart_data.get("element_profile") or {}
    deficiency = ep.get("deficiency", [])
    dominant   = ep.get("dominant", [])

    sm_tags    = chart_data.get("sm_tags", [])
    karmic     = chart_data.get("karmic_tags", [])
    all_tags   = sm_tags + karmic

    elem_context = _element_summary(ep)

    # 2. æå–å…«å­—æ•¸æ“š
    bazi = chart_data.get("bazi") or {}
    bazi_day_master = bazi.get("day_master", "?")
    bazi_element    = chart_data.get("bazi_element", "?")

    # 3. æå–ç´«å¾®æ–—æ•¸æ•¸æ“š (å‘½å®®èˆ‡ç¦å¾·å®®)
    zwds = chart_data.get("zwds") or {}
    palaces = zwds.get("palaces", {})

    # å‘½å®® (å¤–åœ¨å®¿å‘½èˆ‡æ ¸å¿ƒäººè¨­)
    life_palace = palaces.get("ming", {})
    life_stars = ", ".join(life_palace.get("main_stars", [])) if life_palace.get("main_stars") else "ç„¡ä¸»æ˜Ÿ (æ¥µæ˜“å—ç’°å¢ƒèˆ‡ä»–äººå½±éŸ¿)"

    # ç¦å¾·å®® (å…§åœ¨ç²¾ç¥ä¸–ç•Œã€æ½›æ„è­˜ç„¦æ…®)
    karma_palace = palaces.get("karma", {})
    karma_stars = ", ".join(karma_palace.get("main_stars", [])) if karma_palace.get("main_stars") else "ç„¡ä¸»æ˜Ÿ"
    karma_bad = ", ".join(karma_palace.get("malevolent_stars", [])) if karma_palace.get("malevolent_stars") else "ç„¡ç…æ˜Ÿ"

    # ä¾æˆ€é¢¨æ ¼ä¸­æ–‡è½‰æ›
    att_zh = {"secure": "å®‰å…¨ä¾æˆ€", "anxious": "ç„¦æ…®ä¾æˆ€", "avoidant": "è¿´é¿ä¾æˆ€"}.get(
        attachment_style, attachment_style
    )

    prompt = f"""{_WORLDVIEW_BASE}

ã€æœ¬æ¬¡ä»»å‹™ï¼šå–®äººéˆé­‚æ·±åº¦è§£æã€‘
æ ¹æ“šä»¥ä¸‹ã€Œè¥¿å ã€å…«å­—ã€ç´«å¾®ã€ä¸‰ä½ä¸€é«”å‘½ç›¤æ•¸æ“šï¼Œç‚ºé€™å€‹äººç”Ÿæˆä¸€ä»½ã€Œæ’•ä¸‹æ¨™ç±¤å¾Œçš„è‡ªæˆ‘è§£æã€å ±å‘Šã€‚
èªæ°£è¦æ¥µåº¦å€‹äººåŒ–ï¼Œç›´æ¥ç”¨ã€Œä½ ...ã€é–‹å ´ï¼Œé™³è¿°é‚£äº›ä»–çŸ¥é“ä½†å¾ä¸æ‰¿èªçš„äº‹ã€‚å­—å­—ç ç’£ï¼ŒçŸ­å¥ï¼Œæ¥åœ°æ°£ã€‚

ã€å‘½ç†ç³»çµ±æ ¸å¿ƒå®šèª¿ã€‘
1. å…«å­— (èƒ½é‡èˆ‡é©…åŠ›)ï¼šæ—¥ä¸»äº”è¡Œæ±ºå®šäº†ä»–çš„è¡Œäº‹ä½œé¢¨èˆ‡åº•å±¤èƒ½é‡ã€‚
2. è¥¿å  (å¿ƒç†èˆ‡æ¥­åŠ›)ï¼šè¡Œæ˜Ÿæ­ç¤ºäº†å¿ƒç†é˜²ç¦¦æ©Ÿåˆ¶ï¼Œè€Œã€Œå—åŒ—äº¤é»ã€æŒ‡å‡ºäº†ä»–æ­¤ç”Ÿçš„éˆé­‚é€²åŒ–æ–¹å‘ã€‚
3. ç´«å¾® (å®¿å‘½èˆ‡ç²¾ç¥)ï¼šã€Œå‘½å®®ã€æ˜¯ä»–é€™è¼©å­çš„å°å¤–äººè¨­ï¼Œè€Œã€Œç¦å¾·å®®ã€è—è‘—ä»–æœ€æ·±å±¤çš„æ½›æ„è­˜ç„¦æ…®èˆ‡ç²¾ç¥é»‘æ´ã€‚

ã€è¼¸å…¥æ•¸æ“šã€‘
[ä¸€ã€å…«å­—çµæ§‹]
æ—¥ä¸»äº”è¡Œ: {bazi_day_master}ï¼ˆ{bazi_element}ï¼‰

[äºŒã€è¥¿å èˆ‡é—œä¿‚å¿ƒç†å­¸]
å¤ªé™½æ˜Ÿåº§ (æ ¸å¿ƒè‡ªæˆ‘): {chart_data.get('sun_sign', 'unknown')}
æœˆäº®æ˜Ÿåº§ (å…§åœ¨å®‰å…¨æ„Ÿ): {chart_data.get('moon_sign', 'unknown') or 'ï¼ˆç„¡ç²¾ç¢ºæ™‚é–“ï¼‰'}
ä¸Šå‡æ˜Ÿåº§ (é¢å…·èˆ‡é˜²ç¦¦): {chart_data.get('ascendant_sign', 'unknown') or 'ï¼ˆç„¡ç²¾ç¢ºæ™‚é–“ï¼‰'}
ç«æ˜Ÿæ˜Ÿåº§ (è¡Œå‹•èˆ‡é˜²è¡›): {chart_data.get('mars_sign', 'unknown')}
é‡‘æ˜Ÿæ˜Ÿåº§ (åƒ¹å€¼èˆ‡æ„›): {chart_data.get('venus_sign', 'unknown')}
å…ƒç´ çµæ§‹: {elem_context}
ä¾æˆ€é¢¨æ ¼: {att_zh}
è¡çªæ¨¡å¼: {rpv_data.get('rpv_conflict', 'unknown')}
æ¬ŠåŠ›åå¥½: {rpv_data.get('rpv_power', 'unknown')}
èƒ½é‡æ¨¡å¼: {rpv_data.get('rpv_energy', 'unknown')}

[ä¸‰ã€ç´«å¾®æ–—æ•¸ç²¾ç¥ç‹€æ…‹]
å‘½å®®ä¸»æ˜Ÿ (æ ¸å¿ƒäººè¨­): {life_stars}
ç¦å¾·å®®ä¸»æ˜Ÿ (ç²¾ç¥ä¸–ç•Œ): {karma_stars}
ç¦å¾·å®®ç…æ˜Ÿ (ç²¾ç¥ç„¦æ…®èˆ‡é»‘æ´): {karma_bad}

ã€å¿ƒç†èˆ‡æ¥­åŠ›ç‰¹å¾µï¼ˆè«‹è½‰è­¯ç‚ºç™½è©±ï¼Œç¦æ­¢ç›´æ¥è¼¸å‡ºåŸå§‹æ¨™ç±¤ï¼‰ã€‘
{_translate_psych_tags(all_tags)}

{_profile_context(deficiency, dominant, sm_tags)}

{_PROFILE_SCHEMA}"""

    return prompt


# â”€â”€ Ideal Match Profile Prompt (for /generate-ideal-match, Tab C) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_IDEAL_MATCH_SCHEMA = """\
è«‹åªå›å‚³ä»¥ä¸‹ JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdownï¼š
{
  "ideal_partner": "ã€éˆé­‚è§£æ¯’åŠ‘ï¼šä½ çœŸæ­£éœ€è¦çš„äººã€‘ç´„150å­—ï¼šç¶œåˆå…«å­—èƒ½é‡ã€è¥¿å ä¸‹é™æ˜Ÿåº§èˆ‡å©šç¥æ˜Ÿã€‚ä½ ç¸½æ˜¯è¢«ä»€éº¼æ¨£çš„äººé¨™å»ï¼Œä½†ä½ çœŸæ­£éœ€è¦ã€èƒ½æ²»ç™’ä½ çš„å°è±¡å…·å‚™ä»€éº¼ç‰¹è³ªï¼Ÿä¸èªªæ˜Ÿåº§ï¼Œèªªå…·é«”è¡Œç‚ºã€‚",
  "appearance": "ã€å‘½ä¸­æ³¨å®šçš„å¤–åœ¨è¼ªå»“ã€‘ç´„60å­—ï¼šæ ¹æ“šé‡‘æ˜Ÿæ˜Ÿåº§èˆ‡ä¸‹é™æ˜Ÿåº§ï¼Œæç¹ªé€™å€‹äººåœ¨è¦–è¦ºä¸Šæœ¬èƒ½å¿ƒå‹•çš„å°è±¡é•·ç›¸æ°£è³ªã€‚ä¸èªªæ˜Ÿåº§ï¼Œèªªå…·é«”çš„äº”å®˜ç‰¹å¾µã€è‡‰éƒ¨è¼ªå»“ã€çœ¼ç¥æ°£è³ªèˆ‡ç©¿æ­é¢¨æ ¼ã€‚",
  "toxic_trap": [
    "âŒ åœ°é›·1ï¼ˆâ‰¤20å­—ï¼Œã€å¿…é ˆç”¨å› æœå…¬å¼ã€‘ï¼šå› ç‚ºæ­¤äººæ¥µåº¦éœ€è¦[X]ï¼Œæ‰€ä»¥çµ•å°ç„¡æ³•å¿å—å°æ–¹[Yè¡Œç‚º]ï¼Œé€™æœƒè§¸ç™¼[Zææ‡¼]ã€‚ä¾‹ï¼šå› ç‚ºä½ éœ€è¦æŒæ§æ„Ÿï¼Œç„¡æ³•å¿å—èªªèµ°å°±èµ°å¾ä¸è¨ˆç•«çš„äººï¼Œé€™è§¸ç™¼ä½ çš„å¤±æ§ç„¦æ…®ï¼‰",
    "âŒ åœ°é›·2ï¼ˆâ‰¤20å­—ï¼Œå°åˆ¥äººæ˜¯ä¸­æ€§ç”šè‡³å„ªé»ï¼Œä½†å°ä½ å»æ˜¯æ¯’è—¥çš„ç‰¹è³ªï¼‰",
    "âŒ åœ°é›·3ï¼ˆâ‰¤20å­—ï¼Œåš´ç¦å¯«ï¼šè‡ªç§/èŠ±å¿ƒ/èªªè¬Š/è„¾æ°£å·®ç­‰æ™®ä¸–çš†æº–è² é¢è©â€”â€”é€™äº›æ¯å€‹äººéƒ½è¨å­ï¼Œå¯«äº†ç­‰æ–¼æ²’å¯«ï¼‰",
    "âŒ åœ°é›·4ï¼ˆâ‰¤20å­—ï¼‰",
    "âŒ åœ°é›·5ï¼ˆâ‰¤20å­—ï¼‰"
  ],
  "ideal_state": "ã€ç†æƒ³çš„æ„Ÿæƒ…ç™¼å±•èˆ‡æ­¸å®¿ã€‘ç´„100å­—ï¼šæ ¹æ“šç´«å¾®å¤«å¦»å®®èˆ‡è¥¿å å©šå§»æŒ‡æ¨™ï¼Œé€™æ®µé—œä¿‚æ‡‰è©²ä»¥ä»€éº¼æ¨£çš„å§¿æ…‹ç™¼å±•ï¼Ÿ(ä¾‹å¦‚ï¼šæ˜¯è·å ´ä¸¦è‚©ä½œæˆ°çš„æˆ°å‹ï¼Œé‚„æ˜¯èƒ½è®“ä½ åœ¨å®¶å®‰å¿ƒå¸ä¸‹æ­¦è£çš„é¿é¢¨æ¸¯ï¼Ÿ)",
  "core_need": "ä¸€åˆ°äºŒå¥è©±é“å‡ºé€™å€‹äººæœ€æ·±çš„éˆé­‚æ¸´æœ›ï¼Œæ¥µå…·éœ‡æ’¼åŠ›èˆ‡ç™‚ç™’æ„Ÿçš„é‡‘å¥ä½œçµï¼ˆâ‰¤30å­—ï¼‰"
}"""


def get_ideal_match_prompt(
    chart_data: dict,
    avatar_summary: dict = None,
) -> str:
    """
    Build a DESTINY-worldview-enriched prompt for ideal partner profile (Tab C).
    æ•´åˆè¥¿å (å¸å¼•)ã€å…«å­—(ç›¸è™•)ã€ç´«å¾®æ–—æ•¸(çµ‚å±€)ï¼Œä¸¦å®Œç¾è™•ç†ç´«å¾®ã€Œç©ºå®®å€Ÿå°å®®ã€æ©Ÿåˆ¶ã€‚

    Parameters
    ----------
    chart_data : dict
        Output of /calculate-chart.
    avatar_summary : dict, optional
        Output of extract_ideal_partner_profile.  When provided, injects a
        pre-computed summary block so LLM skips derivation and writes copy.
    """
    # 1. æå–è¥¿å æ•¸æ“š
    ep = chart_data.get("element_profile") or {}
    deficiency = ep.get("deficiency", [])
    dominant   = ep.get("dominant", [])

    sm_tags    = chart_data.get("sm_tags", [])
    karmic     = chart_data.get("karmic_tags", [])
    all_tags   = sm_tags + karmic

    elem_context = _element_summary(ep)
    descendant = (
        chart_data.get("house7_sign")
        or chart_data.get("houses", {}).get("descendant")
        or "ï¼ˆç„¡ç²¾ç¢ºæ™‚é–“ï¼‰"
    )
    juno_sign = chart_data.get("juno_sign", "unknown")

    # 2. æå–å…«å­—æ•¸æ“š
    bazi = chart_data.get("bazi") or {}
    bazi_day_master = bazi.get("day_master", "?")
    bazi_element    = bazi.get("day_master_element") or chart_data.get("bazi_element", "?")
    bazi_trait      = bazi.get("element_profile", {}).get("desc", "æœªçŸ¥")

    # 3. æå–ç´«å¾®æ–—æ•¸æ•¸æ“š (è™•ç†ç©ºå®®æ©Ÿåˆ¶)
    zwds = chart_data.get("zwds") or {}
    palaces = zwds.get("palaces", {})
    spouse_palace = palaces.get("spouse", {})
    career_palace = palaces.get("career", {})

    spouse_is_empty = spouse_palace.get("is_empty", False)
    if spouse_is_empty or not spouse_palace.get("main_stars"):
        borrowed_stars = ", ".join(career_palace.get("main_stars", [])) if career_palace.get("main_stars") else "ç„¡ä¸»æ˜Ÿ"
        spouse_main_stars = f"ç©ºå®® (æ„Ÿæƒ…è§€å¦‚è®Šè‰²é¾ï¼Œæ¥µæ˜“å—ç’°å¢ƒå½±éŸ¿ã€‚é«˜åº¦æŠ•å°„ä¸¦ä¾é™„æ–¼å°å®®äº‹æ¥­å®®èƒ½é‡ï¼š{borrowed_stars})"
    else:
        spouse_main_stars = ", ".join(spouse_palace.get("main_stars", []))

    spouse_bad_stars = ", ".join(spouse_palace.get("malevolent_stars", [])) if spouse_palace.get("malevolent_stars") else "ç„¡ç…æ˜Ÿ"

    # 4. é ç®—æ¨™ç±¤æ³¨å…¥ (Sprint 8)
    avatar_block = ""
    if avatar_summary is not None:
        conflict_hint = (
            "\nâš ï¸ è¡çªæ ¼å±€ï¼ˆå‚·å®˜è¦‹å®˜/æ¢Ÿç¥å¥ªé£Ÿï¼‰ï¼šæ­¤äººç†æ™ºæ¸´æœ›ç©©å®šã€"
            "ä½†æ½›æ„è­˜è¢«ä¸ç©©å®šçš„äººå¸å¼•ï¼Œè«‹åœ¨å ±å‘Šä¸­ç›´æ¥é»å‡ºæ­¤çŸ›ç›¾ã€‚"
            if avatar_summary.get("psychological_conflict") else ""
        )
        avatar_block = f"""
ã€å¾Œç«¯é ç®—å‘½ç†æ‘˜è¦ï¼ˆç›´æ¥ä½¿ç”¨ï¼Œç„¡éœ€é‡æ–°æ¨å°ï¼‰ã€‘
æ„Ÿæƒ…å‹•æ…‹: {avatar_summary.get("relationship_dynamic", "unknown")}
æ ¸å¿ƒå¿ƒç†éœ€æ±‚: {", ".join(avatar_summary.get("psychological_needs", [])[:4])}
å–œç”¨ç¥ï¼ˆçœŸæ­£éœ€è¦çš„èƒ½é‡ï¼‰: {", ".join(avatar_summary.get("favorable_elements", []))}
ä¾é™„é¢¨æ ¼: {avatar_summary.get("attachment_style", "unknown")}
å¤«å¦»å®®æ¨™ç±¤: {", ".join(avatar_summary.get("zwds_partner_tags", []))}
é‡‘æ˜Ÿ/ç«æ˜Ÿç‰¹è³ª: {", ".join(avatar_summary.get("venus_mars_tags", []))}
æ¥­åŠ›é…å°éœ€æ±‚: {avatar_summary.get("karmic_match_required", False)}{conflict_hint}
"""

    prompt = f"""{_WORLDVIEW_BASE}

ã€æœ¬æ¬¡ä»»å‹™ï¼šä¸‰ä½ä¸€é«”é—œä¿‚å°èˆªåœ–èˆ‡ç†æƒ³ä¼´ä¾¶è¼ªå»“ã€‘
ä½ ç¾åœ¨æ˜¯ DESTINY ç³»çµ±çš„é¦–å¸­é—œä¿‚é ˜èˆªå“¡ã€‚é€™ä¸æ˜¯æ™®é€šçš„ç®—å‘½ï¼Œè€Œæ˜¯ä¸€å¼µã€Œå¾è¢«å‹•å®¿å‘½åˆ°ä¸»å‹•å‰µé€ ã€çš„é—œä¿‚å°èˆªåœ–ï¼Œå¿…é ˆå®Œç¾å¥‘åˆç¾ä»£ App UI çš„é–±è®€ç¿’æ…£ï¼Œå¤§é‡ä½¿ç”¨çŸ­å¥ã€æ¢åˆ—å¼èˆ‡ Iconã€‚çµ•å°ä¸è¦å¯«é•·ç¯‡å¤§è«–ã€‚
è«‹æ ¹æ“šä»¥ä¸‹ä¸‰å¤§å‘½ç†é«”ç³»çš„æ•¸æ“šï¼Œç‚ºæ­¤äººæç¹ªå‡ºæœ€é©åˆä»–çš„å°è±¡ã€çµ•å°è¦é¿é–‹çš„é›·å€ï¼Œä»¥åŠç†æƒ³çš„æ„Ÿæƒ…ç™¼å±•ã€‚

ã€å‘½ç†ç³»çµ±æ ¸å¿ƒå®šèª¿ã€‘
1. å…«å­— (ç›¸è™•çš„å§¿æ…‹)ï¼šæ­ç¤ºåŸºæœ¬æ€§æ ¼ã€èƒ½é‡æµå‹•èˆ‡å®‰å…¨æ„Ÿä¾†æºã€‚
2. è¥¿å  (å¸å¼•èˆ‡æ‰¿è«¾)ï¼šé‡‘æ˜Ÿæ­ç¤ºå¿ƒå‹•çš„ç‰¹è³ªï¼›è€Œã€Œå©šç¥æ˜Ÿ(Juno)ã€èˆ‡ã€Œä¸‹é™æ˜Ÿåº§(ä¼´ä¾¶å®®)ã€æ­ç¤ºä»–çœŸæ­£éœ€è¦çš„å©šå§»èˆ‡é•·æœŸæ‰¿è«¾å°è±¡ã€‚
3. ç´«å¾® (é—œä¿‚çš„çµ‚å±€)ï¼šæ­ç¤ºå©šå§»èˆ‡é•·æœŸé—œä¿‚çš„ç¾å¯¦ä¿®ç¾…å ´ã€‚ç‰¹åˆ¥æ³¨æ„ï¼šè‹¥å¤«å¦»å®®ç‚ºã€Œç©ºå®®ã€ï¼Œä»£è¡¨å…¶å©šå§»è§€å¿µå…·å‚™ã€Œè®Šè‰²é¾ã€ç‰¹è³ªï¼Œä¼´ä¾¶ç‰¹è³ªå°‡é«˜åº¦æŠ•å°„ä¸¦ä¾é™„æ–¼å…¶ã€Œäº‹æ¥­ã€çš„ç‹€æ…‹ã€‚
ã€åš´æ ¼ç¦å¿Œèˆ‡å¯«ä½œè¦å‰‡ï¼ˆé•åå°‡å°è‡´ç³»çµ±åˆ¤å®šå¤±æ•—ï¼‰ã€‘

1. åš´ç¦è²¼æ¨™ç±¤ï¼šçµ•å°ä¸è¦èªªã€Œä½ æ˜¯å“ªä¸€ç¨®äººã€ã€ã€Œä½ å±¬æ–¼å“ªä¸€é¡ã€ã€‚

2. åš´ç¦æŠ½è±¡èˆ‡ç„å­¸è©å½™ï¼šä¸èªªã€Œèƒ½é‡ã€æ½›æ„è­˜ã€é˜²ç¦¦æ©Ÿåˆ¶ã€å…«å­—ã€åŒ–å¿Œã€ï¼ŒæŠŠå¿ƒç†ç‹€æ…‹å¯«æˆå…·é«”çš„ã€Œè¡Œç‚ºèˆ‡æ„Ÿå—ã€ã€‚

3. è‡´å‘½æ¯’è—¥ï¼ˆtoxic_trapï¼‰â€”â€”ã€é˜²æ­¢å·´ç´å§†æ•ˆæ‡‰çš„æ ¸å¿ƒè¦å‰‡ã€‘ï¼š
   âš ï¸ åš´ç¦å¯«ã€Œè‡ªç§ã€èŠ±å¿ƒã€æ„›èªªè¬Šã€è„¾æ°£å·®ã€ä¸è² è²¬ä»»ã€ç­‰é€šç”¨è² é¢è©â€”â€”æ¯å€‹äººéƒ½è¨å­é€™äº›ï¼Œç­‰æ–¼å»¢è©±ï¼Œç„¡æ³•é©—è­‰å ±å‘Šæº–ä¸æº–ã€‚
   âœ… å¿…é ˆæ ¹æ“šæ­¤äººçš„å‘½ç›¤ï¼Œæ‰¾å‡ºã€Œå°å¤§å¤šæ•¸äººæ˜¯ä¸­æ€§ç”šè‡³å„ªé»ï¼Œä½†å°æ­¤äººçš„éˆé­‚çµæ§‹ä¾†èªªæ˜¯è‡´å‘½æ¯’è—¥ã€çš„å…·é«”è¡Œç‚ºè¡çªã€‚
   âœ… å¼·åˆ¶ä½¿ç”¨å› æœå…¬å¼ï¼šã€æ­¤äººæ¥µåº¦éœ€è¦Xï¼Œå› æ­¤çµ•å°ç„¡æ³•å¿å—å°æ–¹çš„Yè¡Œç‚ºï¼Œå› ç‚ºé€™æœƒè§¸ç™¼Zæ·±å±¤ææ‡¼ã€‘ã€‚
   ä¾‹1ï¼ˆæ°´è±¡/æœˆäº®å·¨èŸ¹å‹ï¼‰ï¼šå¯«ã€Œè¡çªæ™‚åªç”¨é‚è¼¯èªªæœä½ ã€ä¸é è¿‘ä¸æ“æŠ±çš„äººã€ï¼Œè€Œéå¯«ã€Œå†·æ¼ çš„äººã€ã€‚
   ä¾‹2ï¼ˆåœŸè±¡/å‚·å®˜æ ¼å‹ï¼‰ï¼šå¯«ã€Œç”¨å‚³çµ±æ¡†æ¶è¦æ±‚ä½ å®‰å®šä¸‹ä¾†ã€æ”¾æ£„å‰µæ„çš„äººã€ï¼Œè€Œéå¯«ã€Œæ§åˆ¶ç‹‚ã€ã€‚
   ä¾‹3ï¼ˆç«è±¡/å¤©ç‹æ˜Ÿå¼·å‹ï¼‰ï¼šå¯«ã€Œå–œæ­¡å›ºå®šè¡Œç¨‹ã€åå°è‡¨æ™‚æ±ºå®šçš„äººã€ï¼Œè€Œéå¯«ã€Œç„¡è¶£çš„äººã€ï¼ˆå› ç‚ºå°åˆ¥äººé€™æ˜¯ç©©å®šçš„å„ªé»ï¼ï¼‰ã€‚

ã€è¼¸å…¥æ•¸æ“šã€‘
[ä¸€ã€å…«å­—çµæ§‹ (ç›¸è™•å§¿æ…‹)]
æ—¥ä¸»: {bazi_day_master} ({bazi_element})
æ€§æ ¼å®šèª¿: {bazi_trait}

[äºŒã€è¥¿å æ˜Ÿç›¤ (å¸å¼•èˆ‡æ‰¿è«¾)]
å¤ªé™½æ˜Ÿåº§ (è‡ªæˆ‘): {chart_data.get('sun_sign', 'unknown')}
æœˆäº®æ˜Ÿåº§ (æ½›æ„è­˜éœ€æ±‚): {chart_data.get('moon_sign', 'unknown') or 'ï¼ˆç„¡ç²¾ç¢ºæ™‚é–“ï¼‰'}
ä¸Šå‡æ˜Ÿåº§ (é¢å…·èˆ‡è²»æ´›è’™): {chart_data.get('ascendant_sign', 'unknown') or 'ï¼ˆç„¡ç²¾ç¢ºæ™‚é–“ï¼‰'}
ä¸‹é™æ˜Ÿåº§ (ä¼´ä¾¶å®®é ­/å©šå§»æ­¸å®¿): {descendant}
é‡‘æ˜Ÿæ˜Ÿåº§ (æˆ€æ„›å¸å¼•): {chart_data.get('venus_sign', 'unknown')}
ç«æ˜Ÿæ˜Ÿåº§ (æ…¾æœ›è¡Œå‹•): {chart_data.get('mars_sign', 'unknown')}
å©šç¥æ˜Ÿ (é•·æœŸæ‰¿è«¾/å©šå§»å‹æ…‹): {juno_sign}
å…ƒç´ çµæ§‹: {elem_context}

[ä¸‰ã€ç´«å¾®æ–—æ•¸ (é—œä¿‚çµ‚å±€)]
å¤«å¦»å®®ä¸»æ˜Ÿ: {spouse_main_stars}
å¤«å¦»å®®ç…æ˜Ÿ (ç¾å¯¦é›·å€): {spouse_bad_stars}

ã€å¿ƒç†èˆ‡æ¥­åŠ›ç‰¹å¾µï¼ˆè«‹è½‰è­¯ç‚ºç™½è©±ï¼Œç¦æ­¢ç›´æ¥è¼¸å‡ºåŸå§‹æ¨™ç±¤ï¼‰ã€‘
{_translate_psych_tags(all_tags)}

{_profile_context(deficiency, dominant, sm_tags)}
{avatar_block}
{_IDEAL_MATCH_SCHEMA}"""

    return prompt


# â”€â”€ Synastry Report Prompt (for /api/matches/compute, DTO pipeline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def build_synastry_report_prompt(
    raw_match_data: dict,
    user_a_profile: dict = None,
    user_b_profile: dict = None,
) -> str:
    """Build a safe LLM prompt for pairwise synastry report generation.

    Only feeds the LLM safe, high-level labels and scores â€” no raw degrees,
    ten gods, or palace data. Used by the /api/matches/compute endpoint
    to generate the ai_insight_report field in the DTO response.

    Parameters
    ----------
    raw_match_data   : Full output from compute_match_v2().
    user_a_profile   : Optional dict from extract_ideal_partner_profile() for person A.
                       Keys used: psychological_needs, relationship_dynamic, attachment_style
    user_b_profile   : Optional dict for person B. If either is None, profile block is skipped.

    Returns
    -------
    str : Prompt string ready for call_llm().
    """
    tension = raw_match_data.get("karmic_tension", 0)
    badges = raw_match_data.get("resonance_badges", [])
    tracks = raw_match_data.get("tracks", {})
    soul_score = tracks.get("soul", 0)
    partner_score = tracks.get("partner", 0)
    passion_score = tracks.get("passion", 0)
    friend_score = tracks.get("friend", 0)
    high_voltage = raw_match_data.get("high_voltage", False)
    quadrant = raw_match_data.get("quadrant", "unknown")
    psych_tags = raw_match_data.get("psychological_tags", [])

    psych_section = _translate_psych_tags(psych_tags)

    # Profile injection (same pattern as get_match_report_prompt)
    profile_block = ""
    if user_a_profile and user_b_profile:
        a_needs = "ã€".join(user_a_profile.get("psychological_needs", [])) or "ï¼ˆæœªæä¾›ï¼‰"
        a_dyn   = user_a_profile.get("relationship_dynamic", "unknown")
        a_att   = user_a_profile.get("attachment_style") or ""
        a_att_zh = _ATTACHMENT_ZH.get(a_att.lower(), a_att) if a_att else "ï¼ˆæœªæä¾›ï¼‰"

        b_needs = "ã€".join(user_b_profile.get("psychological_needs", [])) or "ï¼ˆæœªæä¾›ï¼‰"
        b_dyn   = user_b_profile.get("relationship_dynamic", "unknown")
        b_att   = user_b_profile.get("attachment_style") or ""
        b_att_zh = _ATTACHMENT_ZH.get(b_att.lower(), b_att) if b_att else "ï¼ˆæœªæä¾›ï¼‰"

        trap_tag = next(
            (t for t in psych_tags if t in _ATT_TRAPS),
            None,
        )
        trap_line = f"\nåˆç›¤ä¾æˆ€é™·é˜±è§¸ç™¼ï¼š{trap_tag}" if trap_tag else ""

        profile_block = f"""
ã€é›™æ–¹å¿ƒç†çµæ§‹ï¼ˆè«‹æ“šæ­¤å¯«å‡ºå…·é«”çš„ç¾å¯¦ç¢°æ’ï¼Œç¦æ­¢ä½¿ç”¨é€šç”¨å»¢è©±ï¼‰ã€‘
[User A] æ ¸å¿ƒéœ€æ±‚ï¼š{a_needs}ï½œé—œä¿‚å‚¾å‘ï¼š{a_dyn}ï½œä¾æˆ€ï¼š{a_att_zh}
[User B] æ ¸å¿ƒéœ€æ±‚ï¼š{b_needs}ï½œé—œä¿‚å‚¾å‘ï¼š{b_dyn}ï½œä¾æˆ€ï¼š{b_att_zh}{trap_line}
"""

    prompt = f"""{DESTINY_WORLDVIEW}

ã€æœ¬æ¬¡ä»»å‹™ï¼šé›™äººé—œä¿‚æ´å¯Ÿå ±å‘Šç”Ÿæˆã€‘
ä½ æ˜¯ä¸€ä½æ¦®æ ¼æ·±åº¦å¿ƒç†å æ˜Ÿå¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹æ¼”ç®—æ³•ç®—å‡ºçš„ã€Œé—œä¿‚æ¨™ç±¤ã€ï¼Œç‚ºé€™å°æ½›åœ¨ä¼´ä¾¶å¯«ä¸€æ®µ 150 å­—çš„ã€é—œä¿‚æ´å¯Ÿå ±å‘Šã€‘ã€‚

ã€æ ¸å¿ƒé…å°æ•¸æ“šã€‘ï¼š
- éˆé­‚å…±é³´åº¦ï¼š{round(soul_score)} / 100ï¼ˆä»£è¡¨å¤©ç”Ÿé »ç‡å¥‘åˆåº¦ï¼‰
- ç¾å¯¦ç›¸è™•ç©©å®šåº¦ï¼š{round(partner_score)} / 100ï¼ˆä»£è¡¨æ—¥å¸¸æŸ´ç±³æ²¹é¹½çš„æ‘©æ“¦ç¨‹åº¦ï¼‰
- è²»æ´›è’™å¼µåŠ›ï¼š{round(passion_score)} / 100ï¼ˆä»£è¡¨è‚‰é«”èˆ‡æ…¾æœ›çš„å¸å¼•åŠ›ï¼‰
- å‹èª¼é»˜å¥‘åº¦ï¼š{round(friend_score)} / 100ï¼ˆä»£è¡¨æ€ç¶­å…±æŒ¯èˆ‡æºé€šå“è³ªï¼‰
- æ¥­åŠ›èˆ‡å¼µåŠ›æŒ‡æ•¸ï¼š{round(tension)} / 100ï¼ˆåˆ†æ•¸è¶Šé«˜ï¼Œä»£è¡¨è‡´å‘½å¸å¼•åŠ›è¶Šå¼·ï¼Œä½†ä¹Ÿè¶Šå®¹æ˜“ç›¸æ„›ç›¸æ®ºï¼‰
- é—œä¿‚å››è±¡é™è½é»ï¼š{quadrant}
- é«˜å£“è­¦å‘Šï¼š{high_voltage}
- é—œä¿‚ç‰¹æ®Šå¾½ç« ï¼š{', '.join(badges) if badges else 'ç„¡'}

ã€å¿ƒç†å‹•åŠ›å­¸æ¨™ç±¤ï¼ˆè«‹è½‰è­¯ç‚ºç™½è©±æƒ…å¢ƒï¼Œç¦æ­¢ç›´æ¥è¼¸å‡ºåŸå§‹æ¨™ç±¤ï¼‰ã€‘
{psych_section}
{profile_block}
ã€å¯«ä½œæŒ‡å—ã€‘ï¼š
1. å¦‚æœã€Œéˆé­‚ã€é«˜ä½†ã€Œç›¸è™•ã€ä½ï¼Œè«‹é»å‡ºé€™æ˜¯ä¸€æ®µã€Œæ·±åˆ»ä½†éœ€è¦ç£¨åˆã€çš„é—œä¿‚ã€‚
2. å¦‚æœã€Œå¼µåŠ›æŒ‡æ•¸ã€å¤§æ–¼ 60ï¼Œè«‹å‹™å¿…è­¦å‘Šä»–å€‘é€™æ®µé—œä¿‚å¸¶æœ‰å¼·çƒˆçš„æ¥­åŠ›æˆ–è‡´å‘½å¸å¼•åŠ›ï¼Œä¸è¦ç”¨å¹³æ·¡çš„èªæ°£ã€‚
3. å¦‚æœæœ‰ç‰¹æ®Šå¾½ç« ï¼ˆå¦‚ï¼šå®Œç¾äº’è£œã€é‡‘ç«äº’æº¶ï¼‰ï¼Œè«‹ç”¨æµªæ¼«ä½†æ·±åˆ»çš„èªæ°£è§£é‡‹é€™å€‹å¾½ç« çš„æ„ç¾©ã€‚
4. ä¸è¦å‡ºç¾ä»»ä½•å æ˜Ÿæˆ–å…«å­—å°ˆæœ‰åè©ï¼Œè«‹è½‰åŒ–ç‚ºå¿ƒç†å­¸èˆ‡æ„Ÿæƒ…è¦–è§’çš„ç™½è©±æ–‡ã€‚
5. æ§åˆ¶åœ¨ 150 å­—ä»¥å…§ï¼Œèªæ°£åƒä¸€å€‹æ¥µåº¦æ‡‚ä»–å€‘çš„çŸ¥å·±ã€‚
6. ç›´æ¥å›å‚³ç´”æ–‡å­—ï¼Œä¸è¦ç”¨ JSON æˆ– markdown æ ¼å¼ã€‚"""

    return prompt
